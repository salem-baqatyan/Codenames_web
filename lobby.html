<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codenames Pro - Lobby</title>
    <style>
        /* <!-- CSS Section --> */

        /* --- Global & Root --- */
        :root {
            --bg-dark: #000000; --panel-bg: #1a1a1a; --blue-team: #3498db; --red-team: #e74c3c;
            --green-action: #4caf50; --text-gray: #aaaaaa; --modal-bg: #2a2a2a; --mobile-max-width: 450px;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { 
            margin: 0; background-color: var(--bg-dark); color: white; 
            display: flex; justify-content: center; align-items: center; height: 100dvh; overflow: hidden; 
        }

        /* --- Loading Screen Styles --- */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #7ed321; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- App Wrapper --- */
        .mobile-wrapper {
            width: 100%; max-width: var(--mobile-max-width); height: 100dvh; background: #000;
            display: flex; flex-direction: column; border-left: 1px solid #333; border-right: 1px solid #333;
            position: relative; overflow: hidden;
        }

        /* --- Profile & Timer Modals --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .settings-modal {
            width: 90%; max-height: 85%; background: var(--modal-bg); border-radius: 20px; 
            padding: 20px; border: 1px solid #444; position: relative;
        }
        #avatarContainer { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px; padding: 5px; justify-items: center; }
        .avatar-selector { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; }
        .avatar-option { width: 60px; height: 60px; border-radius: 50%; border: 1.5px solid var(--text-gray); cursor: pointer; transition: 0.2s; }
        .avatar-option.selected { border: 3px solid #7ed321; transform: scale(1.1); }
        .nickname-input { width: 100%; background: #1a1a1a; border: 1px solid #444; color: white; padding: 12px; border-radius: 10px; font-size: 1rem; margin-top: 10px; outline: none; }
        .save-btn { width: 100%; background: var(--green-action); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1.1rem; }
        .leave-btn { width: 100%; background: #c0392b; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 0.9rem; }
        .slider-labels { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.6rem; color: #888; }
        .active-label { color: #7ed321; font-weight: bold; }

        /* --- Top Section --- */
        .top-section { height: 48%; display: flex; flex-direction: column; padding-bottom: 5px; }

        /* --- App Bar --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; flex-shrink: 0; user-select: none; -webkit-user-select: none; }
        .top-left, .top-right { display: flex; gap: 8px; align-items: center; }
        .top-timer { 
            color: white; font-size: 1.5rem; font-weight: 900; font-family: 'Courier New', Courier, monospace; 
            position: absolute; left: 50%; transform: translateX(-50%); text-shadow: 0 0 10px rgba(255, 0, 0, 0.3); 
        }
        .icon-circle { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 0.5px solid white; cursor: pointer; color: white; }
        .btn-pill { background: rgba(255,255,255,0.1); border: 1px solid #444; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; cursor: pointer; color: white; }

        /* --- Spectators Section --- */
        .spectators-section { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 0 15px; flex-shrink: 0; }
        .spectators-list { display: flex; gap: 10px; justify-content: center; align-items: center; min-height: 65px; flex-wrap: wrap; }

        /* --- Settings Panel --- */
        .settings-panel { background: #1a1a1a; margin: 5px 15px; border-radius: 15px; padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .panel-label { text-align: center; color: #888; font-size: 0.65rem; font-weight: bold; margin-bottom: 10px; }
        
        /* --- Settings Panel --- */
        .settings-panel { 
            background: #1a1a1a; margin: 5px 15px; border-radius: 15px; padding: 10px; flex: 1; 
            display: flex; flex-direction: column; justify-content: center; border: 1px solid #333; 
        }
        .panel-label { text-align: center; color: var(--text-gray); font-size: 0.7rem; font-weight: bold; margin-bottom: 10px; }
        .mode-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mode-card { 
            border-radius: 12px; padding: 8px; display: flex; align-items: center; gap: 8px; 
            border: 1px solid #444; cursor: pointer; transition: all 0.3s ease; 
        }
        .mode-card.active { border-color: var(--green-action); background: rgba(126, 211, 33, 0.1); box-shadow: 0 0 15px rgba(126, 211, 33, 0.2); }
        .mode-card.active .mode-info b { color: var(--green-action); }
        .mode-img { width: 32px; height: 42px; border-radius: 6px; pointer-events: none; filter: grayscale(0.4); transition: 0.3s; }
        .mode-card.active .mode-img { filter: grayscale(0); border: 1px solid rgba(126, 211, 33, 0.5); }
        .mode-info b { font-size: 0.75rem; display: block; color: #eee; transition: 0.3s; }
        .mode-info span { font-size: 0.6rem; color: #666; }
        .setting-row { 
            border-radius: 10px; margin-top: 10px; display: flex; align-items: center; 
            padding: 8px 12px; border: 1px solid #333; cursor: pointer; transition: 0.2s; 
        }
        .setting-row:active { transform: scale(0.98); background: rgba(255,255,255,0.02); }
        
        /* --- Bottom Section --- */
        .bottom-section { height: 52%; display: flex; flex-direction: column; border-top: 1px solid #222; overflow: hidden; }

        /* --- Teams Grid --- */
        .teams-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 6px; padding: 10px; min-height: 0; }
        .team-box { border-radius: 15px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 4px; border: 1.5px solid rgba(255, 255, 255, 0.3); }
        .blue-box { background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%); }
        .red-box { background: linear-gradient(135deg, #7b241c 0%, #e74c3c 100%); }
        .box-title { font-size: 0.6rem; font-weight: 800; color: white; letter-spacing: 1px; }
        .player-slot-container { min-height: 55px; display: flex; align-items: center; justify-content: center; }
        .join-btn { width: 85%; padding: 4px 0; font-size: 0.65rem; font-weight: bold; color: white; background: linear-gradient(to bottom, #7ed321, #417505); border: 1.5px solid #b8e986; border-radius: 15px; cursor: pointer; box-shadow: 0 2px 0 #2e5a03; user-select: none; }
        .join-btn.locked { background: transparent !important; border: 1.5px solid #fff !important; box-shadow: none !important; cursor: not-allowed; opacity: 0.7; }
/* Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø£Ø¨ ÙŠØ­Ù…Ù„ ÙƒÙ„Ø§Ø³ co-op-active */
.teams-grid.co-op-active {
    grid-template-rows: 1fr; /* Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· */
}

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ Ù†Ø­ØªØ§Ø¬Ù‡Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø§ÙˆÙ† */
.teams-grid.co-op-active .blue-box:nth-child(3), 
.teams-grid.co-op-active .red-box:nth-child(4) {
    display: none;
}

        /* --- Footer --- */
        .footer { background: #000; height: 70px; padding: 10px; display: flex; align-items: center; flex-shrink: 0; }
        .start-btn { width: 100%; height: 45px; font-size: 1.1rem; font-weight: 900; color: white; background: linear-gradient(to bottom, #7ed321, #417505); border: 2px solid #b8e986; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 0 #2e5a03; display: none; }
        
        /* --- Players List Modal & Mini Cards --- */
        #playersListModal {
            position: absolute; top: 60px; right: 15px; left: auto; width: 280px; height: auto;
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px; padding: 12px; z-index: 1100; display: none; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform-origin: top right; animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .players-modal-title { font-size: 0.7rem; font-weight: bold; color: #fff; text-align: right; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .horizontal-players-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 5px 2px 10px 2px; scrollbar-width: none; }
        .player-card-mini { display: flex; flex-direction: column; align-items: center; min-width: 50px; position: relative; user-select: none; }
        .player-avatar-mini-wrap { position: relative; width: 44px; height: 44px; }

        .is-admin-mini::after { content: "ğŸ‘‘"; position: absolute; top: -10px; left: -5px; font-size: 1.1rem; transform: rotate(-20deg); z-index: 10; }
        .avatar-frame { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 2px; border: 2px solid #fff; background: #333; overflow: hidden; }
        .mini-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .mini-name-tag { margin-top: -6px; font-size: 0.55rem; padding: 1px 7px; border-radius: 5px; color: white; background: rgba(0,0,0,0.8); z-index: 5; white-space: nowrap; border: 1px solid transparent; }

        .player-blue .avatar-frame { background: #1e3a5f !important; }
        .player-red .avatar-frame { background: #7b241c !important; }
        .player-spec .avatar-frame { border-color: rgba(255,255,255,0.4) !important; background: #222 !important; }
        .is-me-mini .mini-name-tag { border: 1.5px solid #7ed321 !important; box-shadow: 0 0 5px rgba(126, 211, 33, 0.5); }
        
        /* --- Rules Modal --- */
        #rulesModal .settings-modal { max-height: 80vh; display: flex; flex-direction: column; padding: 20px 15px 15px 15px; width: 90%; position: relative; }
        #rulesAccordion { flex: 1; overflow-y: auto; padding-left: 5px; margin-bottom: 10px; }
        #rulesAccordion::-webkit-scrollbar { width: 4px; }
        #rulesAccordion::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        .rules-intro { font-size: 0.75rem; text-align: center; color: #ccc; margin-bottom: 15px; line-height: 1.4; flex-shrink: 0; }
        .accordion-item { margin-bottom: 8px; border-radius: 12px; overflow: hidden; flex-shrink: 0; }
        .accordion-header { background: var(--accordion-bg, #252525); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.3s; font-weight: bold; font-size: 0.85rem; }
        .accordion-header:hover { background: #333; }
        .accordion-header.active { background: var(--green-action); color: white; }
        .accordion-content { background: #1e1e1e; display: none; padding: 15px; font-size: 0.75rem; line-height: 1.6; color: #ddd; border: 1px solid #333; border-top: none; border-radius: 0 0 12px 12px; }
        .accordion-content ul { padding-right: 20px; margin: 0; }
        .accordion-content li { margin-bottom: 8px; }
        .accordion-header span:last-child { transition: transform 0.3s; }
        .accordion-header.active span:last-child { transform: rotate(180deg); }
        .close-icon { position: absolute; top: 15px; left: 15px; font-size: 1.2rem; cursor: pointer; color: #888; z-index: 10; }
        .modal-header { flex-shrink: 0; margin-bottom: 10px; text-align: center; }
        .close-modal-btn { width: 100%; background: #444; color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; flex-shrink: 0; }

        /* --- Game Log Styles --- */
        .log-row { display: flex; width: 100%; align-items: center; gap: 5px; margin-top: 10px; }
        .row-red { justify-content: flex-start; flex-direction: row; } 
        .log-clue-item { display: flex; align-items: center; gap: 4px; border-radius: 5px; padding: 2px 4px; border: 1px solid rgba(255,255,255,0.2); width: 100%; }
        .log-clue-red { background: #e74c3c; }
        .log-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid; }
        .log-text-clue { font-weight: bold; color: black; background: white; border-radius: 3px; padding: 1px 4px; width: 100%; text-align: center; font-size: 1rem; }
        .log-num-circle { width: 30px; height: 30px; background: white; border-radius: 50%; color: black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; flex-shrink: 0; }
    </style>
</head>

<body>
<!-- HTML Section -->

<!-- loadingScreen -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <p style="margin-top: 15px; font-size: 0.9rem; color: #888;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
</div>

 <!-- App Wrapper -->
<div class="mobile-wrapper">

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal" style="display:flex;">
        <div class="settings-modal">
            <div class="modal-header" id="profileHeader" style="font-weight:bold;margin-bottom:10px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø¬Ù‡Ø² Ù…Ù„ÙÙƒ</div>
            <div class="avatar-selector" id="avatarContainer"></div>
            <input type="text" id="nicknameInput" class="nickname-input" placeholder="Ø§ÙƒØªØ¨ Ù„Ù‚Ø¨Ùƒ Ù‡Ù†Ø§..." maxlength="12">
            <button class="save-btn" onclick="saveProfile()">Ø­ÙØ¸ ÙˆØ§Ù†Ø¶Ù…Ø§Ù…</button>
            <button id="leaveRoomBtn" class="leave-btn" style="display:none;" onclick="leaveLobby()">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±Ø¯Ù‡Ø© ğŸšª</button>
        </div>
    </div>

    <!-- Timer Modal -->
    <div class="modal-overlay" id="timerModal">
        <div class="settings-modal">
            <div class="modal-header">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚Øª</div>
            <div id="modalTimerIcon" style="text-align:center;font-size:3rem;margin:10px 0;">ğŸš«</div>
            <div id="modalTimerText" style="text-align:center;font-weight:bold;">Ø¨Ø¯ÙˆÙ† Ù…Ø¤Ù‚Øª</div>
            <input type="range" min="0" max="3" value="0" id="timerSlider" style="width:100%;margin-top:20px;" oninput="changeTimer(this.value)">
            <div class="slider-labels">
                <span id="label0" class="active-label">Ø¨Ø¯ÙˆÙ†</span>
                <span id="label1">30Ø«</span>
                <span id="label2">1Ø¯</span>
                <span id="label3">2Ø¯</span>
            </div>
            <button class="save-btn" style="background:#444;" onclick="document.getElementById('timerModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Top Section -->
    <div class="top-section">

        <!-- App Bar -->
        <div class="top-bar">
            <div class="top-left">
                <div class="icon-circle" onclick="openPlayersModal()">
                    <span id="playerCount" style="font-size:0.8rem;font-weight:bold;margin-left:2px;">0</span> ğŸ‘¤
                </div> 
                <div class="btn-pill" id="roomDisplay" onclick="copyRoomLink()">ğŸ”— Ø§Ù„ØºØ±ÙØ©</div>
            </div>
            <div class="top-timer" id="lobbyDisplayTimer"></div>
            <div class="top-right">
                <div class="btn-pill" onclick="toggleRulesModal(true)">ğŸ“œØ§Ù„Ù‚ÙˆØ§Ø¹Ø¯</div>
                <div class="icon-circle" onclick="openProfileSettings()">âš™ï¸</div>
            </div>
        </div>

        <!-- Spectators Section -->
        <div class="spectators-section">
            <div class="box-title">Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</div>
            <div class="spectators-list" id="spectators-list"></div>
            <button class="join-btn" style="width:100px;margin-top:5px;background:none;border:1px solid #fff;" onclick="joinTeam('spectators-list')">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <div class="panel-label">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„Ù„Ø¢Ø¯Ù…Ù† ÙÙ‚Ø·)</div>
            <div class="mode-options">
                <div class="mode-card" id="mode-Co_Op" onclick="setGameMode('Co_Op')">
                    <img src="img/Co_Op.png" class="mode-img">
                    <div class="mode-info"><b>ØªØ¹Ø§ÙˆÙ†ÙŠØ©</b><span>2+ Ù„Ø§Ø¹Ø¨ÙŠÙ†</span></div>
                </div>
                <div class="mode-card active" id="mode-PvP" onclick="setGameMode('PvP')">
                    <img src="img/PvP.png" class="mode-img">
                    <div class="mode-info"><b>ØªÙ†Ø§ÙØ³ÙŠØ©</b><span>4+ Ù„Ø§Ø¹Ø¨ÙŠÙ†</span></div>
                </div>
            </div>
            <div class="setting-row" onclick="openTimerModal()">
                <span id="mainTimerIcon" style="font-size:1.2rem;">ğŸš«</span>
                <div style="margin-right:10px;">
                    <b style="font-size:0.7rem;display:block;">Ø§Ù„Ù…Ø¤Ù‚Øª</b>
                    <span id="mainTimerText" style="font-size:0.55rem;color:#888;">Ø¨Ø¯ÙˆÙ†</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Bottom Section -->
    <div class="bottom-section">

        <!-- Teams Grid -->
        <div class="teams-grid">
            <div class="team-box blue-box">
                <div class="box-title">OPERATIVE</div>
                <div class="player-slot-container" id="blue-operative"></div>
                <button class="join-btn" id="btn-blue-operative" onclick="joinTeam('blue-operative')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box red-box">
                <div class="box-title">OPERATIVE</div>
                <div class="player-slot-container" id="red-operative"></div>
                <button class="join-btn" id="btn-red-operative" onclick="joinTeam('red-operative')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box blue-box">
                <div class="box-title">SPYMASTER</div>
                <div class="player-slot-container" id="blue-spymaster"></div>
                <button class="join-btn" id="btn-blue-spymaster" onclick="joinTeam('blue-spymaster')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box red-box">
                <div class="box-title">SPYMASTER</div>
                <div class="player-slot-container" id="red-spymaster"></div>
                <button class="join-btn" id="btn-red-spymaster" onclick="joinTeam('red-spymaster')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <button class="start-btn" id="startBtn" onclick="handleStartGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>
        <!-- Players List Modal -->
        <div id="playersListModal">
            <div class="players-modal-title">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
            <div class="horizontal-players-scroll" id="playersListContainer"> </div>
        </div>

    </div>

</div>
<script src="words.js"></script>
<script type="module">
// <!-- JS Section -->

/* ---------- 1. Setup & Config ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue, onDisconnect, update, runTransaction, remove, get } 
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyC95r_D7FVO-cynZ-gK6zbldvvrY4HD2YQ",
    authDomain: "codenames-5fd71.firebaseapp.com",
    projectId: "codenames-5fd71",
    databaseURL: "https://codenames-5fd71-default-rtdb.firebaseio.com",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let urlParams = new URLSearchParams(window.location.search);
let roomId = urlParams.get('r');

if (!roomId) {
    roomId = Math.random().toString(36).substring(2, 8);
    window.location.href = window.location.pathname + '?r=' + roomId;
}

let playerId = localStorage.getItem('codenames_playerId');
if (!playerId) {
    playerId = Math.random().toString(36).substring(2, 6);
    localStorage.setItem('codenames_playerId', playerId);
}
sessionStorage.setItem('playerId', playerId);

const roomRef = ref(db, `rooms/${roomId}`);
const playersRef = ref(db, `rooms/${roomId}/players`);
const myPlayerRef = ref(db, `rooms/${roomId}/players/${playerId}`);
const settingsRef = ref(db, `rooms/${roomId}/settings`);
const statusRef = ref(db, `rooms/${roomId}/status`);
const globalPlayersRef = ref(db, `global_players/${playerId}`);


/* ---------- 2. State & Assets ---------- */
let myData = {
    id: playerId,
    name: "",
    avatar: "img/avatar/snowman.webp",
    team: "spectators-list",
    joinedAt: Date.now()
};

let isAdmin = false;
let hasJoined = false;

const avatarImages = [
    "img/avatar/snowman.webp", "img/avatar/confused_woman.webp", "img/avatar/cool_girl.webp",
    "img/avatar/delivery_boy.webp", "img/avatar/laughing.webp", "img/avatar/old_man.webp",
    "img/avatar/photographer.webp", "img/avatar/pizza_guy.webp", "img/avatar/reader.webp",
    "img/avatar/surprised_man.webp",
];

const cardVisuals = {
    blue: ['img/card/Blue1.webp', 'img/card/Blue2.webp'],
    red: ['img/card/Red1.webp', 'img/card/Red2.webp'],
    killer: ['img/card/Black.webp'],
    neutral: ['img/card/Normal1.webp', 'img/card/Normal2.webp']
};

let shuffledPools = { blue: [], red: [], killer: [], neutral: [] };
let lastUsedImages = { blue: null, red: null, killer: null, neutral: null };


/* ---------- 3. Profile Management ---------- */
async function renderAvatars() {
    const container = document.getElementById('avatarContainer');
    if (!container) return;
    container.innerHTML = '<div style="grid-column: span 5; font-size:0.7rem; color:#888;"></div>';
    await preloadImages();
    container.innerHTML = '';

    avatarImages.forEach((src, index) => {
        const img = document.createElement('img');
        img.src = src;
        img.className = 'avatar-option';
        if (myData.avatar === src || (index === 0 && !myData.avatar)) img.classList.add('selected');
        img.onclick = () => {
            document.querySelectorAll('.avatar-option').forEach(i => i.classList.remove('selected'));
            img.classList.add('selected');
            myData.avatar = src;
        };
        container.appendChild(img);
    });
}


document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('profileModal').style.display = 'none';
    
    await renderAvatars(); 

    const [globalSnap, roomSnap] = await Promise.all([
        get(globalPlayersRef),
        get(roomRef)
    ]);

    const isGameStarted = roomSnap.exists() && roomSnap.val().status === "started";

    if (globalSnap.exists()) {
        const savedData = globalSnap.val();
        myData.name = savedData.name;
        myData.avatar = savedData.avatar;
        
        if (isGameStarted) {
            myData.team = "spectators-list";
            await autoJoinRoom(); 
        } else {
            await autoJoinRoom(); 
            hideLoading();
        }
    } else {
        document.getElementById('profileModal').style.display = 'flex';
        hideLoading();
        setTimeout(() => document.getElementById('nicknameInput').focus(), 100);
    }
});

function hideLoading() {
    const loader = document.getElementById('loadingScreen');
    loader.style.opacity = '0';
    loader.style.transition = 'opacity 0.4s ease';
    setTimeout(() => loader.style.display = 'none', 400);
}

async function autoJoinRoom() {
    hasJoined = true;
    const now = Date.now();
    
    const roomSnap = await get(roomRef);
    if (!roomSnap.exists()) {
        const typeParam = urlParams.get('type') || 'public';
        await set(roomRef, { 
            lastActivity: now, 
            status: "lobby", 
            settings: { mode: 'PvP', timer: 0, visibility: typeParam } 
        });
    } else {
        updateRoomActivity();
    }
    
    await update(myPlayerRef, { ...myData, lastActive: now, joinedAt: now });
    startHeartbeat();
}

window.saveProfile = async () => {
    const name = document.getElementById('nicknameInput').value.trim();
    if (!name) return showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ");
    
    myData.name = name;
    hasJoined = true;
    
    const roomSnap = await get(roomRef);
    if (roomSnap.exists() && roomSnap.val().status === "started") {
        myData.team = "spectators-list";
    }

    document.getElementById('profileModal').style.display = 'none';
    const now = Date.now();
    
    await set(ref(db, `global_players/${playerId}`), {
        id: playerId, name: myData.name, avatar: myData.avatar
    });

    await autoJoinRoom();
};

window.openProfileSettings = () => {
    document.getElementById('profileHeader').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ";
    const input = document.getElementById('nicknameInput');
    input.value = myData.name;
    document.getElementById('leaveRoomBtn').style.display = 'block';
    document.getElementById('profileModal').style.display = 'flex';
    setTimeout(() => input.focus(), 50);
};

window.leaveLobby = () => {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ")) {
        remove(myPlayerRef).then(() => location.href = 'index.html');
    }
};


/* ---------- 4. Utility Helpers ---------- */
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function areImagesCached() {
    for (let src of avatarImages) {
        const img = new Image();
        img.src = src;
        if (!img.complete) return false;
    }
    return true;
}

function preloadImages() {
    const promises = avatarImages.map(src => {
        return new Promise(resolve => {
            const img = new Image(); img.src = src;
            img.onload = resolve; img.onerror = resolve;
        });
    });
    return Promise.all(promises);
}

function getNextImageFromPool(type) {
    if (shuffledPools[type].length === 0) {
        let newPool = [...cardVisuals[type]];
        shuffleArray(newPool);
        if (newPool.length > 1 && newPool[newPool.length - 1] === lastUsedImages[type]) {
            [newPool[newPool.length - 1], newPool[0]] = [newPool[0], newPool[newPool.length - 1]];
        }
        shuffledPools[type] = newPool;
    }
    const img = shuffledPools[type].pop();
    lastUsedImages[type] = img;
    return img;
}

window.copyRoomLink = () => {
    navigator.clipboard.writeText(window.location.href);
    showToast("âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©!");
};

function showToast(message) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.cssText = `position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(10px); background: rgba(20, 20, 20, 0.95); color: #ddd; padding: 10px 18px; border-radius: 14px; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(52, 152, 219, 0.6); box-shadow: 0 8px 20px rgba(0,0,0,.6); opacity: 0; transition: all .25s ease; z-index: 9999; pointer-events: none; backdrop-filter: blur(6px);`;
    document.body.appendChild(toast);
    requestAnimationFrame(() => { toast.style.opacity = "1"; toast.style.transform = "translateX(-50%) translateY(0)"; });
    setTimeout(() => { toast.style.opacity = "0"; toast.style.transform = "translateX(-50%) translateY(10px)"; setTimeout(() => toast.remove(), 250); }, 2500);
}

function updateRoomActivity() { update(roomRef, { lastActivity: Date.now() }); }

function updateServer() {
    if (!hasJoined) return;
    set(myPlayerRef, { ...myData, lastActive: Date.now() });
    update(globalPlayersRef, { name: myData.name, avatar: myData.avatar });
    updateRoomActivity();
}

async function vacuumCleaner() {
    const allRoomsRef = ref(db, `rooms`);
    get(roomRef).then(snap => {
        if (!snap.exists()) {
            const typeParam = urlParams.get('type') || 'public';
            update(roomRef, { "settings/visibility": typeParam });
        }
    });
    try {
        const snapshot = await get(allRoomsRef);
        if (!snapshot.exists()) return;
        const now = Date.now();
        const TEN_MINUTES = 10 * 60 * 1000;
        const rooms = snapshot.val();
        for (const id in rooms) {
            const room = rooms[id];
            if (!room.lastActivity || (now - room.lastActivity > TEN_MINUTES)) {
                await remove(ref(db, `rooms/${id}`));
            }
        }
    } catch (e) { console.error("Vacuum failed:", e); }
}

function startHeartbeat() {
    setInterval(() => { if (hasJoined && isAdmin) updateRoomActivity(); }, 300000);
}


/* ---------- 5. Lobby & Team Logic ---------- */
document.getElementById('roomDisplay').innerText = "ğŸ”— " + roomId;

window.toggleRulesModal = (show) => { document.getElementById('rulesModal').style.display = show ? 'flex' : 'none'; };

window.toggleAccordion = (header) => {
    const content = header.nextElementSibling;
    const isVisible = content.style.display === 'block';
    document.querySelectorAll('.accordion-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.accordion-header').forEach(h => h.classList.remove('active'));
    if (!isVisible) { content.style.display = 'block'; header.classList.add('active'); }
};

window.joinTeam = (teamId) => {
    if (!hasJoined) return;
    if (teamId === 'spectators-list') { myData.team = teamId; updateServer(); return; }
    runTransaction(playersRef, (players) => {
        if (players) {
            const isTaken = Object.values(players).some(p => p.team === teamId && p.id !== playerId);
            if (isTaken) return;
        }
        if (!players) players = {};
        if (!players[playerId]) players[playerId] = myData;
        players[playerId].team = teamId;
        myData.team = teamId;
        return players;
    });
};

function renderLobby(players, adminId) {
    const grid = document.querySelector('.teams-grid');
    const isCoOp = document.getElementById('mode-Co_Op').classList.contains('active');

    if (isCoOp) {
        grid.classList.add('co-op-active');
        // ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„Ù€ Side A Ùˆ Side B (Ø£Ùˆ RED Ùˆ BLUE ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)
        document.querySelectorAll('.blue-box .box-title')[0].innerText = "BLUE SIDE";
        document.querySelectorAll('.red-box .box-title')[0].innerText = "RED SIDE";
    } else {
        grid.classList.remove('co-op-active');
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø§ÙØ³
        document.querySelectorAll('.blue-box .box-title')[0].innerText = "OPERATIVE";
        document.querySelectorAll('.blue-box .box-title')[1].innerText = "SPYMASTER";
        document.querySelectorAll('.red-box .box-title')[0].innerText = "OPERATIVE";
        document.querySelectorAll('.red-box .box-title')[1].innerText = "SPYMASTER";
    }
    const containers = {
        'spectators-list': document.getElementById('spectators-list'),
        'blue-operative': document.getElementById('blue-operative'), 
        'blue-spymaster': document.getElementById('blue-spymaster'),
        'red-operative': document.getElementById('red-operative'), 
        'red-spymaster': document.getElementById('red-spymaster')
    };

    Object.values(containers).forEach(c => { if (c) c.innerHTML = ''; });

    document.querySelectorAll('.join-btn').forEach(b => {
        if (!b.onclick.toString().includes('spectators-list')) {
            b.innerText = "Ø§Ù†Ø¶Ù…Ø§Ù…";
            b.className = "join-btn";
            b.disabled = false;
        }
    });

    Object.values(players).forEach(p => {
        const isMe = p.id === playerId;
        const isPlayerAdmin = p.id === adminId;

        let teamClass = 'player-spec';
        if (p.team.includes('blue')) teamClass = 'player-blue';
        else if (p.team.includes('red')) teamClass = 'player-red';

        const html = `
            <div class="player-card-mini ${teamClass} ${isMe ? 'is-me-mini' : ''}">
                <div class="player-avatar-mini-wrap ${isPlayerAdmin ? 'is-admin-mini' : ''}">
                    <div class="avatar-frame">
                        <img src="${p.avatar}" class="mini-img">
                    </div>
                </div>
                <div class="mini-name-tag">
                    ${p.name} ${isMe ? '(Ø£Ù†Øª)' : ''}
                </div>
            </div>
        `;

        const target = containers[p.team];
        if (target) {
            target.insertAdjacentHTML('beforeend', html);
            if (p.team !== 'spectators-list') {
                const btn = document.getElementById('btn-' + p.team);
                if (btn) { 
                    btn.innerText = "Ù…Ù†Ø¶Ù…"; 
                    btn.classList.add('locked'); 
                    btn.disabled = true; 
                }
            }
        }
    });
}

window.openPlayersModal = async () => {
    const modal = document.getElementById('playersListModal');
    if (modal.style.display === 'flex') { modal.style.display = 'none'; return; }
    const playersSnap = await get(playersRef);
    if (!playersSnap.exists()) return;
    const playerList = Object.values(playersSnap.val());
    const adminId = [...playerList].sort((a, b) => a.joinedAt - b.joinedAt)[0]?.id;
    const teamOrder = ['blue-spymaster', 'blue-operative', 'red-spymaster', 'red-operative', 'spectators-list'];
    const sortedPlayers = playerList.sort((a, b) => teamOrder.indexOf(a.team) - teamOrder.indexOf(b.team));
    const container = document.getElementById('playersListContainer');
    container.innerHTML = '';
    sortedPlayers.forEach(p => {
        let teamClass = p.team.includes('blue') ? 'player-blue' : (p.team.includes('red') ? 'player-red' : 'player-spec');
        const isMe = (p.id === playerId), isPlayerAdmin = (p.id === adminId);
        container.insertAdjacentHTML('beforeend', `
            <div class="player-card-mini ${teamClass} ${isMe ? 'is-me-mini' : ''}">
                <div class="player-avatar-mini-wrap ${isPlayerAdmin ? 'is-admin-mini' : ''}">
                    <div class="avatar-frame"><img src="${p.avatar}" class="mini-img"></div>
                </div>
                <div class="mini-name-tag">${p.name} ${isMe ? '(Ø£Ù†Øª)' : ''}</div>
            </div>`);
    });
    modal.style.display = 'flex';
    modal.onclick = (e) => e.stopPropagation();
};

document.addEventListener('click', (e) => {
    const modal = document.getElementById('playersListModal');
    const playerCountBtn = document.getElementById('playerCount')?.parentElement;
    if (modal && modal.style.display === 'flex' && !modal.contains(e.target) && !playerCountBtn?.contains(e.target)) {
        modal.style.display = 'none';
    }
});

onValue(playersRef, (snapshot) => {
    const players = snapshot.val();
    if (!players) return;
    const playerList = Object.values(players);
    document.getElementById('playerCount').innerText = playerList.length;
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¢Ø¯Ù…Ù† (Ø£ÙˆÙ„ Ù…Ù† Ø¯Ø®Ù„)
    const sorted = playerList.sort((a, b) => a.joinedAt - b.joinedAt);
    const adminId = sorted[0].id;
    
    isAdmin = (playerId === adminId); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    document.getElementById('startBtn').style.display = isAdmin ? 'block' : 'none';
    
    // ØªØ£ÙƒØ¯ Ø£Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ³ØªØ¬ÙŠØ¨ Ù„Ù„Ù†Ù‚Ø±Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø¯Ù…Ù†
    const settingsPanel = document.querySelector('.settings-panel');
    if (settingsPanel) {
        settingsPanel.style.opacity = isAdmin ? "1" : "0.5";
        settingsPanel.style.pointerEvents = isAdmin ? "auto" : "none"; // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ù„ØºÙŠØ± Ø§Ù„Ø¢Ø¯Ù…Ù†
    }
    
    renderLobby(players, adminId);
});


/* ---------- 6. Admin & Game Settings ---------- */
window.setGameMode = (mode) => { 
    if (!isAdmin) {
        showToast("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø¢Ø¯Ù…Ù† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¯");
        return; 
    }
    
    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    update(settingsRef, { mode: mode });

    // 2. Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±
    // Ù†Ø³ØªØ®Ø¯Ù… transaction Ø¹Ù„Ù‰ Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù…ÙŠØ¹
    runTransaction(playersRef, (players) => {
        if (players) {
            Object.keys(players).forEach(id => {
                players[id].team = 'spectators-list'; // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙØ±ÙŠÙ‚ ÙƒØ¬Ù…Ù‡ÙˆØ± Ù„Ù„ÙƒÙ„
            });
        }
        return players;
    }).then(() => {
        updateRoomActivity();
    }).catch(err => {
        console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù†Ù‚Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:", err);
    });
};
window.openTimerModal = () => { if (isAdmin) document.getElementById('timerModal').style.display = 'flex'; };
window.changeTimer = (val) => {
    if (!isAdmin) return;
    const secondsMap = [0, 30, 60, 120];
    update(settingsRef, { timer: secondsMap[val] });
    updateRoomActivity();
};

let lastMode = null; 

onValue(settingsRef, (snapshot) => {
    const s = snapshot.val();
    if (!s || !s.mode) return;

    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
    if (lastMode !== null && s.mode !== lastMode) {
        const modeName = s.mode === 'Co_Op' ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ';
        showToast(`ğŸ”„ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø· Ø¥Ù„Ù‰: ${modeName}`);
    }

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¨ØµØ±ÙŠ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Active State)
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
    const activeCard = document.getElementById('mode-' + s.mode);
    if (activeCard) activeCard.classList.add('active');

    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„Ù„ÙˆØ¨ÙŠ ÙÙˆØ±Ø§Ù‹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    renderLobbyHeaders(s.mode);

    // 4. ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ù‚Øª Ø§Ù„ÙˆÙ‚Øª (Timer)
    const seconds = s.timer || 0;
    const displayTimer = document.getElementById('lobbyDisplayTimer');
    let label = "Ø¨Ø¯ÙˆÙ†", icon = "ğŸš«", displayStr = "";
    
    if (seconds > 0) {
        icon = seconds === 30 ? "âš¡" : (seconds === 60 ? "â±ï¸" : "ğŸ¢");
        label = seconds < 60 ? `${seconds} Ø«Ø§Ù†ÙŠØ©` : `${seconds / 60} Ø¯Ù‚ÙŠÙ‚Ø©`;
        displayStr = seconds === 30 ? "00:30" : (seconds === 60 ? "01:00" : "02:00");
        if(displayTimer) displayTimer.style.display = 'block';
    } else { 
        if(displayTimer) displayTimer.style.display = 'none'; 
    }

    document.getElementById('mainTimerText').innerText = label;
    document.getElementById('mainTimerIcon').innerText = icon;
    document.getElementById('modalTimerText').innerText = label;
    document.getElementById('modalTimerIcon').innerText = icon;
    if(displayTimer) displayTimer.innerText = displayStr;

    // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    const timerSlider = document.getElementById('timerSlider');
    const valMap = { 0: 0, 30: 1, 60: 2, 120: 3 };
    if(timerSlider) timerSlider.value = valMap[seconds] || 0;

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©
    lastMode = s.mode;
});

function renderLobbyHeaders(mode) {
    const grid = document.querySelector('.teams-grid');
    if (!grid) return;

    const isCoOp = (mode === 'Co_Op');
    const blueTitles = document.querySelectorAll('.blue-box .box-title');
    const redTitles = document.querySelectorAll('.red-box .box-title');

    if (isCoOp) {
        grid.classList.add('co-op-active');
        // ÙÙŠ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠØŒ Ù†Ø¸Ù‡Ø± ÙÙ‚Ø· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£ÙˆÙ„ Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚
        if(blueTitles[0]) blueTitles[0].innerText = "BLUE SIDE";
        if(redTitles[0]) redTitles[0].innerText = "RED SIDE";
    } else {
        grid.classList.remove('co-op-active');
        // ÙÙŠ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©
        if(blueTitles[0]) blueTitles[0].innerText = "OPERATIVE";
        if(blueTitles[1]) blueTitles[1].innerText = "SPYMASTER";
        if(redTitles[0]) redTitles[0].innerText = "OPERATIVE";
        if(redTitles[1]) redTitles[1].innerText = "SPYMASTER";
    }
}

/* ---------- 7. Game Engine & Start ---------- */
function generateBoard(startingTeam) {
    // Ù„Ù… Ù†Ø¹Ø¯ Ø¨Ø­Ø§Ø¬Ø© Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø·ÙˆÙŠÙ„Ø© Ù‡Ù†Ø§
    const shuffledWords = [...words]; 
    shuffleArray(shuffledWords);

    const redCount = (startingTeam === "red") ? 9 : 8;
    const blueCount = (startingTeam === "blue") ? 9 : 8;

    const types = [
        "killer", 
        ...Array(redCount).fill("red"), 
        ...Array(blueCount).fill("blue"), 
        ...Array(7).fill("neutral")
    ];

    shuffleArray(types);

    return types.map((type, i) => ({ 
        word: shuffledWords[i], 
        type, 
        revealed: false, 
        visual: getNextImageFromPool(type) 
    }));
}
function generateDuetBoard() {
    const shuffledWords = [...words]; 
    shuffleArray(shuffledWords);
    
    let cards = [];
    
    // 3 ÙƒÙ„Ù…Ø§Øª: (A Ø§Ø­Ù…Ø± B Ø§Ø²Ø±Ù‚)
    for(let i=0; i<3; i++) cards.push({ sideA: 'red', sideB: 'blue' });
    // 1 ÙƒÙ„Ù…Ø©: (Ø£Ø³ÙˆØ¯ Ù„Ù„Ø·Ø±ÙÙŠÙ†)
    cards.push({ sideA: 'killer', sideB: 'killer' });
    // 1 ÙƒÙ„Ù…Ø©: (Ø§Ø­Ù…Ø± Ù„Ù€ AØŒ Ø£Ø³ÙˆØ¯ Ù„Ù€ B)
    cards.push({ sideA: 'red', sideB: 'killer' });
    // 1 ÙƒÙ„Ù…Ø©: (Ø£Ø³ÙˆØ¯ Ù„Ù€ AØŒ Ø§Ø²Ø±Ù‚ Ù„Ù€ B)
    cards.push({ sideA: 'killer', sideB: 'blue' });
    // 5 ÙƒÙ„Ù…Ø§Øª: (Ø§Ø­Ù…Ø± Ù„Ù€ AØŒ Ø£Ø¨ÙŠØ¶ Ù„Ù€ B)
    for(let i=0; i<5; i++) cards.push({ sideA: 'red', sideB: 'neutral' });
    // 5 ÙƒÙ„Ù…Ø§Øª: (Ø£Ø¨ÙŠØ¶ Ù„Ù€ AØŒ Ø§Ø²Ø±Ù‚ Ù„Ù€ B)
    for(let i=0; i<5; i++) cards.push({ sideA: 'neutral', sideB: 'blue' });
    // Ø§Ù„Ø¨Ù‚ÙŠØ© (9 ÙƒÙ„Ù…Ø§Øª): (Ø£Ø¨ÙŠØ¶ Ù„Ù„Ø·Ø±ÙÙŠÙ†)
    while(cards.length < 25) cards.push({ sideA: 'neutral', sideB: 'neutral' });

    shuffleArray(cards);

    return cards.map((card, i) => ({
        word: shuffledWords[i],
        sideA: card.sideA,
        sideB: card.sideB,
        revealed: false,
        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ±Øª Ù„Ù€ SideA Ø£Ùˆ SideB Ø£Ùˆ Ù…Ø­Ø§ÙŠØ¯
        visual: getNextImageFromPool(card.sideA === 'red' ? 'red' : (card.sideB === 'blue' ? 'blue' : 'neutral'))
    }));
}

window.handleStartGame = async () => {
    if (!isAdmin) return;
    
    const settingsSnap = await get(settingsRef);
    const mode = settingsSnap.exists() ? settingsSnap.val().mode : 'PvP';
    
    const playersSnap = await get(playersRef);
    const players = playersSnap.val() || {};
    const playerList = Object.values(players);
    const activeTeams = playerList.map(p => p.team);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©
    if (mode === 'PvP') {
        const requiredRoles = ['blue-operative', 'blue-spymaster', 'red-operative', 'red-spymaster'];
        if (!requiredRoles.every(role => activeTeams.includes(role))) 
            return showToast("âš ï¸ ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ù„Ø§Ø¹Ø¨ ÙÙŠ ÙƒÙ„ Ø¯ÙˆØ± Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø§ÙØ³");
    } else {
        const hasBlue = activeTeams.includes('blue-operative');
        const hasRed = activeTeams.includes('red-operative');
        if (!hasBlue || !hasRed) 
            return showToast("âš ï¸ ÙŠØ¬Ø¨ ÙˆØ¬ÙˆØ¯ Ù„Ø§Ø¹Ø¨ ÙÙŠ ÙƒÙ„ Ø¬Ù‡Ø© (Ø£Ø­Ù…Ø± ÙˆØ£Ø²Ø±Ù‚)");
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ---
    const startingSide = Math.random() < 0.5 ? "red" : "blue";

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¯
    let boardData;
    let turnUpdate;

    if (mode === 'Co_Op') {
        boardData = generateDuetBoard();
        // ÙÙŠ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ Ø§Ù„Ù€ side Ø§Ù„Ù…Ø®ØªØ§Ø± ÙŠØ¨Ø¯Ø£ Ø¨Ø¥Ø¹Ø·Ø§Ø¡ Clue
        turnUpdate = { side: startingSide, phase: 'clue' };
    } else {
        // ÙÙŠ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ Ø§Ù„Ù€ team Ø§Ù„Ù…Ø®ØªØ§Ø± ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (9 Ø¶Ø¯ 8) ÙˆÙŠØ¨Ø¯Ø£ spymaster
        boardData = generateBoard(startingSide);
        turnUpdate = { team: startingSide, phase: "spymaster" };
    }

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await set(ref(db, `rooms/${roomId}/game`), {
        board: boardData,
        mode: mode,
        turn: turnUpdate
    });

    await update(roomRef, { status: "started" });
};

onValue(roomRef, (snap) => {
    const data = snap.val();
    if (data?.status === "started") {
        if (hasJoined) {
            const mode = data.settings?.mode || 'PvP';
            const targetPage = mode === 'Co_Op' ? 'game_Co_Op.html' : 'game_PvP.html';
            window.location.href = `${targetPage}?r=${roomId}&p=${playerId}`;
        }
    }
});


/* ---------- Final: Bootstrapping ---------- */
document.getElementById('nicknameInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') saveProfile(); });

vacuumCleaner();
</script>
</body>
</html>
