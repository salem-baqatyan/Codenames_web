<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codenames Pro - Lobby</title>
<style>
        /* 1. Global & Root Styles */
        :root {
            --bg-dark: #000000;
            --panel-bg: #1a1a1a;
            --blue-team: #3498db;
            --red-team: #e74c3c;
            --green-action: #4caf50;
            --text-gray: #aaaaaa;
            --modal-bg: #2a2a2a;
            --mobile-max-width: 450px;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { 
            margin: 0; 
            background-color: var(--bg-dark); 
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            height: 100dvh;
            overflow: hidden; 
        }

        /* 2. Main Wrapper */
        .mobile-wrapper {
            width: 100%; 
            max-width: var(--mobile-max-width);
            height: 100dvh; 
            background: #000;
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid #333; 
            border-right: 1px solid #333;
            position: relative;
            overflow: hidden;
        }

/* --- Ø³ØªØ§ÙŠÙ„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ù„ --- */
#rulesModal .settings-modal {
    max-height: 80vh; /* ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ø¥Ø·Ø§Ø± Ø¨Ù€ 80% Ù…Ù† Ø·ÙˆÙ„ Ø§Ù„Ø´Ø§Ø´Ø© */
    display: flex;
    flex-direction: column;
    padding: 20px 15px 15px 15px;
    width: 90%;
    position: relative;
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
#rulesAccordion {
    flex: 1; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
    overflow-y: auto; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
    padding-left: 5px; /* Ù…Ø³Ø§Ø­Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    margin-bottom: 10px;
}

/* ØªØ®ØµÙŠØµ Ø´ÙƒÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„ØªØµÙ…ÙŠÙ…) */
#rulesAccordion::-webkit-scrollbar {
    width: 4px;
}
#rulesAccordion::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 10px;
}

/* Ø¨Ù‚ÙŠØ© Ø§Ù„Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ */
.rules-intro { font-size: 0.75rem; text-align: center; color: #ccc; margin-bottom: 15px; line-height: 1.4; flex-shrink: 0; }
.accordion-item { margin-bottom: 8px; border-radius: 12px; overflow: hidden; flex-shrink: 0; }
.accordion-header {
    background: var(--accordion-bg, #252525); padding: 12px 15px; display: flex; justify-content: space-between;
    align-items: center; cursor: pointer; transition: 0.3s; font-weight: bold; font-size: 0.85rem;
}
.accordion-header:hover { background: #333; }
.accordion-header.active { background: var(--green-action); color: white; }
.accordion-content {
    background: #1e1e1e; display: none; padding: 15px; font-size: 0.75rem; line-height: 1.6; color: #ddd;
    border: 1px solid #333; border-top: none; border-radius: 0 0 12px 12px;
}
.accordion-content ul { padding-right: 20px; margin: 0; }
.accordion-content li { margin-bottom: 8px; }
.accordion-header span:last-child { transition: transform 0.3s; }
.accordion-header.active span:last-child { transform: rotate(180deg); }

.close-icon { position: absolute; top: 15px; left: 15px; font-size: 1.2rem; cursor: pointer; color: #888; z-index: 10; }
.modal-header { flex-shrink: 0; margin-bottom: 10px; text-align: center; }

.close-modal-btn { width: 100%; background: #444; color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; flex-shrink: 0; }

/* Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„Ù€ Log */
.log-row { display: flex; width: 100%; align-items: center; gap: 5px; margin-top: 10px; }
.row-red { justify-content: flex-start; flex-direction: row; } 
.log-clue-item { display: flex; align-items: center; gap: 4px; border-radius: 5px; padding: 2px 4px; border: 1px solid rgba(255,255,255,0.2); width: 100%; }
.log-clue-red { background: #e74c3c; }
.log-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid; }
.log-text-clue { font-weight: bold; color: black; background: white; border-radius: 3px; padding: 1px 4px; width: 100%; text-align: center; font-size: 1rem; }
.log-num-circle { width: 30px; height: 30px; background: white; border-radius: 50%; color: black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; flex-shrink: 0; } 
/* 3. Modals & Overlays */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .settings-modal {
            width: 90%; max-height: 85%; background: var(--modal-bg); border-radius: 20px; padding: 20px;
            border: 1px solid #444; position: relative;
        }
        /* Modal Header & Inputs */
        #avatarContainer {
            display: grid; /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø¨ÙƒØ© */
            grid-template-columns: repeat(5, 1fr); /* Ø¥Ù†Ø´Ø§Ø¡ 5 Ø£Ø¹Ù…Ø¯Ø© Ù…ØªØ³Ø§ÙˆÙŠØ© */
            gap: 10px; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ± */
            justify-items: center; /* ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
            margin-top: 15px;
            padding: 5px;
        }
        .avatar-selector { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; }
        .avatar-option { width: 60px; height: 60px; border-radius: 50%; border: 1.5px solid var(--text-gray); cursor: pointer; transition: 0.2s; }
        .avatar-option.selected {border: 3px solid #7ed321; transform: scale(1.1); }
        .nickname-input { width: 100%; background: #1a1a1a; border: 1px solid #444; color: white; padding: 12px; border-radius: 10px; font-size: 1rem; outline: none; margin-top: 10px;}
        .save-btn { width: 100%; background: var(--green-action); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1.1rem; }
        .leave-btn { width: 100%; background: #c0392b; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 0.9rem; }
        
        /* Timer Slider Specific */
        .slider-labels { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.6rem; color: #888; }
        .active-label { color: #7ed321; font-weight: bold; }

        /* 4. Top Section Layout */
        .top-section { height: 48%; display: flex; flex-direction: column; padding-bottom: 5px; }

        /* Top Bar & Navigation */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; flex-shrink: 0; user-select: none; -webkit-user-select: none; }
        .top-left { display: flex; gap: 8px; align-items: center; }
        .top-right { display: flex; gap: 8px; align-items: center; }
        .top-timer {
            color: white; 
            font-size: 1.5rem; 
            font-weight: 900;
            font-family: 'Courier New', Courier, monospace; 
            position: absolute;
            left: 50%; 
            transform: translateX(-50%);
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        .icon-circle {
            width: 40px; 
            height: 40px; 
            background: rgba(255,255,255,0.1);
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border: 0.5px solid white; 
            cursor: pointer; 
            color: white;
        }
        .btn-pill {
            background: rgba(255,255,255,0.1); 
            border: 1px solid #444;
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem;
            display: flex; 
            align-items: center; 
            gap: 5px; 
            cursor: pointer; 
            color: white;
        }

        /* Spectators */
        .spectators-section { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 0 15px; flex-shrink: 0; }
        .spectators-list { display: flex; gap: 10px; justify-content: center; align-items: center; min-height: 65px; flex-wrap: wrap;}

        /* Settings Panel */
        .settings-panel {
            background: #1a1a1a; margin: 5px 15px; border-radius: 15px;
            padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .panel-label { text-align: center; color: #888; font-size: 0.65rem; font-weight: bold; margin-bottom: 10px; }
        
        /* Game Mode Selection */
        .mode-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mode-card {
            background: #252525; border-radius: 10px; padding: 6px;
            display: flex; align-items: center; gap: 8px; border: 2px solid transparent; cursor: pointer;
            transition: 0.3s;
        }
        .mode-card.active { border-color: #3498db; background: #1e3a5f; }
        .mode-img { width: 30px; height: 40px; border-radius: 4px; pointer-events: none; }
        .mode-info { pointer-events: none; }
        .mode-info b { font-size: 0.65rem; display: block; }
        .mode-info span { font-size: 0.55rem; color: #aaa; }

        /* Timer Setting Row */
        .setting-row {
            background: rgba(255,255,255,0.05); border-radius: 10px;
            margin-top: 8px; display: flex; align-items: center;
            padding: 6px 12px; border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }

        /* 5. Bottom Section Layout */
        .bottom-section { height: 52%; display: flex; flex-direction: column; border-top: 1px solid #222; overflow: hidden;}
        
        /* Teams Grid */
        .teams-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 6px; padding: 10px ; min-height: 0; }
        .team-box { border-radius: 15px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 4px; border: 1.5px solid rgba(255, 255, 255, 0.3); }
        .blue-box { background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%); }
        .red-box { background: linear-gradient(135deg, #7b241c 0%, #e74c3c 100%); }
        .box-title { font-size: 0.6rem; font-weight: 800; color: white; letter-spacing: 1px; }

        /* Player Slots & Buttons inside Teams */
        .player-slot-container { min-height: 55px; display: flex; align-items: center; justify-content: center; }
        .join-btn {
            width: 85%; padding: 4px 0; font-size: 0.65rem; font-weight: bold;
            color: white; background: linear-gradient(to bottom, #7ed321, #417505);
            border: 1.5px solid #b8e986; border-radius: 15px; cursor: pointer;
            box-shadow: 0 2px 0 #2e5a03; user-select: none; -webkit-user-select: none;
        }
        .join-btn.locked {
            background: transparent !important; border: 1.5px solid #fff !important;
            box-shadow: none !important; cursor: not-allowed; opacity: 0.7;
        }

        /* Player Appearance */
        .player-slot { display: flex; flex-direction: column; align-items: center; position: relative; }
        .player-avatar-wrap { width: 40px; height: 40px; position: relative; }
        .player-img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid #fff; background: #333; }
        .player-name { background: rgba(0,0,0,0.7); font-size: 0.6rem; padding: 1px 6px; border-radius: 5px; margin-top: -5px; z-index: 2; white-space: nowrap;}
        .player-avatar-wrap.is-admin::after {
            content: "ğŸ‘‘"; position: absolute; top: -12px; left: -5px; font-size: 1.1rem; transform: rotate(-20deg);
        }

        /* 6. Footer & Start Button */
        .footer { background: #000;
        height: 70px; 
        padding: 10px; 
        display: flex; 
        align-items: center;
        flex-shrink: 0;
        }
        .start-btn {
            width: 100%; height: 45px; font-size: 1.1rem; font-weight: 900;
            color: white; background: linear-gradient(to bottom, #7ed321, #417505);
            border: 2px solid #b8e986; border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 0 #2e5a03; display: none;
        }
    </style>
</head>
<body>

<div class="mobile-wrapper">
    <div class="modal-overlay" id="profileModal" style="display: flex;">
        <div class="settings-modal">
            <div class="modal-header" id="profileHeader" style="font-weight: bold; margin-bottom: 10px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø¬Ù‡Ø² Ù…Ù„ÙÙƒ</div>
            <div class="avatar-selector" id="avatarContainer"></div>
            <input type="text" id="nicknameInput" class="nickname-input" placeholder="Ø§ÙƒØªØ¨ Ù„Ù‚Ø¨Ùƒ Ù‡Ù†Ø§..." maxlength="12">
            <button class="save-btn" onclick="saveProfile()">Ø­ÙØ¸ ÙˆØ§Ù†Ø¶Ù…Ø§Ù…</button>
            <button id="leaveRoomBtn" class="leave-btn" style="display: none;" onclick="leaveLobby()">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±Ø¯Ù‡Ø© ğŸšª</button>
        </div>
    </div>

    <div class="modal-overlay" id="timerModal">
        <div class="settings-modal">
            <div class="modal-header">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚Øª</div>
            <div style="text-align:center; font-size: 3rem; margin: 10px 0;" id="modalTimerIcon">ğŸš«</div>
            <div style="text-align:center; font-weight:bold;" id="modalTimerText">Ø¨Ø¯ÙˆÙ† Ù…Ø¤Ù‚Øª</div>
            <input type="range" min="0" max="3" value="0" style="width:100%; margin-top:20px;" id="timerSlider" oninput="changeTimer(this.value)">
            <div class="slider-labels">
                <span id="label0" class="active-label">Ø¨Ø¯ÙˆÙ†</span>
                <span id="label1">30Ø«</span>
                <span id="label2">1Ø¯</span>
                <span id="label3">2Ø¯</span>
            </div>
            <button class="save-btn" style="background:#444;" onclick="document.getElementById('timerModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
    <div class="top-section">
        <div class="top-bar">
            <div class="top-left">
                <div class="icon-circle">
                    <span id="playerCount" style="font-size: 0.8rem; font-weight: bold; margin-left: 2px;">0</span> ğŸ‘¤
                </div>
                    <div class="btn-pill" id="roomDisplay" onclick="copyRoomLink()">ğŸ”— Ø§Ù„ØºØ±ÙØ©</div>
                </div>

            <div class="top-timer" id="lobbyDisplayTimer"></div>

            <div class="top-right">
                <div class="btn-pill" onclick="toggleRulesModal(true)">ğŸ“œØ§Ù„Ù‚ÙˆØ§Ø¹Ø¯</div>
                <div class="icon-circle" onclick="openProfileSettings()">âš™ï¸</div>
            </div>
        </div>

        <div class="spectators-section">
            <div class="box-title">Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</div>
            <div class="spectators-list" id="spectators-list"></div>
            <button class="join-btn" style="width:100px; margin-top:5px; background:none; border:1px solid #fff;" onclick="joinTeam('spectators-list')">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
        </div>

        <div class="settings-panel">
            <div class="panel-label">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„Ù„Ø¢Ø¯Ù…Ù† ÙÙ‚Ø·)</div>
            <div class="mode-options">
                <div class="mode-card" id="mode-offline" onclick="setGameMode('offline')">
                    <img src="img/local.webp" class="mode-img">
                    <div class="mode-info"><b>Ø£ÙˆÙÙ„Ø§ÙŠÙ†</b><span>Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯</span></div>
                </div>
                <div class="mode-card active" id="mode-online" onclick="setGameMode('online')">
                    <img src="img/online.webp" class="mode-img">
                    <div class="mode-info"><b>Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</b><span>Ø¹Ø¯Ø© Ø£Ø¬Ù‡Ø²Ø©</span></div>
                </div>
            </div>
            <div class="setting-row" onclick="openTimerModal()">
                <span style="font-size: 1.2rem;" id="mainTimerIcon">ğŸš«</span>
                <div style="margin-right: 10px;">
                    <b style="font-size: 0.7rem; display: block;">Ø§Ù„Ù…Ø¤Ù‚Øª</b>
                    <span style="font-size: 0.55rem; color: #888;" id="mainTimerText">Ø¨Ø¯ÙˆÙ†</span>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="teams-grid">
            <div class="team-box blue-box">
                <div class="box-title">OPERATIVE</div>
                <div class="player-slot-container" id="blue-operative"></div>
                <button class="join-btn" id="btn-blue-operative" onclick="joinTeam('blue-operative')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box red-box">
                <div class="box-title">OPERATIVE</div>
                <div class="player-slot-container" id="red-operative"></div>
                <button class="join-btn" id="btn-red-operative" onclick="joinTeam('red-operative')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box blue-box">
                <div class="box-title">SPYMASTER</div>
                <div class="player-slot-container" id="blue-spymaster"></div>
                <button class="join-btn" id="btn-blue-spymaster" onclick="joinTeam('blue-spymaster')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box red-box">
                <div class="box-title">SPYMASTER</div>
                <div class="player-slot-container" id="red-spymaster"></div>
                <button class="join-btn" id="btn-red-spymaster" onclick="joinTeam('red-spymaster')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
        </div>
        <div class="footer">
            <button class="start-btn" id="startBtn" onclick="handleStartGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>
    </div>
    <div class="modal-overlay" id="rulesModal">
    <div class="settings-modal">
        <span class="close-icon" onclick="toggleRulesModal(false)">âœ•</span>
        <div class="modal-header">ÙƒÙŠÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨</div>
        
        <div class="rules-intro">
            ÙƒÙˆØ¯Ù†Ø§ÙŠÙ…Ø² Ù‡ÙŠ Ù„Ø¹Ø¨Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø±Ø¨Ø· Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ø¨ÙŠÙ† ÙØ±ÙŠÙ‚ÙŠÙ†: <b>Ø§Ù„Ø£Ø²Ø±Ù‚</b> Ùˆ <b>Ø§Ù„Ø£Ø­Ù…Ø±</b>. ÙŠØ­Ø§ÙˆÙ„ ÙƒÙ„ ÙØ±ÙŠÙ‚ ØªØ®Ù…ÙŠÙ† ÙƒÙ„Ù…Ø§ØªÙ‡Ù… Ø§Ù„Ø³Ø±ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±.
        </div>

        <div id="rulesAccordion">
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø±</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        <li>ÙŠÙ†Ù‚Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ÙŠÙ†: <b>Ø§Ù„Ø£Ø²Ø±Ù‚</b> Ùˆ <b>Ø§Ù„Ø£Ø­Ù…Ø±</b>.</li>
                        <li>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ ÙƒÙ„ ÙØ±ÙŠÙ‚ Ø¹Ù„Ù‰ <b>Ø¬Ø§Ø³ÙˆØ³ (Spymaster)</b> ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ùˆ<b>Ø¹Ù…ÙŠÙ„ (Operative)</b>.</li>
                        <li>ÙŠØªÙ… Ø¹Ø±Ø¶ Ø´Ø¨ÙƒØ© 5Ã—5 Ù…ÙƒÙˆÙ†Ø© Ù…Ù† 25 Ø¨Ø·Ø§Ù‚Ø© ÙƒÙˆØ¯Ù†Ø§ÙŠÙ…Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©.</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ•µï¸ Ù‚Ø§Ø¯Ø© Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        <li>ÙŠØ±Ù‰ Ø§Ù„Ù‚Ø§Ø¯Ø© Ù‡ÙˆÙŠØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§ØªØŒ ÙˆÙ‡ÙŠ Ø³Ø±ÙŠØ© ØªÙ…Ø§Ù…Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.</li>
                        <li>ÙŠØ¹Ø·ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ø¯ ØªÙ„Ù…ÙŠØ­Ø§Ù‹ Ù…ÙƒÙˆÙ†Ø§Ù‹ Ù…Ù† <b>ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø©</b> Ùˆ <b>Ø±Ù‚Ù…</b> Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙØ±ÙŠÙ‚Ù‡.</li>
                    </ul>
                    <div class="log-row row-red">
                        <div class="log-clue-item log-clue-red">
                            <img src="img/avatar/snowman.webp" id="rulesExampleAvatar" class="log-avatar" style="border-color:#fff">
                            <div class="log-text-clue">Ø­ÙŠÙˆØ§Ù†</div>
                            <div class="log-num-circle">3</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ™‹â€â™‚ï¸ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Operatives)</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        <li>Ù„Ø§ ÙŠØ¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù‡ÙˆÙŠØ§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹.</li>
                        <li>ÙŠØ¹Ù…Ù„ÙˆÙ† Ù…Ø¹Ø§Ù‹ Ù„ØªØ®Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªÙ„Ù…ÙŠØ­ Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³.</li>
                        <li>ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙ‡Ù… ØªØ¬Ù†Ø¨ ÙƒÙ„Ù…Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø§ÙØ³ØŒ ÙˆØ¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§ØºØªÙŠØ§Ù„.</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸŸ¦ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <p>ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ ÙƒÙ„Ù…Ø© ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø³Ø±ÙŠØ§Ù‹ Ù„ÙˆØ§Ø­Ø¯ Ù…Ù† Ø£Ø±Ø¨Ø¹Ø© Ø£ØµÙ†Ø§Ù:</p>
                    <ul>
                        <li><b>Ø¨Ø·Ø§Ù‚Ø§Øª Ø²Ø±Ù‚Ø§Ø¡:</b> ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§.</li>
                        <li><b>Ø¨Ø·Ø§Ù‚Ø§Øª Ø­Ù…Ø±Ø§Ø¡:</b> ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§.</li>
                        <li><b>Ø§Ù„Ù…Ø§Ø±Ø© Ø§Ù„Ø£Ø¨Ø±ÙŠØ§Ø¡:</b> Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø­Ø§ÙŠØ¯Ø© ØªÙ†Ù‡ÙŠ Ø§Ù„Ø¯ÙˆØ± ÙÙ‚Ø·.</li>
                        <li><b>Ø§Ù„Ù…ØºØªØ§Ù„ (Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡):</b> Ø¥Ø°Ø§ Ù„Ù…Ø³ØªÙ‡Ø§ØŒ ÙŠØ®Ø³Ø± ÙØ±ÙŠÙ‚Ùƒ ÙÙˆØ±Ø§Ù‹!</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ’¬ Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <p>Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ£ØªÙŠ Ø¯ÙˆØ±Ùƒ ÙƒÙ‚Ø§Ø¦Ø¯ Ø¬Ø§Ø³ÙˆØ³:</p>
                    <ol>
                        <li>Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© ØªØ±Ø¨Ø· Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù…Ù…ÙƒÙ† Ù…Ù† Ø¨Ø·Ø§Ù‚Ø§Øª ÙØ±ÙŠÙ‚Ùƒ.</li>
                        <li>Ø£Ø¶Ù Ø±Ù‚Ù…Ø§Ù‹ ÙŠÙˆØ¶Ø­ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªÙ„Ù…ÙŠØ­.</li>
                        <li><b>ØªÙ†Ø¨ÙŠÙ‡:</b> Ù„Ø§ ÙŠØµØ­ Ø¥Ø¹Ø·Ø§Ø¡ ØªÙ„Ù…ÙŠØ­ Ù‡Ùˆ Ø¬Ø²Ø¡ Ù…Ù† ÙƒÙ„Ù…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©!</li>
                    </ol>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ§  Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª Ø§Ù„ØµØ§Ù„Ø­Ø©</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        <li>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¹Ù„Ù‚ Ø§Ù„ØªÙ„Ù…ÙŠØ­ <b>Ø¨Ù…Ø¹Ù†Ù‰</b> Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆÙ„ÙŠØ³ Ø¨Ø·Ø±ÙŠÙ‚Ø© ÙƒØªØ§Ø¨ØªÙ‡Ø§ Ø£Ùˆ Ù…ÙˆÙ‚Ø¹Ù‡Ø§.</li>
                        <li>Ù„Ø§ ÙŠØ¬ÙˆØ² Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ±Ø¬Ù…Ø§Øª Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ù„ØºØ§Øª Ø£Ø®Ø±Ù‰.</li>
                        <li>Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªØ£ÙƒØ¯Ø§Ù‹ Ù…Ù† Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø§Ù„ØªÙ„Ù…ÙŠØ­ØŒ Ø§Ø³Ø£Ù„ Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ù†Ø§ÙØ³ Ø³Ø±ÙŠØ§Ù‹.</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ•¹ï¸ Ø§Ù„ØªØ®Ù…ÙŠÙ† (Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡)</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <p>Ø¨Ø¹Ø¯ Ø³Ù…Ø§Ø¹ Ø§Ù„ØªÙ„Ù…ÙŠØ­ØŒ ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ù€:</p>
                    <ol>
                        <li>Ù…Ù†Ø§Ù‚Ø´Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© ÙÙŠÙ…Ø§ Ø¨ÙŠÙ†Ù‡Ù….</li>
                        <li>ØªØ­Ø¯ÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ù… Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø©.</li>
                        <li>Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ®Ù…ÙŠÙ† ØµØ­ÙŠØ­Ø§Ù‹ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¨ØªØ®Ù…ÙŠÙ† ÙƒÙ„Ù…Ø© Ø¥Ø¶Ø§ÙÙŠØ©.</li>
                    </ol>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ”¢ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª Ø§Ù„Ø®Ø§ØµØ©</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        <li><b>Ø§Ù„ØªÙ„Ù…ÙŠØ­ 0:</b> ÙŠØ¹Ù†ÙŠ Ø£Ù† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ ÙƒÙ„Ù…Ø© Ù…Ù† ÙƒÙ„Ù…Ø§Øª ÙØ±ÙŠÙ‚Ùƒ ØªØ±ØªØ¨Ø· Ø¨Ø§Ù„ØªÙ„Ù…ÙŠØ­.</li>
                        <li><b>Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠ (âˆ):</b> ÙŠØ³Ù…Ø­ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø§Ù„ØªØ®Ù…ÙŠÙ† Ø¨Ù„Ø§ Ø­Ø¯ÙˆØ¯ Ø­ØªÙ‰ ÙŠØ®Ø·Ø¦ÙˆØ§.</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ”„ ØªØ¯ÙÙ‚ Ø§Ù„Ù„Ø¹Ø¨Ø©</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <p>ØªÙ†ØªÙ‡ÙŠ Ù†ÙˆØ¨Ø© Ø§Ù„ÙØ±ÙŠÙ‚ ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
                    <ul>
                        <li>Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø·Ø§Ù‚Ø© "Ù…Ø§Ø± Ø¨Ø±ÙŠØ¡" Ø£Ùˆ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø§ÙØ³.</li>
                        <li>Ø§Ø³ØªÙ†ÙØ§Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø£Ùˆ Ø§Ù„ØªÙˆÙ‚Ù Ø·ÙˆØ§Ø¹ÙŠØ©Ù‹.</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ¯ Ø§Ù„ÙÙˆØ² ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        <li><b>Ø§Ù„ÙÙˆØ²:</b> ÙƒØ´Ù Ø¬Ù…ÙŠØ¹ Ø¨Ø·Ø§Ù‚Ø§Øª ÙØ±ÙŠÙ‚Ùƒ Ø£ÙˆÙ„Ø§Ù‹.</li>
                        <li><b>Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©:</b> Ù„Ù…Ø³ Ø¨Ø·Ø§Ù‚Ø© "Ø§Ù„Ù…ØºØªØ§Ù„" Ø§Ù„Ø£Ø³ÙˆØ¯.</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ¥³ Ù†ØµØ§Ø¦Ø­ Ø®ØªØ§Ù…ÙŠØ©</span>
                    <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        <li>Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ "ÙˆØ¬Ù‡ Ø§Ù„Ø¨ÙˆÙƒØ±" ÙˆÙ„Ø§ ØªØ¹Ø·ÙŠ Ø£ÙŠ Ø¥Ø´Ø§Ø±Ø§Øª Ø¬Ø³Ø¯ÙŠØ©.</li>
                        <li>Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ Ø¨ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø§Øª!</li>
                    </ul>
                </div>
            </div>
        </div>
        <button class="close-modal-btn" onclick="toggleRulesModal(false)">ÙÙ‡Ù…Øª Ø°Ù„Ùƒ!</button>
    </div>
</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, onDisconnect, update, runTransaction, remove, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC95r_D7FVO-cynZ-gK6zbldvvrY4HD2YQ",
        authDomain: "codenames-5fd71.firebaseapp.com",
        projectId: "codenames-5fd71",
        databaseURL: "https://codenames-5fd71-default-rtdb.firebaseio.com",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('r');

    if (!roomId) {
        roomId = Math.random().toString(36).substring(2, 8);
        window.location.href = window.location.pathname + '?r=' + roomId;
    }
    document.getElementById('roomDisplay').innerText = "ğŸ”— " + roomId;

    let playerId = localStorage.getItem('codenames_playerId');
    if (!playerId) {
        playerId = Math.random().toString(36).substring(2, 6);
        localStorage.setItem('codenames_playerId', playerId);
    }

    sessionStorage.setItem('playerId', playerId);

    const roomRef = ref(db, `rooms/${roomId}`);
    const playersRef = ref(db, `rooms/${roomId}/players`);
    const myPlayerRef = ref(db, `rooms/${roomId}/players/${playerId}`);
    const settingsRef = ref(db, `rooms/${roomId}/settings`);

const avatarImages = [
"img/avatar/snowman.webp",
"img/avatar/confused_woman.webp",
"img/avatar/cool_girl.webp",
"img/avatar/delivery_boy.webp",
"img/avatar/laughing.webp",
"img/avatar/old_man.webp",
"img/avatar/photographer.webp",
"img/avatar/pizza_guy.webp",
"img/avatar/reader.webp",
"img/avatar/surprised_man.webp",
];

async function renderAvatars() {
    const container = document.getElementById('avatarContainer');
    if (!container) return;

    container.innerHTML = '<div style="grid-column: span 5; font-size:0.7rem; color:#888;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>'; 

    await preloadImages(); 

    container.innerHTML = ''; 
    avatarImages.forEach((src, index) => {
        const img = document.createElement('img');
        img.src = src;
        img.className = 'avatar-option';
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© Ù‡ÙŠ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨
        if (myData.avatar === src || (index === 0 && !myData.avatar)) {
            img.classList.add('selected');
        }

        img.onclick = function() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¨Ù‚ÙŠØ©
            document.querySelectorAll('.avatar-option').forEach(i => i.classList.remove('selected'));
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©
            this.classList.add('selected');
            // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ù†Ø£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙØ¹Ù„ÙŠ)
            myData.avatar = src; 
        };
        container.appendChild(img);
    });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', renderAvatars);
function areImagesCached() {
    for (let src of avatarImages) {
        let img = new Image();
        img.src = src;
        if (!img.complete) return false;
    }
    return true;
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¨Ù‚ (ØªØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)
function preloadImages() {
    const promises = avatarImages.map(src => {
        return new Promise((resolve) => {
            const img = new Image();
            img.src = src;
            img.onload = resolve;
            img.onerror = resolve; 
        });
    });
    return Promise.all(promises);
}
const cardVisuals = {
    'blue': ['img/card/Blue1.webp', 'img/card/Blue2.webp'],
    'red': ['img/card/Red1.webp', 'img/card/Red2.webp'],
    'killer': ['img/card/Black.webp'],
    'neutral': ['img/card/Normal1.webp', 'img/card/Normal2.webp']
};

// 2. Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
let shuffledPools = { 'blue': [], 'red': [], 'killer': [], 'neutral': [] };
let lastUsedImages = { 'blue': null, 'red': null, 'killer': null, 'neutral': null };

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ù„Ø· (Helper Function)
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// 4. Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ©
function getNextImageFromPool(type) {
    if (shuffledPools[type].length === 0) {
        let newPool = [...cardVisuals[type]];
        shuffleArray(newPool);
        
        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø©
        if (newPool.length > 1 && newPool[newPool.length - 1] === lastUsedImages[type]) {
            [newPool[newPool.length - 1], newPool[0]] = [newPool[0], newPool[newPool.length - 1]];
        }
        shuffledPools[type] = newPool;
    }
    
    let img = shuffledPools[type].pop();
    lastUsedImages[type] = img;
    return img;
}

window.copyRoomLink = () => {
    navigator.clipboard.writeText(window.location.href);
    showToast("âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©!");
};

function showToast(message) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: rgba(20, 20, 20, 0.95);
        color: #ddd;
        padding: 10px 18px;
        border-radius: 14px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid rgba(52, 152, 219, 0.6);
        box-shadow: 0 8px 20px rgba(0,0,0,.6);
        opacity: 0;
        transition: all .25s ease;
        z-index: 9999;
        pointer-events: none;
        backdrop-filter: blur(6px);
    `;

    document.body.appendChild(toast);

    requestAnimationFrame(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateX(-50%) translateY(0)";
    });

    setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateX(-50%) translateY(10px)";
        setTimeout(() => toast.remove(), 250);
    }, 1800);
}


    let myData = {
        id: playerId,
        name: "",
        avatar: "img/avatar/snowman.webp",
        team: "spectators-list",
        joinedAt: Date.now()
    };
    let isAdmin = false;
    let hasJoined = false;

    window.selectAvatar = (el) => {
        document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
        el.classList.add('selected');
        myData.avatar = "img/" + el.src.split('/').pop();
    };

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø§Ø· Ø§Ù„ØºØ±ÙØ© Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± (Ù…ÙˆØ¯ØŒ Ù…Ø¤Ù‚ØªØŒ Ø§Ù†Ø¶Ù…Ø§Ù…)
function updateRoomActivity() {
    update(roomRef, { lastActivity: Date.now() });
}
window.toggleRulesModal = (show) => {
    document.getElementById('rulesModal').style.display = show ? 'flex' : 'none';
};

window.toggleAccordion = (header) => {
    const content = header.nextElementSibling;
    const isVisible = content.style.display === 'block';
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ ØªØ¨ÙˆÙŠØ¨ Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹
    document.querySelectorAll('.accordion-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.accordion-header').forEach(h => h.classList.remove('active'));
    
    // ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØºÙ„Ù‚Ø§Ù‹
    if (!isVisible) {
        content.style.display = 'block';
        header.classList.add('active');
    }
};

window.saveProfile = async () => {
    const name = document.getElementById('nicknameInput').value.trim();
    if (!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ");
    
    myData.name = name;
    hasJoined = true;
    document.getElementById('profileModal').style.display = 'none';

    const now = Date.now();
    
    // ÙØ­Øµ Ù‡Ù„ Ø§Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŸ
    const roomSnap = await get(roomRef);
    if (!roomSnap.exists()) {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø· Ù‡Ù†Ø§
        await set(roomRef, {
            lastActivity: now,
            status: "lobby",
            settings: { mode: 'online', timer: 0 } // Ø£ØµØ¨Ø­Øª ØµÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
        });
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù†Ø­Ø¯Ø« Ù†Ø´Ø§Ø·Ù‡Ø§ ÙÙ‚Ø·
        updateRoomActivity();
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨
    await set(myPlayerRef, {
        ...myData,
        lastActive: now
    });

    startHeartbeat(); // Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø¨Ø¶Ø§Øª Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØºØ±ÙØ© Ù†Ø´Ø·Ø©
};

function updateServer() {
    if (!hasJoined) return;
    set(myPlayerRef, {
        ...myData,
        lastActive: Date.now()
    });
    updateRoomActivity(); // ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø§Ø· Ø§Ù„ØºØ±ÙØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
}

window.openProfileSettings = () => {
    document.getElementById('profileHeader').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ";
    const input = document.getElementById('nicknameInput');
    input.value = myData.name;
    document.getElementById('leaveRoomBtn').style.display = 'block';
    document.getElementById('profileModal').style.display = 'flex';
    
    // Ø³Ø·Ø± Ø§Ù„ÙÙˆÙƒØ³ Ø§Ù„Ù…Ø¶Ø§Ù
    setTimeout(() => input.focus(), 50); 
};
    window.leaveLobby = () => {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ")) {
            remove(myPlayerRef).then(() => {
                location.href = 'index.html';
            });
        }
    };

    window.joinTeam = (teamId) => {
        if (!hasJoined) return;
        if (teamId === 'spectators-list') {
            myData.team = teamId;
            updateServer();
            return;
        }
        runTransaction(playersRef, (players) => {
            if (players) {
                const isTaken = Object.values(players).some(p => p.team === teamId && p.id !== playerId);
                if (isTaken) {
                    return;
                }
            }
            if (!players) players = {};
            if (!players[playerId]) players[playerId] = myData;
            players[playerId].team = teamId;
            myData.team = teamId;
            return players;
        });
    };


window.setGameMode = (mode) => {
    if (!isAdmin) return;
    update(settingsRef, { mode: mode });
    updateRoomActivity(); // Ø³Ø¬Ù„ Ù†Ø´Ø§Ø·
};
    window.openTimerModal = () => {
        if (isAdmin) document.getElementById('timerModal').style.display = 'flex';
    };

window.changeTimer = (val) => {
    if (!isAdmin) return;
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± (0-3) Ø¥Ù„Ù‰ Ø«ÙˆØ§Ù†ÙŠ Ø­Ù‚ÙŠÙ‚ÙŠØ©
    const secondsMap = [0, 30, 60, 120]; 
    const seconds = secondsMap[val];
    
    // Ù†Ø­Ø¯Ø« ÙÙ‚Ø· Ø±Ù‚Ù… Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    update(settingsRef, { timer: seconds });
    updateRoomActivity();
};
    
function generateBoard(startingTeam) {
const words = [
  "Ø£Ø³Ø¯","Ù†Ù…Ø±","Ø°Ø¦Ø¨","Ø«Ø¹Ù„Ø¨","Ø­ØµØ§Ù†","Ù†Ø³Ø±","ØºØ±Ø§Ø¨","Ø³Ù…ÙƒØ©","Ù‚Ø±Ø´","Ø­ÙˆØª",
  "Ø´Ù…Ø³","Ù‚Ù…Ø±","Ù†Ø¬Ù…","ÙƒÙˆÙƒØ¨","Ù…Ø¬Ø±Ø©","Ø¸Ù„","Ù†ÙˆØ±","Ù„ÙŠÙ„","Ù†Ù‡Ø§Ø±","Ø¨Ø±Ù‚",
  "Ø¬Ø¨Ù„","ÙˆØ§Ø¯ÙŠ","Ù†Ù‡Ø±","Ø¨Ø­Ø±","Ù…Ø­ÙŠØ·","Ø¬Ø²ÙŠØ±Ø©","ØµØ­Ø±Ø§Ø¡","ØºØ§Ø¨Ø©","ÙƒÙ‡Ù","Ø¨Ø±ÙƒØ§Ù†",
  "ÙƒØªØ§Ø¨","Ù‚Ù„Ù…","ÙˆØ±Ù‚Ø©","Ø­Ø¨Ø±","Ù…ÙƒØªØ¨Ø©","Ø¯ÙØªØ±","Ø±Ø³Ø§Ù„Ø©","Ø®Ø±ÙŠØ·Ø©","Ø¹Ù†ÙˆØ§Ù†","ÙƒÙ„Ù…Ø©",
  "Ø¨Ø§Ø¨","Ù†Ø§ÙØ°Ø©","Ù…ÙØªØ§Ø­","Ù‚ÙÙ„","Ø¯Ø±Ø¬","Ø³Ù‚Ù","Ø¬Ø¯Ø§Ø±","Ù…ØµØ¨Ø§Ø­","ÙƒØ±Ø³ÙŠ","Ø·Ø§ÙˆÙ„Ø©",
  "Ø³ÙŠØ§Ø±Ø©","Ù‚Ø·Ø§Ø±","Ø³ÙÙŠÙ†Ø©","Ø·Ø§Ø¦Ø±Ø©","Ø¯Ø±Ø§Ø¬Ø©","Ù…Ø­Ø·Ø©","Ù…ÙŠÙ†Ø§Ø¡","Ù…Ø·Ø§Ø±","Ø·Ø±ÙŠÙ‚","Ø¬Ø³Ø±",
  "Ø³Ø§Ø¹Ø©","Ø¨ÙˆØµÙ„Ø©","Ù…Ø±Ø¢Ø©","ÙƒØ§Ù…ÙŠØ±Ø§","Ù‡Ø§ØªÙ","Ø­Ø§Ø³ÙˆØ¨","Ø±Ø§Ø¯ÙŠÙˆ","ØªÙ„ÙØ§Ø²","Ø¨Ø·Ø§Ø±ÙŠØ©","Ø²Ø±",
  "ØªÙØ§Ø­Ø©","Ø®Ø¨Ø²","Ù‚Ù‡ÙˆØ©","Ø´Ø§ÙŠ","Ø¹Ø³Ù„","Ø³ÙƒØ±","Ù…Ù„Ø­","Ø²ÙŠØª","Ù„ÙŠÙ…ÙˆÙ†","ØªÙ…Ø±",
  "Ù…Ù„Ùƒ","ØªØ§Ø¬","Ø³ÙŠÙ","Ø¯Ø±Ø¹","Ù‚Ù„Ø¹Ø©","Ø¬Ù†Ø¯ÙŠ","Ù‚Ø§Ø¦Ø¯","Ø¹Ù„Ù…","Ø±Ø§ÙŠØ©","Ø­Ø¯ÙˆØ¯",
  "ÙƒØ±Ø©","Ù…Ù„Ø¹Ø¨","Ù‡Ø¯Ù","Ø´Ø¨ÙƒØ©","Ø­ÙƒÙ…","Ù…Ø¶Ù…Ø§Ø±","Ù…ÙŠØ¯Ø§Ù„ÙŠØ©","ÙƒØ£Ø³","ÙØ±ÙŠÙ‚","Ø¬ÙˆÙ„Ø©",
  "Ù‚Ù„Ø¨","Ø¹ÙŠÙ†","ÙŠØ¯","Ø±Ø£Ø³","Ù‚Ø¯Ù…","Ø¯Ù…","Ø¹ØµØ¨","Ø¸Ù„","ØµÙˆØª","ØµØ¯Ù‰",
  "Ù†Ø§Ø±","Ù…Ø§Ø¡","Ù‡ÙˆØ§Ø¡","ØªØ±Ø§Ø¨","Ø¬Ù„ÙŠØ¯","Ø¯Ø®Ø§Ù†","Ø±Ù…Ø§Ø¯","Ø´Ø±Ø§Ø±Ø©","Ù…ÙˆØ¬","Ø±ÙŠØ­",
  "Ù…ÙØªØ§Ø­","Ø³Ø±","Ù„ØºØ²","Ø´ÙØ±Ø©","Ø¹Ù„Ø§Ù…Ø©","Ø¥Ø´Ø§Ø±Ø©","Ø·Ø±ÙŠÙ‚","Ø¨ÙˆØ§Ø¨Ø©","Ø­Ø¯ÙŠÙ‚Ø©","Ø¬ÙˆÙ‡Ø±Ø©",
  "Ù‚Ù…Ø±","Ø´Ù‡Ø§Ø¨","Ù…Ø¯Ø§Ø±","Ù…Ø³Ø¨Ø§Ø±","Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ","Ù…Ø¬Ø±Ø©","ÙØ±Ø§Øº","Ù†ÙÙ‚","Ø¨ÙˆØ§Ø¨Ø©","Ø¨Ø¹Ø¯",
  "Ø·ÙÙ„","Ù…Ø¹Ù„Ù…","Ø·Ø¨ÙŠØ¨","ØªØ§Ø¬Ø±","Ø³Ø§Ø¦Ù‚","Ø¨Ø­Ø§Ø±","Ø±Ø³Ø§Ù…","Ù…ÙˆØ³ÙŠÙ‚ÙŠ","Ù‚Ø§Ø¶ÙŠ","Ø´Ø§Ø¹Ø±",
  "Ù…Ø¯ÙŠÙ†Ø©","Ù‚Ø±ÙŠØ©","Ø³ÙˆÙ‚","Ù…Ù‚Ù‡Ù‰","Ù…ÙƒØªØ¨Ø©","Ù…Ø¯Ø±Ø³Ø©","Ù…Ø³ØªØ´ÙÙ‰","Ø­Ø¯ÙŠÙ‚Ø©","Ù…ØªØ­Ù","Ù…Ø³Ø±Ø­",
  "ØµÙ†Ø¯ÙˆÙ‚","Ø­Ù‚ÙŠØ¨Ø©","Ù…Ø­ÙØ¸Ø©","Ø®Ø²Ø§Ù†Ø©","Ø±Ù","Ø¯Ø±Ø¬","Ù…Ø®Ø²Ù†","Ø¨Ø±Ù…ÙŠÙ„","Ø³Ù„Ø©","Ø¹Ù„Ø¨Ø©",
  "Ø°Ù‡Ø¨","ÙØ¶Ø©","Ø­Ø¯ÙŠØ¯","Ù†Ø­Ø§Ø³","Ø­Ø¬Ø±","Ù…Ø§Ø³","Ù„Ø¤Ù„Ø¤","Ø²Ù…Ø±Ø¯","ÙŠØ§Ù‚ÙˆØª","Ø¨Ù„ÙˆØ±"
];
    
    // Ø®Ù„Ø· Ø§Ù„ÙƒÙ„Ù…Ø§Øª
    const shuffledWords = [...words];
    shuffleArray(shuffledWords);
    
    // ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª ÙƒÙ„ ÙØ±ÙŠÙ‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¯Ø¦
    const redCount = (startingTeam === "red") ? 9 : 8;
    const blueCount = (startingTeam === "blue") ? 9 : 8;

    // Ø¨Ù†Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
    const types = [
        "killer", 
        ...Array(redCount).fill("red"), 
        ...Array(blueCount).fill("blue"), 
        ...Array(7).fill("neutral")
    ];

    // Ø®Ù„Ø· Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ù„ØªÙˆØ²ÙŠØ¹Ù‡Ø§ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©
    shuffleArray(types);

    const board = [];
    for (let i = 0; i < 25; i++) {
        const currentType = types[i];
        board.push({
            word: shuffledWords[i],
            type: currentType,
            revealed: false,
            visual: getNextImageFromPool(currentType) 
        });
    }
    return board;
}
window.handleStartGame = async () => {
    if (!isAdmin) return;

    const settingsSnap = await get(settingsRef);
    const currentMode = settingsSnap.exists() ? settingsSnap.val().mode : 'online';

    const gameRef = ref(db, `rooms/${roomId}/game`);
    const snap = await get(gameRef);

    if (!snap.exists()) {
        // 1. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¯Ø¦ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
        const firstTeam = Math.random() < 0.5 ? "red" : "blue";

        // 2. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¯Ø¦ (ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ± Ù„Ù„Ø¯Ø§Ù„Ø©)
        const newBoard = generateBoard(firstTeam);

        await set(gameRef, {
            board: newBoard,
            turn: { team: firstTeam, phase: "spymaster", updatedAt: Date.now() },
            scores: { red: 0, blue: 0 },
            remaining: firstTeam === "red"
                ? { red: 9, blue: 8 }
                : { red: 8, blue: 9 }
        });
    }


    // 3. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ© Ù„Ù„Ø¬Ù…ÙŠØ¹
    await update(ref(db, `rooms/${roomId}`), { status: "started" });

    // 4. Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¯ Ø§Ù„Ù…Ø®ØªØ§Ø±
    if (currentMode === 'offline') {
        window.location.href = `game.html`;
    } else {
        window.location.href = `game_multiplayer.html?r=${roomId}&p=${playerId}`;
    }
};


    onValue(playersRef, (snapshot) => {
        const players = snapshot.val();
        if (!players) return;
        const playerList = Object.values(players);
        document.getElementById('playerCount').innerText = playerList.length;
        const sorted = playerList.sort((a, b) => a.joinedAt - b.joinedAt);
        const adminId = sorted[0].id;
        isAdmin = (playerId === adminId);
        document.getElementById('startBtn').style.display = isAdmin ? 'block' : 'none';
        const adminElements = document.querySelectorAll('.settings-panel');
        adminElements.forEach(el => el.style.opacity = isAdmin ? "1" : "0.5");
        renderLobby(players, adminId);
    });

onValue(settingsRef, (snapshot) => {
    const s = snapshot.val();
    if (!s || s.timer === undefined) return;

    // 1. ØªØ­Ø¯ÙŠØ« ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨Ø©
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
    if (s.mode) {
        const activeCard = document.getElementById('mode-' + s.mode);
        if(activeCard) activeCard.classList.add('active');
    }

    // 2. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©)
    const seconds = s.timer;
    const displayTimer = document.getElementById('lobbyDisplayTimer');
    const mainTimerText = document.getElementById('mainTimerText');
    const mainTimerIcon = document.getElementById('mainTimerIcon');
    const modalTimerText = document.getElementById('modalTimerText');
    const modalTimerIcon = document.getElementById('modalTimerIcon');

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    let label = "Ø¨Ø¯ÙˆÙ†";
    let icon = "ğŸš«";
    let displayStr = "";

    if (seconds > 0) {
        icon = seconds === 30 ? "âš¡" : (seconds === 60 ? "â±ï¸" : "ğŸ¢");
        label = seconds < 60 ? `${seconds} Ø«Ø§Ù†ÙŠØ©` : `${seconds / 60} Ø¯Ù‚ÙŠÙ‚Ø©`;
        displayStr = seconds === 30 ? "00:30" : (seconds === 60 ? "01:00" : "02:00");
        displayTimer.style.display = 'block';
    } else {
        displayTimer.style.display = 'none';
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    mainTimerText.innerText = label;
    mainTimerIcon.innerText = icon;
    modalTimerText.innerText = label;
    modalTimerIcon.innerText = icon;
    displayTimer.innerText = displayStr;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ÙˆÙ…ÙƒØ§Ù† Ø§Ù„ØªÙ…ÙŠÙŠØ² (0, 30, 60, 120) -> (0, 1, 2, 3)
    const valMap = { 0: 0, 30: 1, 60: 2, 120: 3 };
    const sliderVal = valMap[seconds];
    document.getElementById('timerSlider').value = sliderVal;

    for(let i=0; i<4; i++) {
        const lbl = document.getElementById('label'+i);
        if(lbl) lbl.className = (i == sliderVal ? 'active-label' : '');
    }
});

    function renderLobby(players, adminId) {
        const containers = {
            'spectators-list': document.getElementById('spectators-list'),
            'blue-operative': document.getElementById('blue-operative'),
            'blue-spymaster': document.getElementById('blue-spymaster'),
            'red-operative': document.getElementById('red-operative'),
            'red-spymaster': document.getElementById('red-spymaster')
        };
        Object.values(containers).forEach(c => { if(c) c.innerHTML = ''; });
        document.querySelectorAll('.join-btn:not([onclick*="spectators"])').forEach(b => {
            b.innerText = "Ø§Ù†Ø¶Ù…Ø§Ù…"; b.className = "join-btn"; b.disabled = false;
        });
        Object.values(players).forEach(p => {
            const isMe = p.id === playerId;
            const isPlayerAdmin = p.id === adminId;
            const html = `
                <div class="player-slot">
                    <div class="player-avatar-wrap ${isPlayerAdmin ? 'is-admin' : ''}">
                        <img src="${p.avatar}" class="player-img" style="${isMe ? 'border: 2px solid #7ed321' : ''}">
                    </div>
                    <div class="player-name">${p.name} ${isMe ? '(Ø£Ù†Øª)' : ''}</div>
                </div>`;
            const target = containers[p.team];
            if (target) {
                target.insertAdjacentHTML('beforeend', html);
                if (p.team !== 'spectators-list') {
                    const btn = document.getElementById('btn-' + p.team);
                    if (btn) { btn.innerText = "Ù…Ù†Ø¶Ù…"; btn.classList.add('locked'); btn.disabled = true; }
                }
            }
        });
    }
const statusRef = ref(db, `rooms/${roomId}/status`);

onValue(ref(db, `rooms/${roomId}`), async (snap) => {
    const data = snap.val();
    if (data && data.status === "started") {
        const mode = data.settings ? data.settings.mode : 'online';
        const targetPage = (mode === 'offline') ? 'game.html' : 'game_multiplayer.html';
        window.location.href = `${targetPage}?r=${roomId}&p=${playerId}`;
    }
});
// Ø¹Ù…Ù„ ÙÙˆÙƒØ³ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        document.getElementById('nicknameInput').focus();
    }, 100); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
});
document.getElementById('nicknameInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        saveProfile();
    }
});

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØºØ±Ù Ø§Ù„Ù…Ù‡Ø¬ÙˆØ±Ø©
async function vacuumCleaner() {
    const allRoomsRef = ref(db, `rooms`);
    try {
        const snapshot = await get(allRoomsRef);
        if (!snapshot.exists()) return;

        const now = Date.now();
        const TEN_MINUTES = 10000;
        const rooms = snapshot.val();

        for (const id in rooms) {
            const room = rooms[id];
            
            // Ø¥Ø°Ø§ Ù…Ø± 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ù†Ø´Ø§Ø· (Last Activity)
            if (room.lastActivity && (now - room.lastActivity > TEN_MINUTES)) {
                console.log(`Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø®Ø§Ù…Ù„Ø©: ${id}`);
                await remove(ref(db, `rooms/${id}`));
            } 
            // Ø­Ø°Ù Ø§Ù„ØºØ±Ù Ø§Ù„ØªØ§Ù„ÙØ© Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ù†Ø´Ø§Ø· Ø£ØµÙ„Ø§Ù‹
            else if (!room.lastActivity) {
                await remove(ref(db, `rooms/${id}`));
            }
        }
    } catch (e) { console.error("Vacuum failed:", e); }
}

// Ù†Ø¨Ø¶Ø§Øª Ø§Ù„Ù‚Ù„Ø¨: ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø§Ø· Ø§Ù„ØºØ±ÙØ© ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† Ø·Ø§Ù„Ù…Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ØªÙˆØ§Ø¬Ø¯
function startHeartbeat() {
    setInterval(() => {
        // Ø§Ù„Ø¢Ø¯Ù…Ù† ÙÙ‚Ø· Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© "Ø§Ù„ØºØ±ÙØ© Ù„Ø§ ØªØ²Ø§Ù„ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…"
        if (hasJoined && isAdmin) {
            updateRoomActivity();
        }
    }, 300000); // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚ (Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù€ 10 Ø¯Ù‚Ø§Ø¦Ù‚)
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙƒÙ†Ø³Ø© ÙÙˆØ± Ø¯Ø®ÙˆÙ„ Ø£ÙŠ Ø´Ø®Øµ Ù„Ù„Ø±Ø§Ø¨Ø· (Ø­ØªÙ‰ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù…Ù‡)
vacuumCleaner();
</script>
</body>
</html>