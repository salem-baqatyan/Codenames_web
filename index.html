<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codenames Pro - Lobby</title>
<style>
        /* 1. Global & Root Styles */
        :root {
            --bg-dark: #000000;
            --panel-bg: #1a1a1a;
            --blue-team: #3498db;
            --red-team: #e74c3c;
            --green-action: #4caf50;
            --text-gray: #aaaaaa;
            --modal-bg: #2a2a2a;
            --mobile-max-width: 450px;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { 
            margin: 0; 
            background-color: var(--bg-dark); 
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            height: 100dvh;
            overflow: hidden; 
        }

        /* 2. Main Wrapper */
        .mobile-wrapper {
            width: 100%; 
            max-width: var(--mobile-max-width);
            height: 100dvh; 
            background: #000;
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid #333; 
            border-right: 1px solid #333;
            position: relative;
            overflow: hidden;
        }

        /* 3. Modals & Overlays */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .settings-modal {
            width: 90%; max-height: 85%; background: var(--modal-bg); border-radius: 20px; padding: 20px;
            border: 1px solid #444; position: relative;
        }
        /* Modal Header & Inputs */
        .avatar-selector { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; }
        .avatar-option { width: 60px; height: 60px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: 0.2s; }
        .avatar-option.selected { border-color: #7ed321; transform: scale(1.1); }
        .nickname-input { width: 100%; background: #1a1a1a; border: 1px solid #444; color: white; padding: 12px; border-radius: 10px; font-size: 1rem; outline: none; margin-top: 10px;}
        .save-btn { width: 100%; background: var(--green-action); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1.1rem; }
        .leave-btn { width: 100%; background: #c0392b; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 0.9rem; }
        
        /* Timer Slider Specific */
        .slider-labels { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.6rem; color: #888; }
        .active-label { color: #7ed321; font-weight: bold; }

        /* 4. Top Section Layout */
        .top-section { height: 48%; display: flex; flex-direction: column; padding-bottom: 5px; }

        /* Top Bar & Navigation */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; flex-shrink: 0; user-select: none; -webkit-user-select: none; }
        .top-left { display: flex; gap: 8px; align-items: center; }
        .top-right { display: flex; gap: 8px; align-items: center; }
        .top-timer {
            color: #ff0000; 
            font-size: 1.5rem; 
            font-weight: 900;
            font-family: 'Courier New', Courier, monospace; 
            position: absolute;
            left: 50%; 
            transform: translateX(-50%);
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        .icon-circle {
            width: 40px; 
            height: 40px; 
            background: rgba(255,255,255,0.1);
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border: 0.5px solid white; 
            cursor: pointer; 
            color: white;
        }
        .btn-pill {
            background: rgba(255,255,255,0.1); 
            border: 1px solid #444;
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem;
            display: flex; 
            align-items: center; 
            gap: 5px; 
            cursor: pointer; 
            color: white;
        }

        /* Spectators */
        .spectators-section { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 0 15px; flex-shrink: 0; }
        .spectators-list { display: flex; gap: 10px; justify-content: center; align-items: center; min-height: 65px; flex-wrap: wrap;}

        /* Settings Panel */
        .settings-panel {
            background: #1a1a1a; margin: 5px 15px; border-radius: 15px;
            padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .panel-label { text-align: center; color: #888; font-size: 0.65rem; font-weight: bold; margin-bottom: 10px; }
        
        /* Game Mode Selection */
        .mode-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mode-card {
            background: #252525; border-radius: 10px; padding: 6px;
            display: flex; align-items: center; gap: 8px; border: 2px solid transparent; cursor: pointer;
            transition: 0.3s;
        }
        .mode-card.active { border-color: #3498db; background: #1e3a5f; }
        .mode-img { width: 30px; height: 40px; border-radius: 4px; pointer-events: none; }
        .mode-info { pointer-events: none; }
        .mode-info b { font-size: 0.65rem; display: block; }
        .mode-info span { font-size: 0.55rem; color: #aaa; }

        /* Timer Setting Row */
        .setting-row {
            background: rgba(255,255,255,0.05); border-radius: 10px;
            margin-top: 8px; display: flex; align-items: center;
            padding: 6px 12px; border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }

        /* 5. Bottom Section Layout */
        .bottom-section { height: 52%; display: flex; flex-direction: column; border-top: 1px solid #222; overflow: hidden;}
        
        /* Teams Grid */
        .teams-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 6px; padding: 10px ; min-height: 0; }
        .team-box { border-radius: 15px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 4px; border: 1.5px solid rgba(255, 255, 255, 0.3); }
        .blue-box { background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%); }
        .red-box { background: linear-gradient(135deg, #7b241c 0%, #e74c3c 100%); }
        .box-title { font-size: 0.6rem; font-weight: 800; color: white; letter-spacing: 1px; }

        /* Player Slots & Buttons inside Teams */
        .player-slot-container { min-height: 55px; display: flex; align-items: center; justify-content: center; }
        .join-btn {
            width: 85%; padding: 4px 0; font-size: 0.65rem; font-weight: bold;
            color: white; background: linear-gradient(to bottom, #7ed321, #417505);
            border: 1.5px solid #b8e986; border-radius: 15px; cursor: pointer;
            box-shadow: 0 2px 0 #2e5a03; user-select: none; -webkit-user-select: none;
        }
        .join-btn.locked {
            background: transparent !important; border: 1.5px solid #fff !important;
            box-shadow: none !important; cursor: not-allowed; opacity: 0.7;
        }

        /* Player Appearance */
        .player-slot { display: flex; flex-direction: column; align-items: center; position: relative; }
        .player-avatar-wrap { width: 40px; height: 40px; position: relative; }
        .player-img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid #fff; background: #333; }
        .player-name { background: rgba(0,0,0,0.7); font-size: 0.6rem; padding: 1px 6px; border-radius: 5px; margin-top: -5px; z-index: 2; white-space: nowrap;}
        .player-avatar-wrap.is-admin::after {
            content: "ğŸ‘‘"; position: absolute; top: -12px; left: -5px; font-size: 1.1rem; transform: rotate(-20deg);
        }

        /* 6. Footer & Start Button */
        .footer { background: #000;
        height: 70px; 
        padding: 10px; 
        display: flex; 
        align-items: center;
        flex-shrink: 0;
        }
        .start-btn {
            width: 100%; height: 45px; font-size: 1.1rem; font-weight: 900;
            color: white; background: linear-gradient(to bottom, #7ed321, #417505);
            border: 2px solid #b8e986; border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 0 #2e5a03; display: none;
        }
    </style>
</head>
<body>

<div class="mobile-wrapper">
    <div class="modal-overlay" id="profileModal" style="display: flex;">
        <div class="settings-modal">
            <div class="modal-header" id="profileHeader" style="font-weight: bold; margin-bottom: 10px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø¬Ù‡Ø² Ù…Ù„ÙÙƒ</div>
            <div class="avatar-selector" id="avatarContainer"></div>
            <input type="text" id="nicknameInput" class="nickname-input" placeholder="Ø§ÙƒØªØ¨ Ù„Ù‚Ø¨Ùƒ Ù‡Ù†Ø§..." maxlength="12">
            <button class="save-btn" onclick="saveProfile()">Ø­ÙØ¸ ÙˆØ§Ù†Ø¶Ù…Ø§Ù…</button>
            <button id="leaveRoomBtn" class="leave-btn" style="display: none;" onclick="leaveLobby()">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±Ø¯Ù‡Ø© ğŸšª</button>
        </div>
    </div>

    <div class="modal-overlay" id="timerModal">
        <div class="settings-modal">
            <div class="modal-header">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚Øª</div>
            <div style="text-align:center; font-size: 3rem; margin: 10px 0;" id="modalTimerIcon">ğŸš«</div>
            <div style="text-align:center; font-weight:bold;" id="modalTimerText">Ø¨Ø¯ÙˆÙ† Ù…Ø¤Ù‚Øª</div>
            <input type="range" min="0" max="3" value="0" style="width:100%; margin-top:20px;" id="timerSlider" oninput="changeTimer(this.value)">
            <div class="slider-labels">
                <span id="label0" class="active-label">Ø¨Ø¯ÙˆÙ†</span>
                <span id="label1">30Ø«</span>
                <span id="label2">1Ø¯</span>
                <span id="label3">2Ø¯</span>
            </div>
            <button class="save-btn" style="background:#444;" onclick="document.getElementById('timerModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="top-section">
        <div class="top-bar">
            <div class="top-left">
                <div class="icon-circle">
                    <span id="playerCount" style="font-size: 0.8rem; font-weight: bold; margin-left: 2px;">0</span> ğŸ‘¤
                </div>
                    <div class="btn-pill" id="roomDisplay" onclick="copyRoomLink()">ğŸ”— Ø§Ù„ØºØ±ÙØ©</div>
                </div>

            <div class="top-timer" id="lobbyDisplayTimer"></div>

            <div class="top-right">
                <div class="btn-pill">ğŸ“ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯</div>
                <div class="icon-circle" onclick="openProfileSettings()">âš™ï¸</div>
            </div>
        </div>

        <div class="spectators-section">
            <div class="box-title">Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</div>
            <div class="spectators-list" id="spectators-list"></div>
            <button class="join-btn" style="width:100px; margin-top:5px; background:none; border:1px solid #fff;" onclick="joinTeam('spectators-list')">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
        </div>

        <div class="settings-panel">
            <div class="panel-label">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„Ù„Ø¢Ø¯Ù…Ù† ÙÙ‚Ø·)</div>
            <div class="mode-options">
                <div class="mode-card" id="mode-offline" onclick="setGameMode('offline')">
                    <img src="img/local.webp" class="mode-img">
                    <div class="mode-info"><b>Ø£ÙˆÙÙ„Ø§ÙŠÙ†</b><span>Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯</span></div>
                </div>
                <div class="mode-card active" id="mode-online" onclick="setGameMode('online')">
                    <img src="img/online.webp" class="mode-img">
                    <div class="mode-info"><b>Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</b><span>Ø¹Ø¯Ø© Ø£Ø¬Ù‡Ø²Ø©</span></div>
                </div>
            </div>
            <div class="setting-row" onclick="openTimerModal()">
                <span style="font-size: 1.2rem;" id="mainTimerIcon">ğŸš«</span>
                <div style="margin-right: 10px;">
                    <b style="font-size: 0.7rem; display: block;">Ø§Ù„Ù…Ø¤Ù‚Øª</b>
                    <span style="font-size: 0.55rem; color: #888;" id="mainTimerText">Ø¨Ø¯ÙˆÙ†</span>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="teams-grid">
            <div class="team-box blue-box">
                <div class="box-title">OPERATIVE</div>
                <div class="player-slot-container" id="blue-operative"></div>
                <button class="join-btn" id="btn-blue-operative" onclick="joinTeam('blue-operative')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box red-box">
                <div class="box-title">OPERATIVE</div>
                <div class="player-slot-container" id="red-operative"></div>
                <button class="join-btn" id="btn-red-operative" onclick="joinTeam('red-operative')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box blue-box">
                <div class="box-title">SPYMASTER</div>
                <div class="player-slot-container" id="blue-spymaster"></div>
                <button class="join-btn" id="btn-blue-spymaster" onclick="joinTeam('blue-spymaster')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box red-box">
                <div class="box-title">SPYMASTER</div>
                <div class="player-slot-container" id="red-spymaster"></div>
                <button class="join-btn" id="btn-red-spymaster" onclick="joinTeam('red-spymaster')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
        </div>
        <div class="footer">
            <button class="start-btn" id="startBtn" onclick="handleStartGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, onDisconnect, update, runTransaction, remove, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC95r_D7FVO-cynZ-gK6zbldvvrY4HD2YQ",
        authDomain: "codenames-5fd71.firebaseapp.com",
        projectId: "codenames-5fd71",
        databaseURL: "https://codenames-5fd71-default-rtdb.firebaseio.com",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('r');

    if (!roomId) {
        roomId = Math.random().toString(36).substring(2, 8);
        window.location.href = window.location.pathname + '?r=' + roomId;
    }
    document.getElementById('roomDisplay').innerText = "ğŸ”— " + roomId;

    let playerId = localStorage.getItem('codenames_playerId');
    if (!playerId) {
        playerId = Math.random().toString(36).substring(2, 6);
        localStorage.setItem('codenames_playerId', playerId);
    }

    sessionStorage.setItem('playerId', playerId);

    const roomRef = ref(db, `rooms/${roomId}`);
    const playersRef = ref(db, `rooms/${roomId}/players`);
    const myPlayerRef = ref(db, `rooms/${roomId}/players/${playerId}`);
    const settingsRef = ref(db, `rooms/${roomId}/settings`);

const avatarImages = [
    'img/avatar_snow_man.webp',
    'img/avatar_little_girl.webp',
    'img/avatar_old_man.webp',
    'img/avatar_women.webp'
];

function renderAvatars() {
    const container = document.getElementById('avatarContainer');
    container.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø£ÙˆÙ„Ø§Ù‹

    avatarImages.forEach((src, index) => {
        const img = document.createElement('img');
        img.src = src;
        img.className = 'avatar-option';
        
        // Ø¬Ø¹Ù„ Ø£ÙˆÙ„ ØµÙˆØ±Ø© Ù…Ø®ØªØ§Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (ÙƒÙ…Ø§ ÙÙŠ ØªØµÙ…ÙŠÙ…Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ)
        if (index === 0) {
            img.classList.add('selected');
        }

        // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù†Ù‚Ø±
        img.onclick = function() {
            selectAvatar(this);
        };

        container.appendChild(img);
    });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', renderAvatars);
function areImagesCached() {
    for (let src of avatarImages) {
        let img = new Image();
        img.src = src;
        if (!img.complete) return false;
    }
    return true;
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¨Ù‚ (ØªØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)
function preloadImages() {
    const promises = avatarImages.map(src => {
        return new Promise((resolve) => {
            const img = new Image();
            img.src = src;
            img.onload = resolve;
            img.onerror = resolve; 
        });
    });
    return Promise.all(promises);
}
const cardVisuals = {
    'blue': ['img/card/Blue1.webp', 'img/card/Blue2.webp'],
    'red': ['img/card/Red1.webp', 'img/card/Red2.webp'],
    'killer': ['img/card/Black.webp'],
    'neutral': ['img/card/Normal1.webp', 'img/card/Normal2.webp']
};

// 2. Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
let shuffledPools = { 'blue': [], 'red': [], 'killer': [], 'neutral': [] };
let lastUsedImages = { 'blue': null, 'red': null, 'killer': null, 'neutral': null };

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ù„Ø· (Helper Function)
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// 4. Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ©
function getNextImageFromPool(type) {
    if (shuffledPools[type].length === 0) {
        let newPool = [...cardVisuals[type]];
        shuffleArray(newPool);
        
        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø©
        if (newPool.length > 1 && newPool[newPool.length - 1] === lastUsedImages[type]) {
            [newPool[newPool.length - 1], newPool[0]] = [newPool[0], newPool[newPool.length - 1]];
        }
        shuffledPools[type] = newPool;
    }
    
    let img = shuffledPools[type].pop();
    lastUsedImages[type] = img;
    return img;
}

    window.copyRoomLink = () => {
        navigator.clipboard.writeText(window.location.href);
        alert("âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©ØŒ Ø£Ø±Ø³Ù„Ù‡ Ù„Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ!");
    };

    let myData = {
        id: playerId,
        name: "",
        avatar: "img/avatar_snow_man.webp",
        team: "spectators-list",
        joinedAt: Date.now()
    };
    let isAdmin = false;
    let hasJoined = false;

    window.selectAvatar = (el) => {
        document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
        el.classList.add('selected');
        myData.avatar = "img/" + el.src.split('/').pop();
    };

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø§Ø· Ø§Ù„ØºØ±ÙØ© Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± (Ù…ÙˆØ¯ØŒ Ù…Ø¤Ù‚ØªØŒ Ø§Ù†Ø¶Ù…Ø§Ù…)
function updateRoomActivity() {
    update(roomRef, { lastActivity: Date.now() });
}

window.saveProfile = async () => {
    const name = document.getElementById('nicknameInput').value.trim();
    if (!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ");
    
    myData.name = name;
    hasJoined = true;
    document.getElementById('profileModal').style.display = 'none';

    const now = Date.now();
    
    // ÙØ­Øµ Ù‡Ù„ Ø§Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŸ
    const roomSnap = await get(roomRef);
    if (!roomSnap.exists()) {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø· Ù‡Ù†Ø§
        await set(roomRef, {
            lastActivity: now,
            status: "lobby",
            settings: { mode: 'online', timer: 0 } // Ø£ØµØ¨Ø­Øª ØµÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
        });
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù†Ø­Ø¯Ø« Ù†Ø´Ø§Ø·Ù‡Ø§ ÙÙ‚Ø·
        updateRoomActivity();
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨
    await set(myPlayerRef, {
        ...myData,
        lastActive: now
    });

    startHeartbeat(); // Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø¨Ø¶Ø§Øª Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØºØ±ÙØ© Ù†Ø´Ø·Ø©
};

function updateServer() {
    if (!hasJoined) return;
    set(myPlayerRef, {
        ...myData,
        lastActive: Date.now()
    });
    updateRoomActivity(); // ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø§Ø· Ø§Ù„ØºØ±ÙØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
}

window.openProfileSettings = () => {
    document.getElementById('profileHeader').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ";
    const input = document.getElementById('nicknameInput');
    input.value = myData.name;
    document.getElementById('leaveRoomBtn').style.display = 'block';
    document.getElementById('profileModal').style.display = 'flex';
    
    // Ø³Ø·Ø± Ø§Ù„ÙÙˆÙƒØ³ Ø§Ù„Ù…Ø¶Ø§Ù
    setTimeout(() => input.focus(), 50); 
};
    window.leaveLobby = () => {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ")) {
            remove(myPlayerRef).then(() => {
                location.href = 'index.html';
            });
        }
    };

    window.joinTeam = (teamId) => {
        if (!hasJoined) return;
        if (teamId === 'spectators-list') {
            myData.team = teamId;
            updateServer();
            return;
        }
        runTransaction(playersRef, (players) => {
            if (players) {
                const isTaken = Object.values(players).some(p => p.team === teamId && p.id !== playerId);
                if (isTaken) {
                    return;
                }
            }
            if (!players) players = {};
            if (!players[playerId]) players[playerId] = myData;
            players[playerId].team = teamId;
            myData.team = teamId;
            return players;
        });
    };


window.setGameMode = (mode) => {
    if (!isAdmin) return;
    update(settingsRef, { mode: mode });
    updateRoomActivity(); // Ø³Ø¬Ù„ Ù†Ø´Ø§Ø·
};
    window.openTimerModal = () => {
        if (isAdmin) document.getElementById('timerModal').style.display = 'flex';
    };

window.changeTimer = (val) => {
    if (!isAdmin) return;
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± (0-3) Ø¥Ù„Ù‰ Ø«ÙˆØ§Ù†ÙŠ Ø­Ù‚ÙŠÙ‚ÙŠØ©
    const secondsMap = [0, 30, 60, 120]; 
    const seconds = secondsMap[val];
    
    // Ù†Ø­Ø¯Ø« ÙÙ‚Ø· Ø±Ù‚Ù… Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    update(settingsRef, { timer: seconds });
    updateRoomActivity();
};
    
function generateBoard() {
    const words = ["Ø£Ø³Ø¯", "Ø´Ù…Ø³", "ÙƒØªØ§Ø¨", "Ø·Ø§Ø¦Ø±Ø©", "Ù‚Ù„Ù…", "Ø¨Ø­Ø±", "ØªÙØ§Ø­Ø©", "Ø³Ø§Ø¹Ø©", "Ù†Ø¬Ù…", "Ø¬Ø¨Ù„", "Ù†Ù‡Ø±", "Ø³ÙŠØ§Ø±Ø©", "Ù‡Ø§ØªÙ", "Ù‚Ù…Ø±", "Ø´Ø¬Ø±Ø©", "ÙˆØ±Ù‚Ø©", "Ù…ÙØªØ§Ø­", "Ø¨Ø§Ø¨", "Ù†Ø§ÙØ°Ø©", "ÙƒØ±Ø©", "Ø­Ø§Ø³ÙˆØ¨", "Ù‚Ù‡ÙˆØ©", "Ø®Ø¨Ø²", "Ù…Ù„Ùƒ", "Ø¹Ø·Ø´"];
    
    // Ø®Ù„Ø· Ø§Ù„ÙƒÙ„Ù…Ø§Øª
    const shuffledWords = [...words];
    shuffleArray(shuffledWords);
    
    const types = ["killer", ...Array(8).fill("red"), ...Array(8).fill("blue"), ...Array(7).fill("neutral")];
    types.push("blue"); // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¯Ø¦

    // Ø®Ù„Ø· Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
    shuffleArray(types);

    const board = [];
    for (let i = 0; i < 25; i++) {
        const currentType = types[i];
        board.push({
            word: shuffledWords[i],
            type: currentType,
            revealed: false,
            // Ù‡Ù†Ø§ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹
            visual: getNextImageFromPool(currentType) 
        });
    }
    return board;
}
    // --- ÙˆØ¸ÙŠÙØ© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ---
window.handleStartGame = async () => {
    if (!isAdmin) return;

    const gameRef = ref(db, `rooms/${roomId}/game`);
    const snap = await get(gameRef);

    if (!snap.exists()) {
        await set(gameRef, {
            board: generateBoard(),
            turn: { 
                team: "red", 
                phase: "spymaster", 
                updatedAt: Date.now() // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§ Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ ÙˆÙ‚Øª Ù„Ø£ÙˆÙ„ Ø¯ÙˆØ±
            },
            scores: { red: 0, blue: 0 },
            remaining: { red: 8, blue: 9 }
        });
    }

    await update(ref(db, `rooms/${roomId}`), {
        status: "started"
    });

    window.location.href = `game_multiplayer.html?r=${roomId}&p=${playerId}`;
};


    onValue(playersRef, (snapshot) => {
        const players = snapshot.val();
        if (!players) return;
        const playerList = Object.values(players);
        document.getElementById('playerCount').innerText = playerList.length;
        const sorted = playerList.sort((a, b) => a.joinedAt - b.joinedAt);
        const adminId = sorted[0].id;
        isAdmin = (playerId === adminId);
        document.getElementById('startBtn').style.display = isAdmin ? 'block' : 'none';
        const adminElements = document.querySelectorAll('.settings-panel');
        adminElements.forEach(el => el.style.opacity = isAdmin ? "1" : "0.5");
        renderLobby(players, adminId);
    });

onValue(settingsRef, (snapshot) => {
    const s = snapshot.val();
    if (!s || s.timer === undefined) return;

    // 1. ØªØ­Ø¯ÙŠØ« ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨Ø©
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
    if (s.mode) {
        const activeCard = document.getElementById('mode-' + s.mode);
        if(activeCard) activeCard.classList.add('active');
    }

    // 2. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©)
    const seconds = s.timer;
    const displayTimer = document.getElementById('lobbyDisplayTimer');
    const mainTimerText = document.getElementById('mainTimerText');
    const mainTimerIcon = document.getElementById('mainTimerIcon');
    const modalTimerText = document.getElementById('modalTimerText');
    const modalTimerIcon = document.getElementById('modalTimerIcon');

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    let label = "Ø¨Ø¯ÙˆÙ†";
    let icon = "ğŸš«";
    let displayStr = "";

    if (seconds > 0) {
        icon = seconds === 30 ? "âš¡" : (seconds === 60 ? "â±ï¸" : "ğŸ¢");
        label = seconds < 60 ? `${seconds} Ø«Ø§Ù†ÙŠØ©` : `${seconds / 60} Ø¯Ù‚ÙŠÙ‚Ø©`;
        displayStr = seconds === 30 ? "00:30" : (seconds === 60 ? "01:00" : "02:00");
        displayTimer.style.display = 'block';
    } else {
        displayTimer.style.display = 'none';
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    mainTimerText.innerText = label;
    mainTimerIcon.innerText = icon;
    modalTimerText.innerText = label;
    modalTimerIcon.innerText = icon;
    displayTimer.innerText = displayStr;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ÙˆÙ…ÙƒØ§Ù† Ø§Ù„ØªÙ…ÙŠÙŠØ² (0, 30, 60, 120) -> (0, 1, 2, 3)
    const valMap = { 0: 0, 30: 1, 60: 2, 120: 3 };
    const sliderVal = valMap[seconds];
    document.getElementById('timerSlider').value = sliderVal;

    for(let i=0; i<4; i++) {
        const lbl = document.getElementById('label'+i);
        if(lbl) lbl.className = (i == sliderVal ? 'active-label' : '');
    }
});

    function renderLobby(players, adminId) {
        const containers = {
            'spectators-list': document.getElementById('spectators-list'),
            'blue-operative': document.getElementById('blue-operative'),
            'blue-spymaster': document.getElementById('blue-spymaster'),
            'red-operative': document.getElementById('red-operative'),
            'red-spymaster': document.getElementById('red-spymaster')
        };
        Object.values(containers).forEach(c => { if(c) c.innerHTML = ''; });
        document.querySelectorAll('.join-btn:not([onclick*="spectators"])').forEach(b => {
            b.innerText = "Ø§Ù†Ø¶Ù…Ø§Ù…"; b.className = "join-btn"; b.disabled = false;
        });
        Object.values(players).forEach(p => {
            const isMe = p.id === playerId;
            const isPlayerAdmin = p.id === adminId;
            const html = `
                <div class="player-slot">
                    <div class="player-avatar-wrap ${isPlayerAdmin ? 'is-admin' : ''}">
                        <img src="${p.avatar}" class="player-img" style="${isMe ? 'border: 2px solid #7ed321' : ''}">
                    </div>
                    <div class="player-name">${p.name} ${isMe ? '(Ø£Ù†Øª)' : ''}</div>
                </div>`;
            const target = containers[p.team];
            if (target) {
                target.insertAdjacentHTML('beforeend', html);
                if (p.team !== 'spectators-list') {
                    const btn = document.getElementById('btn-' + p.team);
                    if (btn) { btn.innerText = "Ù…Ù†Ø¶Ù…"; btn.classList.add('locked'); btn.disabled = true; }
                }
            }
        });
    }
const statusRef = ref(db, `rooms/${roomId}/status`);

onValue(statusRef, snap => {
    if (snap.val() === "started") {
        window.location.href = `game_multiplayer.html?r=${roomId}&p=${playerId}`;
    }
});
// Ø¹Ù…Ù„ ÙÙˆÙƒØ³ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        document.getElementById('nicknameInput').focus();
    }, 100); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
});
document.getElementById('nicknameInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        saveProfile();
    }
});

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØºØ±Ù Ø§Ù„Ù…Ù‡Ø¬ÙˆØ±Ø©
async function vacuumCleaner() {
    const allRoomsRef = ref(db, `rooms`);
    try {
        const snapshot = await get(allRoomsRef);
        if (!snapshot.exists()) return;

        const now = Date.now();
        const TEN_MINUTES = 10 * 60 * 1000;
        const rooms = snapshot.val();

        for (const id in rooms) {
            const room = rooms[id];
            // Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ø¥Ø°Ø§: Ù…Ø± 10 Ø¯Ù‚Ø§Ø¦Ù‚ + Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù… ØªØ¨Ø¯Ø£
            if (room.lastActivity && (now - room.lastActivity > TEN_MINUTES)) {
                if (room.status !== "started") {
                    console.log(`ØªÙ… Ø­Ø°Ù ØºØ±ÙØ© ØºÙŠØ± Ù†Ø´Ø·Ø©: ${id}`);
                    remove(ref(db, `rooms/${id}`));
                }
            }
            // Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØºØ±ÙØ© ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ù‚Ù„ lastActivity (ØºØ±Ù Ù‚Ø¯ÙŠÙ…Ø©)
            else if (!room.lastActivity) {
                remove(ref(db, `rooms/${id}`));
            }
        }
    } catch (e) { console.error("Vacuum failed:", e); }
}

// Ù†Ø¨Ø¶Ø§Øª Ø§Ù„Ù‚Ù„Ø¨: ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø§Ø· Ø§Ù„ØºØ±ÙØ© ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† Ø·Ø§Ù„Ù…Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ØªÙˆØ§Ø¬Ø¯
function startHeartbeat() {
    setInterval(() => {
        if (hasJoined && isAdmin) { // Ø§Ù„Ø¢Ø¯Ù…Ù† ÙÙ‚Ø· ÙŠØ­Ø¯Ø« Ù†Ø´Ø§Ø· Ø§Ù„ØºØ±ÙØ© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            updateRoomActivity();
        }
    }, 120000); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙƒÙ†Ø³Ø© ÙÙˆØ± Ø¯Ø®ÙˆÙ„ Ø£ÙŠ Ø´Ø®Øµ Ù„Ù„Ø±Ø§Ø¨Ø· (Ø­ØªÙ‰ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù…Ù‡)
vacuumCleaner();
</script>
</body>
</html>