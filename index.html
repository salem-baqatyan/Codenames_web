<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codenames Pro - Lobby</title>
    <style>
        :root {
            --bg-dark: #000000;
            --panel-bg: #1a1a1a;
            --blue-team: #3498db;
            --red-team: #e74c3c;
            --green-action: #4caf50;
            --text-gray: #aaaaaa;
            --modal-bg: #2a2a2a;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { 
            margin: 0; 
            background-color: var(--bg-dark); 
            color: white; 
            display: flex; 
            justify-content: center; 
            height: 100vh; 
            overflow: hidden; 
        }

        .mobile-wrapper {
            width: 100%; 
            max-width: 450px; 
            height: 100vh; 
            background: #000;
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid #333; 
            border-right: 1px solid #333;
            position: relative;
        }

        /* ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© */
        .top-section { height: 50vh; display: flex; flex-direction: column; padding-bottom: 5px; }
        .bottom-section { height: 50vh; display: flex; flex-direction: column; border-top: 1px solid #222; }
        /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± (Scrollbar) Ù„ÙƒÙ„ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª */
        .settings-modal::-webkit-scrollbar {
            width: 5px; /* Ø¬Ø¹Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ù†Ø­ÙŠÙ Ø¬Ø¯Ø§Ù‹ */
        }

        .settings-modal::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2); /* Ø®Ù„ÙÙŠØ© Ù…Ø³Ø§Ø± Ø§Ù„ØªÙ…Ø±ÙŠØ± */
            border-radius: 10px;
        }

        .settings-modal::-webkit-scrollbar-thumb {
            background: var(--green-action); /* Ù„ÙˆÙ† Ø§Ù„Ù…Ù‚Ø¨Ø¶ Ù†ÙØ³ Ù„ÙˆÙ† Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø®Ø¶Ø± */
            border-radius: 10px;
        }

        /* Ù„Ù…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù…Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¨Ø´ÙƒÙ„ Ù…ÙØ§Ø¬Ø¦ ÙˆØªØºÙŠÙŠØ± Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© */
        .settings-modal {
            scrollbar-gutter: stable;
            padding-right: 10px; /* Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø±Ø§Ø­Ø© Ø§Ù„Ø¹ÙŠÙ† */
        }

        /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ù€ Accordion Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø·ÙˆÙŠÙ„ */
        .accordion-content {
            max-height: 300px; /* ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© */
            overflow-y: auto;
        }
.top-bar { 
    display: flex; 
    justify-content: space-between; /* ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨ÙŠÙ† Ø§Ù„ÙŠÙ…ÙŠÙ† ÙˆØ§Ù„ÙŠØ³Ø§Ø± */
    align-items: center; 
    padding: 10px 15px; 
    flex-shrink: 0; 
}

.top-left {
    display: flex;
    align-items: center;
}

.top-right { 
    display: flex; 
    flex-direction: row; /* Ø¬Ø¹Ù„Ù‡Ù… Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶ */
    gap: 8px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    align-items: center; 
}
        .icon-circle {
            width: 40px; height: 40px; background: rgba(255,255,255,0.1);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 0.5px solid white; cursor: pointer;
        }

.btn-pill {
    background: rgba(255,255,255,0.1); 
    border: 1px solid #444;
    padding: 6px 12px; 
    border-radius: 20px; 
    font-size: 0.75rem;
    display: flex; 
    align-items: center; 
    gap: 5px; 
    cursor: pointer;
    margin-bottom: 0; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªÙ‚Ø§Ù…Ø© */
}

        .spectators-section { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 0 15px; flex-shrink: 0; }
        .spectators-list { display: flex; gap: 10px; justify-content: center; align-items: center; min-height: 65px; }

        .settings-panel {
            background: #1a1a1a; margin: 5px 15px; border-radius: 15px;
            padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .panel-label { text-align: center; color: #888; font-size: 0.65rem; font-weight: bold; margin-bottom: 15px; }

        .mode-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mode-card {
            background: #252525; border-radius: 10px; padding: 6px;
            display: flex; align-items: center; gap: 8px; border: 2px solid transparent; cursor: pointer;
            transition: 0.3s;
        }
        .mode-card.active { border-color: #3498db; background: #1e3a5f; }
        .mode-img { width: 30px; height: 40px; border-radius: 4px; pointer-events: none; }
        .mode-info { pointer-events: none; }
        .mode-info b { font-size: 0.65rem; display: block; }
        .mode-info span { font-size: 0.55rem; color: #aaa; }

        .setting-row {
            background: rgba(255,255,255,0.05); border-radius: 10px;
            margin-top: 8px; display: flex; align-items: center;
            padding: 6px 12px; border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }

        .teams-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 6px; padding: 10px 15px; }
        .team-box { border-radius: 15px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 8px; border: 1.5px solid rgba(255, 255, 255, 0.3); }
        .blue-box { background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%); }
        .red-box { background: linear-gradient(135deg, #7b241c 0%, #e74c3c 100%); }
        .box-title { font-size: 0.6rem; font-weight: 800; color: white; letter-spacing: 1px; }

        .player-slot-container { min-height: 55px; display: flex; align-items: center; justify-content: center; }
        .join-btn {
            width: 85%; padding: 4px 0; font-size: 0.65rem; font-weight: bold;
            color: white; background: linear-gradient(to bottom, #7ed321, #417505);
            border: 1.5px solid #b8e986; border-radius: 15px; cursor: pointer;
            box-shadow: 0 2px 0 #2e5a03;
        }

        .player-slot { display: flex; flex-direction: column; align-items: center; }
        .player-avatar-wrap { width: 40px; height: 40px; position: relative; }
        .player-img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid #fff; background: #333; }
        .player-name { background: rgba(0,0,0,0.7); font-size: 0.6rem; padding: 1px 6px; border-radius: 5px; margin-top: -5px; z-index: 2; }
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ§Ø¬ Ù„Ù„Ø¢Ø¯Ù…Ù† */
.player-avatar-wrap.is-admin::after {
    content: "ğŸ‘‘";
    position: absolute;
    top: -12px;
    right: -5px;
    font-size: 1.2rem;
    z-index: 10;
}
/* ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¯ÙˆØ± Ù…Ø´ØºÙˆÙ„Ø§Ù‹ */
.join-btn.locked {
    background: #555 !important;
    border-color: #777 !important;
    box-shadow: none !important;
    cursor: not-allowed;
    opacity: 0.7;
}
        .footer { padding: 10px 15px; background: #000; height: 30%;}
        .start-btn {
            width: 100%; height: 45px; font-size: 1.1rem; font-weight: 900;
            color: white; background: linear-gradient(to bottom, #7ed321, #417505);
            border: 2px solid #b8e986; border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 0 #2e5a03;
        }

        .join-spectators-btn { background: transparent; border: 1.5px solid #fff; color: #fff; padding: 3px 12px; border-radius: 15px; font-size: 0.7rem; cursor: pointer; }

        /* --- Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .settings-modal {
            width: 90%; max-height: 85%; background: var(--modal-bg); border-radius: 20px; padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 1px solid #444; position: relative;
            overflow-y: auto;
        }
        .close-icon { position: absolute; top: 15px; left: 15px; cursor: pointer; font-size: 1.2rem; color: #888; z-index: 10; }
        .modal-header { font-size: 1rem; font-weight: bold; margin-bottom: 15px; text-align: center; text-transform: uppercase; }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ (Accordion) --- */
        .rules-intro { font-size: 0.75rem; text-align: center; color: #ccc; margin-bottom: 20px; line-height: 1.4; }
        .accordion-item { margin-bottom: 8px; border-radius: 12px; overflow: hidden; }
        .accordion-header {
            background: var(--accordion-bg); padding: 12px 15px; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; transition: 0.3s; font-weight: bold; font-size: 0.85rem;
        }
        .accordion-header:hover { background: #333; }
        .accordion-header.active { background: var(--green-action); color: white; }
        .accordion-content {
            background: #1e1e1e; display: none; padding: 15px; font-size: 0.75rem; line-height: 1.6; color: #ddd;
            border: 1px solid #333; border-top: none; border-radius: 0 0 12px 12px;
        }
        .accordion-content ul { padding-right: 20px; margin: 0; }
        .accordion-content li { margin-bottom: 8px; }
        .accordion-header span:last-child {
            transition: transform 0.3s;
        }
        .accordion-header.active span:last-child {
            transform: rotate(180deg);
        }

        .log-row { display: flex; width: 100%; align-items: center; gap: 5px; }
        .row-blue { justify-content: flex-start; flex-direction: row-reverse; } 
        .row-red { justify-content: flex-start; flex-direction: row; } 

        .log-clue-item { display: flex; align-items: center; gap: 4px; border-radius: 5px; padding: 2px 4px; border: 1px solid rgba(255,255,255,0.2); width: 100%; }
        .log-clue-blue { background: #3498db; flex-direction: row-reverse; }
        .log-clue-red { background: #e74c3c; flex-direction: row; }
        
        .log-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid; }
        .log-text-clue { font-weight: bold; color: black; background: white; border-radius: 3px; padding: 1px 4px; width: 100%; text-align: center; font-size: 1rem;}
        .log-num-circle { width: 30px; height: 30px; background: white; border-radius: 50%; color: black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; flex-shrink: 0;}

        .log-guess-item { display: flex; align-items: center; gap: 4px; }
        .log-guess-text { padding: 1px 6px; border-radius: 4px; font-weight: bold; color: white; font-size: 0.55rem; }
        .bg-blue { background: #3498db; } .bg-red { background: #e74c3c; } .bg-brown { background: #d2b48c; } .bg-black { background: #000; color: white !important; }

        /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚Øª (Slider) --- */
        .timer-display { text-align: center; margin-bottom: 20px; }
        .timer-icon { font-size: 2.5rem; display: block; margin-bottom: 5px; }
        .timer-status { font-size: 0.8rem; color: #fff; font-weight: bold; }
        .slider-container { width: 100%; padding: 10px 0; }
        .timer-slider {
            width: 100%; -webkit-appearance: none; appearance: none; background: #444;
            height: 4px; border-radius: 2px; outline: none;
        }
        .timer-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px;
            background: #7ed321; border-radius: 50%; cursor: pointer; border: 2px solid white;
        }
        .slider-labels { display: flex; justify-content: space-between; margin-top: 10px; }
        .slider-labels span { font-size: 0.55rem; color: #888; }
        .slider-labels span.active-label { color: #7ed321; font-weight: bold; }

        /* --- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ --- */
        .setting-item { margin-bottom: 20px; }
        .setting-item label { display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 8px; }
        .nickname-input { width: 100%; background: #1a1a1a; border: 1px solid #444; color: white; padding: 10px; border-radius: 10px; font-size: 0.9rem; outline: none; }
        .avatar-selector { display: flex; gap: 10px; overflow-x: auto; padding: 5px; }
        .avatar-option { width: 50px; height: 50px; border-radius: 50%; border: 2px solid white; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .avatar-option.selected { border-color: #7ed321; transform: scale(1.1); }
        .leave-btn { width: 100%; background: #c62828; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 0.9rem; }
        .close-modal-btn { width: 100%; background: #444; color: white; border: none; padding: 10px; border-radius: 12px; cursor: pointer; margin-top: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="mobile-wrapper">
        <div class="modal-overlay" id="profileModal">
        <div class="settings-modal">
            <div class="modal-header">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
            <div class="setting-item">
                <label>Ø§Ù„Ù„Ù‚Ø¨ (Nickname)</label>
                <input type="text" id="nicknameInput" class="nickname-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." value="Player">
            </div>
            <div class="setting-item">
                <label>Ø§Ø®ØªØ± ØµÙˆØ±ØªÙƒ</label>
                <div class="avatar-selector">
                    <img src="img/avatar_snow_man.webp" class="avatar-option selected" onclick="selectAvatar(this)">
                    <img src="img/avatar_women.webp" class="avatar-option" onclick="selectAvatar(this)">
                    <img src="img/avatar_old_man.webp" class="avatar-option" onclick="selectAvatar(this)">
                    <img src="img/avatar_little_girl.webp" class="avatar-option" onclick="selectAvatar(this)">
                </div>
            </div>
            <button class="leave-btn" onclick="leaveMatch()">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            <button class="close-modal-btn" onclick="toggleProfileModal(false)">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>


    <div class="modal-overlay" id="timerModal">
        <div class="settings-modal">
            <span class="close-icon" onclick="toggleTimerModal(false)">âœ•</span>
            <div class="modal-header">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚Øª</div>
            <div class="timer-display">
                <span class="timer-icon" id="modalTimerIcon">ğŸš«</span>
                <span class="timer-status" id="modalTimerText">Ø¨Ø¯ÙˆÙ† Ù…Ø¤Ù‚Øª</span>
            </div>
            <div class="slider-container">
                <input type="range" min="0" max="3" value="0" class="timer-slider" id="timerSlider" oninput="updateTimerValue(this.value)">
                <div class="slider-labels">
                    <span id="label0" class="active-label">Ø¨Ø¯ÙˆÙ†</span>
                    <span id="label1">Ø³Ø±ÙŠØ¹</span>
                    <span id="label2">Ù…ØªÙˆØ³Ø·</span>
                    <span id="label3">Ø¨Ø·ÙŠØ¡</span>
                </div>
            </div>
        </div>
    </div>

<div class="top-section">
    <div class="top-bar">
        <div class="top-left">
            <div class="icon-circle">
                <span style="font-size: 0.8rem; font-weight: bold; margin-left: 2px;">1</span> ğŸ‘¥
            </div>
        </div>

        <div class="top-right">
            <div class="btn-pill" onclick="toggleRulesModal(true)">ğŸ“ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯</div>
            <div class="icon-circle" onclick="toggleProfileModal(true)">âš™ï¸</div>
        </div>
    </div>

        <div class="spectators-section">
            <div class="spectators-header">
                <span class="view-icon">ğŸ‘ï¸</span>
                <span class="box-title">Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</span>
            </div>
            <div class="spectators-list" id="spectators-list">
                <div class="player-slot" id="main-player">
                    <div class="player-avatar-wrap">
                        <img src="img/avatar_snow_man.webp" id="currentAvatarImg" class="player-img">
                    </div>
                    <div class="player-name" id="currentPlayerName">Player</div>
                </div>
                <button class="join-spectators-btn" onclick="joinTeam(this, 'spectators-list')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
        </div>

        <div class="settings-panel">
            <div class="panel-label">Ø£Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
            <div class="mode-options">
                <div class="mode-card active" onclick="selectMode(this)">
                    <img src="img/local.webp" class="mode-img">
                    <div class="mode-info"><b>Ø§ÙˆÙÙ„Ø§ÙŠÙ†</b><span>4+ Ù„Ø§Ø¹Ø¨ÙŠÙ†</span></div>
                </div>
                <div class="mode-card" onclick="selectMode(this)">
                    <img src="img/online.webp" class="mode-img">
                    <div class="mode-info"><b>Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†</b><span>4+ Ù„Ø§Ø¹Ø¨ÙŠÙ†</span></div>
                </div>
            </div>
            <div class="setting-row" onclick="toggleTimerModal(true)">
                <span style="font-size: 1.2rem;" id="mainTimerIcon">ğŸš«</span>
                <div style="margin-right: 10px;">
                    <b style="font-size: 0.7rem; display: block;">Ø§Ù„Ù…Ø¤Ù‚Øª</b>
                    <span style="font-size: 0.55rem; color: #888;" id="mainTimerText">Ø¨Ø¯ÙˆÙ†</span>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="teams-grid">
            <div class="team-box blue-box">
                <div class="box-title">OPERATIVES</div>
                <div class="player-slot-container"></div>
                <button class="join-btn" onclick="joinTeam(this, 'blue-op')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box red-box">
                <div class="box-title">OPERATIVES</div>
                <div class="player-slot-container"></div>
                <button class="join-btn" onclick="joinTeam(this, 'red-op')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box blue-box">
                <div class="box-title">SPYMASTERS</div>
                <div class="player-slot-container"></div>
                <button class="join-btn" onclick="joinTeam(this, 'blue-spy')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
            <div class="team-box red-box">
                <div class="box-title">SPYMASTERS</div>
                <div class="player-slot-container"></div>
                <button class="join-btn" onclick="joinTeam(this, 'red-spy')">Ø£Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
        </div>
        <div class="footer">
            <button class="start-btn" onclick="goToIndex()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>
    </div>
</div>

<script>
    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ
    let currentTeam = 'spectators-list';
    let currentAvatar = "img/avatar_snow_man.webp";
    let currentNickname = "Player";

    // 1. ÙˆØ¸ÙŠÙØ© ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±ÙŠÙ‚
    function joinTeam(clickedBtn, teamId) {
        currentTeam = teamId;
        if (window.updatePlayerOnServer) {
            window.updatePlayerOnServer();
        }
    }

    // 2. ÙˆØ¸ÙŠÙØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙØ§ØªØ§Ø±
    function selectAvatar(imgElement) {
        document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
        imgElement.classList.add('selected');
        currentAvatar = imgElement.src.split('/').pop(); // Ù†Ø£Ø®Ø° Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø·
        currentAvatar = "img/" + currentAvatar;
        
        document.getElementById('currentAvatarImg').src = currentAvatar;
        
        if (window.updatePlayerOnServer) {
            window.updatePlayerOnServer();
        }
    }
let isAdmin = false; // Ù…ØªØºÙŠØ± Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ø¢Ø¯Ù…Ù†

function toggleProfileModal(show) {
    const modal = document.getElementById('profileModal');
    modal.style.display = show ? 'flex' : 'none';
    if (!show) {
        const inputVal = document.getElementById('nicknameInput').value;
        if (inputVal.trim() !== "") {
            currentNickname = inputVal;
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±
            document.getElementById('currentPlayerName').innerText = currentNickname;
            if (window.updatePlayerOnServer) {
                window.updatePlayerOnServer();
            }
        }
    }
}

// ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¸ÙŠÙØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¯ Ù„ØªÙƒÙˆÙ† Ù„Ù„Ø¢Ø¯Ù…Ù† ÙÙ‚Ø·
function selectMode(element, modeType) {
    if(!isAdmin) return; // Ù…Ù†Ø¹ ØºÙŠØ± Ø§Ù„Ø¢Ø¯Ù…Ù†
    if (window.updateGameSettings) {
        window.updateGameSettings({ mode: modeType });
    }
}
function toggleTimerModal(show) {
    document.getElementById('timerModal').style.display = show ? 'flex' : 'none';
}

function updateTimerValue(val) {
    const config = timerConfigs[val];
    document.getElementById('modalTimerText').innerText = config.label;
    document.getElementById('modalTimerIcon').innerText = config.icon;
    document.getElementById('mainTimerText').innerText = config.main;
    document.getElementById('mainTimerIcon').innerText = config.icon;
    for(let i=0; i<=3; i++) {
        document.getElementById('label'+i).classList.remove('active-label');
    }
    document.getElementById('label'+val).classList.add('active-label');
}

    function goToIndex() { window.location.href = "game.html"; }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, onDisconnect, update, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

    const firebaseConfig = { /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ ÙƒÙ…Ø§ Ù‡ÙŠ */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('r') || Math.random().toString(36).substring(2, 8);
    if (!urlParams.get('r')) window.history.pushState({}, '', '?r=' + roomId);

    let playerId = sessionStorage.getItem('codenames_playerId') || Math.random().toString(36).substring(2, 6);
    sessionStorage.setItem('codenames_playerId', playerId);

    const playersRef = ref(db, `rooms/${roomId}/players`);
    const myPlayerRef = ref(db, `rooms/${roomId}/players/${playerId}`);
    const settingsRef = ref(db, `rooms/${roomId}/settings`);

    // --- 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ø¯Ù…Ù† ---
    onValue(playersRef, (snapshot) => {
        const players = snapshot.val();
        if (!players) return;
        
        // Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª) ÙŠØµØ¨Ø­ Ø§Ù„Ø¢Ø¯Ù…Ù†
        const sortedIds = Object.keys(players).sort((a, b) => players[a].joinedAt - players[b].joinedAt);
        const adminId = sortedIds[0];
        isAdmin = (playerId === adminId);

        // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¢Ø¯Ù…Ù†
        document.querySelector('.start-btn').style.display = isAdmin ? 'block' : 'none';
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        document.querySelector('.top-left b, .top-left span').innerText = Object.keys(players).length;

        renderLobby(players, adminId);
    });

    // --- 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…) ---
    window.updatePlayerOnServer = async function() {
        const snapshot = await get(myPlayerRef);
        const existingData = snapshot.val() || {};
        
        set(myPlayerRef, {
            id: playerId,
            name: currentNickname,
            avatar: currentAvatar,
            team: currentTeam,
            joinedAt: existingData.joinedAt || Date.now(),
            lastActive: Date.now()
        });
    };

    // --- 3. Ù‚ÙÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    function renderLobby(players, adminId) {
        const playersArray = Object.values(players);
        
        // ØªØµÙÙŠØ± Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
        document.querySelectorAll('.player-slot-container').forEach(c => c.innerHTML = '');
        document.getElementById('spectators-list').querySelectorAll('.player-slot').forEach(p => p.remove());
        document.querySelectorAll('.join-btn').forEach(btn => {
            btn.innerText = "Ø£Ù†Ø¶Ù…Ø§Ù…";
            btn.classList.remove('locked');
            btn.disabled = false;
        });

        playersArray.forEach(player => {
            const isMe = player.id === playerId;
            const isPlayerAdmin = player.id === adminId;
            const playerHtml = `
                <div class="player-slot">
                    <div class="player-avatar-wrap ${isPlayerAdmin ? 'is-admin' : ''}">
                        <img src="${player.avatar}" class="player-img" style="${isMe ? 'border: 2px solid #7ed321;' : ''}">
                    </div>
                    <div class="player-name">${player.name} ${isMe ? '(Ø£Ù†Øª)' : ''}</div>
                </div>`;

            if (player.team === 'spectators-list') {
                document.getElementById('spectators-list').insertAdjacentHTML('afterbegin', playerHtml);
            } else {
                const teamsMap = { 'blue-op': 0, 'red-op': 1, 'blue-spy': 2, 'red-spy': 3 };
                const index = teamsMap[player.team];
                const container = document.querySelectorAll('.player-slot-container')[index];
                container.innerHTML = playerHtml;
                
                // Ù‚ÙÙ„ Ø§Ù„Ø²Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±
                const btn = container.nextElementSibling; // Ø§Ù„Ø²Ø± ÙŠØªØ¨Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
                btn.innerText = "Ù…Ù†Ø¶Ù…";
                btn.classList.add('locked');
                btn.disabled = true;
            }
        });
    }

    // --- 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù„Ù„Ù…ÙˆØ¯) ---
    window.updateGameSettings = function(newSettings) {
        update(settingsRef, newSettings);
    };

    onValue(settingsRef, (snapshot) => {
        const settings = snapshot.val();
        if (!settings) return;
        // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¯ Ù„Ù„Ø¬Ù…ÙŠØ¹
        const cards = document.querySelectorAll('.mode-card');
        cards.forEach(card => card.classList.remove('active'));
        if (settings.mode === 'online') cards[1].classList.add('active');
        else cards[0].classList.add('active');
    });

    onDisconnect(myPlayerRef).remove();
    setInterval(() => update(myPlayerRef, { lastActive: Date.now() }), 20000);
    window.updatePlayerOnServer();
</script></body>
</html>