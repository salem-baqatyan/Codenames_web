<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codenames Pro - Multiplayer</title>
    <style>
        /* ÿßŸÑÿ≥ÿ™ÿßŸäŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸÖÿπ ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ¨ŸÖŸáŸàÿ± */
        :root { --bg-color: #0d1117; --blue-glow: 0 0 20px #3498db; --red-glow: 0 0 20px #e74c3c;}
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .loader { border: 4px solid #333; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: 'Tahoma', sans-serif; }
        .mobile-wrapper { width: 100%; max-width: 450px; height: 100%; margin: 0 auto; background-color: var(--bg-color); display: flex; flex-direction: column; border-left: 1px solid #333; border-right: 1px solid #333; position: relative; }
        
        .timer-badge { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); background: #000; color: #ff3e3e; border: 1px solid #ff3e3e; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; z-index: 100; font-family: monospace; }
        
        .dashboard { height: 30%; display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 5px; padding: 10px; flex-shrink: 0; }
        .team-side { display: flex; flex-direction: column; gap: 4px; }
        .player-card { flex: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); background: #222; transition: 0.3s; position: relative; overflow: hidden;}
        .blue-team .player-card { background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%); }
        .red-team .player-card { background: linear-gradient(135deg, #7b241c 0%, #e74c3c 100%); }
        .role-title { position: absolute; top: 2px; font-size: 0.45rem; color: rgba(255,255,255,0.8); font-weight: bold; text-transform: uppercase; }
        .active-blue { box-shadow: var(--blue-glow); border: 2px solid white !important; transform: scale(1.05); }
        .active-red { box-shadow: var(--red-glow); border: 2px solid white !important; transform: scale(1.05); }
        
        .score { font-size: 1.5rem; font-weight: 900; text-align: center; color: white; }
        .avatar-img { width: 32px; height: 32px; border-radius: 50%; border: 1.5px solid white; object-fit: cover; }
        .player-name { font-size: 0.55rem; color: white; font-weight: bold; margin-top: 2px; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 2px;}
        
        .game-log-container { background: #1a1a1a; border-radius: 10px; border: 1px solid #333; padding: 5px; display: flex; flex-direction: column; overflow: hidden;}
        #log-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; gap: 5px; padding: 2px; }
        
        /* ÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ */
        .log-row { display: flex; align-items: center; gap: 4px; font-size: 0.6rem; }
        .clue-tag { background: white; color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex: 1; text-align: center; }
        .num-tag { background: #444; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        .grid-container { height: 57%; display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); gap: 4px; padding: 8px; }
        .card { border-radius: 5px; padding: 2px; cursor: pointer; position: relative; display: flex; flex-direction: column; }
        .card-main-body { flex: 1; border-radius: 3px; border: 1px solid; display: flex; flex-direction: column; overflow: hidden; }
        .bottom-box { margin-top: auto; height: 40%; background: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: white; font-weight: bold; }
        
        .card-hidden { background: #fbe0c3 !important; }
        .card-hidden .card-main-body { background: #f7cda3 !important; border-color: #9a7452 !important; }
        .card-hidden .bottom-box { color: #5d4037 !important; }

        .card-blue { background: #3498db; } .card-red { background: #e74c3c; } .card-brown { background: #d2b48c; } .card-black { background: #000; }
        .card-revealed .card-reveal-img { opacity: 1; }
        .card-reveal-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: 0.3s; z-index: 2; border-radius: 3px;}

        .control-area { height: 13%; background: #111; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #333; }
        .clue-input { flex: 1; background: #fff; border: none; border-radius: 20px; padding: 8px 15px; font-weight: bold; }
        .send-btn { width: 50px; height: 50px; border-radius: 50%; background: #4caf50; display: flex; align-items: center; justify-content: center; border: none; color: white; cursor: pointer;}
        .disabled-area { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        
        /* ÿ≤ÿ± ÿßŸÑÿ™ÿ£ŸÉŸäÿØ */
        .confirm-btn { position: absolute; top: -5px; right: -5px; background: #4caf50; border: 2px solid white; border-radius: 50%; width: 20px; height: 20px; z-index: 10; display: none; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="loader"></div>
    <div id="loading-text">ÿ¨ÿßÿ±Ÿä ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸÑÿπÿ®ÿ©...</div>
</div>

<div class="mobile-wrapper">
    <div id="turn-timer" class="timer-badge">00:30</div>

    <div class="dashboard">
        <div class="team-side blue-team">
            <div class="player-card" id="blue-op">
                <span class="role-title">Operative</span>
                <div class="avatar-box"></div>
                <div class="player-name">...</div>
            </div>
            <div class="score" id="blue-score">0</div>
            <div class="player-card" id="blue-spy">
                <span class="role-title">Spymaster</span>
                <div class="avatar-box"></div>
                <div class="player-name">...</div>
            </div>
        </div>

        <div class="game-log-container">
            <div id="log-content"></div>
        </div>

        <div class="team-side red-team">
            <div class="player-card" id="red-op">
                <span class="role-title">Operative</span>
                <div class="avatar-box"></div>
                <div class="player-name">...</div>
            </div>
            <div class="score" id="red-score">0</div>
            <div class="player-card" id="red-spy">
                <span class="role-title">Spymaster</span>
                <div class="avatar-box"></div>
                <div class="player-name">...</div>
            </div>
        </div>
    </div>

    <div class="grid-container" id="grid"></div>

    <div class="control-area" id="control-area">
        <input type="text" id="clueInput" class="clue-input" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑÿ™ŸÑŸÖŸäÿ≠...">
        <select id="clueNum" style="padding: 8px; border-radius: 10px;">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="‚àû">‚àû</option>
        </select>
        <button class="send-btn" onclick="handleAction()">GO</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC95r_D7FVO-cynZ-gK6zbldvvrY4HD2YQ",
        authDomain: "codenames-5fd71.firebaseapp.com",
        projectId: "codenames-5fd71",
        databaseURL: "https://codenames-5fd71-default-rtdb.firebaseio.com",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('r');
    const playerId = sessionStorage.getItem('codenames_playerId');

    if (!roomId) window.location.href = 'index.html';

    const gameRef = ref(db, `rooms/${roomId}/gameState`);
    const playersRef = ref(db, `rooms/${roomId}/players`);
    const statusRef = ref(db, `rooms/${roomId}/status`);

    let gameState = null;
    let myRole = 'audience';
    let allPlayers = {};
    let timerInt = null;

    // 1. ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ ŸàÿßŸÑÿ£ÿØŸàÿßÿ±
    onValue(playersRef, (snap) => {
        allPlayers = snap.val() || {};
        const me = allPlayers[playerId];
        if (me) {
            myRole = me.team;
        } else {
            myRole = 'audience';
        }
        updatePlayersUI();
    });

    // 2. ŸÖÿ≤ÿßŸÖŸÜÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©
    onValue(gameRef, (snap) => {
        gameState = snap.val();
        if (gameState) {
            renderGrid();
            updateGameUI();
            resetTimer();
            document.getElementById('loading-screen').style.display = 'none';
        }
    });

    // 3. ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ© (ÿ•ÿ∞ÿß ÿπÿßÿØÿ™ ŸÑŸÑŸàÿ®Ÿä)
    onValue(statusRef, (snap) => {
        if (snap.val()?.state === 'lobby') {
            window.location.href = `index.html?r=${roomId}`;
        }
    });

    function updatePlayersUI() {
        // ÿ™ŸÅÿ±Ÿäÿ∫ Ÿàÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ ÿßŸÑÿ£ÿ≥ÿßÿ≥ŸäŸäŸÜ
        ['blue-op', 'blue-spy', 'red-op', 'red-spy'].forEach(id => {
            const card = document.getElementById(id);
            const player = Object.values(allPlayers).find(p => p.team === id);
            if (player) {
                card.querySelector('.player-name').innerText = player.name;
                card.querySelector('.avatar-box').innerHTML = `<img src="${player.avatar}" class="avatar-img">`;
            }
        });
    }

    function renderGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        // ÿßŸÑÿ¨ŸÖŸáŸàÿ± ŸàŸÇÿßÿØÿ© ÿßŸÑŸÖÿÆÿßÿ®ÿ±ÿßÿ™ Ÿäÿ±ŸàŸÜ ÿßŸÑÿ£ŸÑŸàÿßŸÜ
        const isSpymasterView = myRole.includes('spy') || myRole === 'audience' || myRole.includes('spectators');

        gameState.cards.forEach((card, i) => {
            const div = document.createElement('div');
            const isRevealed = card.revealed;
            const cardType = card.type; // 'card-blue', etc.

            div.className = `card ${(!isRevealed && !isSpymasterView) ? 'card-hidden' : cardType} ${isRevealed ? 'card-revealed' : ''}`;
            
            div.innerHTML = `
                <div class="confirm-btn" id="confirm-${i}"></div>
                <img src="${card.visual || ''}" class="card-reveal-img">
                <div class="card-main-body">
                    <div class="bottom-box">${card.word}</div>
                </div>
            `;

            // ÿ™ŸÅÿßÿπŸÑ ÿßŸÑÿπŸÖŸÑÿßÿ° ŸÅŸÇÿ∑ ŸÅŸä ÿØŸàÿ±ŸáŸÖ
            if (!isRevealed && myRole === `${gameState.turn}-op` && gameState.phase === 'operative') {
                div.onclick = () => selectCard(i);
            }

            grid.appendChild(div);
        });
    }

    function selectCard(index) {
        document.querySelectorAll('.confirm-btn').forEach(b => b.style.display = 'none');
        const btn = document.getElementById(`confirm-${index}`);
        btn.style.display = 'block';
        btn.onclick = (e) => {
            e.stopPropagation();
            processGuess(index);
        };
    }

    function processGuess(index) {
        const card = gameState.cards[index];
        const team = gameState.turn;
        
        let updates = {};
        const newCards = [...gameState.cards];
        newCards[index].revealed = true;
        updates['cards'] = newCards;

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜŸÇÿßÿ∑
        let newScores = {...gameState.scores};
        if (card.type === 'card-blue') newScores.blue--;
        if (card.type === 'card-red') newScores.red--;
        updates['scores'] = newScores;

        // ÿßŸÑÿ≥ÿ¨ŸÑ
        const logEntry = { type: 'guess', word: card.word, team: team, result: card.type };
        updates['logs'] = [...(gameState.logs || []), logEntry];

        // ŸÖŸÜÿ∑ŸÇ ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿØŸàÿ±
        const isCorrect = (card.type === `card-${team}`);
        if (!isCorrect || card.type === 'card-black') {
            updates['turn'] = team === 'blue' ? 'red' : 'blue';
            updates['phase'] = 'spy';
        }
        
        update(gameRef, updates);
        
        if (card.type === 'card-black' || newScores.blue === 0 || newScores.red === 0) {
            setTimeout(endGame, 2000);
        }
    }

    window.handleAction = () => {
        if (gameState.phase === 'spy') {
            const val = document.getElementById('clueInput').value.trim();
            const num = document.getElementById('clueNum').value;
            if (!val) return;
            
            const logEntry = { type: 'clue', word: val, num: num, team: gameState.turn };
            update(gameRef, {
                phase: 'operative',
                logs: [...(gameState.logs || []), logEntry]
            });
            document.getElementById('clueInput').value = '';
        } else {
            // ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿØŸàÿ± ŸäÿØŸàŸäÿßŸã ŸÑŸÑÿπŸÖŸäŸÑ
            update(gameRef, {
                turn: gameState.turn === 'blue' ? 'red' : 'blue',
                phase: 'spy'
            });
        }
    };

    function updateGameUI() {
        document.getElementById('blue-score').innerText = gameState.scores.blue;
        document.getElementById('red-score').innerText = gameState.scores.red;

        // ÿ™ŸÖŸäŸäÿ≤ ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑŸÜÿ¥ÿ∑
        document.querySelectorAll('.player-card').forEach(c => c.classList.remove('active-blue', 'active-red'));
        const activeId = `${gameState.turn}-${gameState.phase === 'spy' ? 'spy' : 'op'}`;
        const activeCard = document.getElementById(activeId);
        if (activeCard) activeCard.classList.add(gameState.turn === 'blue' ? 'active-blue' : 'active-red');

        // ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÑÿ∫Ÿäÿ± ÿµÿßÿ≠ÿ® ÿßŸÑÿØŸàÿ± ŸàÿßŸÑÿ¨ŸÖŸáŸàÿ±
        const isMyTurn = (myRole === activeId);
        document.getElementById('control-area').className = isMyTurn ? 'control-area' : 'control-area disabled-area';
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ¨ŸÑ
        renderLogs();
    }

    function renderLogs() {
        const container = document.getElementById('log-content');
        container.innerHTML = '';
        (gameState.logs || []).forEach(log => {
            const div = document.createElement('div');
            div.className = 'log-row';
            div.innerHTML = log.type === 'clue' ? 
                `<span class="num-tag">${log.num}</span><span class="clue-tag">${log.word}</span>` :
                `<div style="width:100%; text-align:center; color:#888;">üîç ÿßÿÆÿ™ÿßÿ±: ${log.word}</div>`;
            container.appendChild(div);
        });
    }

    function resetTimer() {
        clearInterval(timerInt);
        let timeLeft = 30; 
        timerInt = setInterval(() => {
            timeLeft--;
            document.getElementById('turn-timer').innerText = `00:${timeLeft < 10 ? '0' : ''}${timeLeft}`;
            if (timeLeft <= 0) {
                clearInterval(timerInt);
                if (myRole === `${gameState.turn}-${gameState.phase === 'spy' ? 'spy' : 'op'}`) {
                    handleAction(); // ÿ•ŸÜŸáÿßÿ° ÿ™ŸÑŸÇÿßÿ¶Ÿä
                }
            }
        }, 1000);
    }

    function endGame() {
        set(statusRef, { state: 'lobby', timestamp: Date.now() });
    }

</script>
</body>
</html>