<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codenames Pro - Game</title>
    <style>
        /* <!-- CSS Section --> */
        /* --- Global & Root --- */
        :root { --bg-color: #0d1117; --blue-glow: 0 0 20px #3498db; --red-glow: 0 0 20px #e74c3c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; height: 100dvh; overflow: hidden; background-color: #000; font-family: 'Tahoma', sans-serif; }

        /* --- Loading Screen --- */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .loader { border: 4px solid #333; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .timer-pulse { animation: pulse-red 1s infinite; font-weight: bold; }
        @keyframes pulse-red {
            0% { transform: translateX(-50%) scale(1); text-shadow: 0 0 0px red; }
            50% { transform: translateX(-50%) scale(1.1); text-shadow: 0 0 15px red; opacity: 0.8; }
            100% { transform: translateX(-50%) scale(1); text-shadow: 0 0 0px red; }
        }

        /* --- Main Wrapper --- */
        .mobile-wrapper {
            width: 100%; max-width: 450px; height: 100dvh; margin: 0 auto; overflow: hidden;
            background-color: var(--bg-color); display: flex; flex-direction: column;
            border-left: 1px solid #333; border-right: 1px solid #333; position: relative;
        }

        /* --- Custom Alert --- */
        .custom-alert { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; border: 2px solid #555; border-radius: 15px; padding: 20px; text-align: center; z-index: 1000; color: white; display: none; width: 85%; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .alert-btns { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .alert-btn { padding: 8px 15px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; }
        .btn-ok { background: #7ed321; color: white; }
        .btn-cancel { background: #d0021b; color: white; }

        /* --- Top Bar --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; flex-shrink: 0; user-select: none; -webkit-user-select: none; }
        .top-left, .top-right { display: flex; gap: 8px; align-items: center; }
        .top-timer { color: white; font-size: 1.5rem; font-weight: 900; font-family: 'Courier New', Courier, monospace; position: absolute; left: 50%; transform: translateX(-50%); text-shadow: 0 0 10px rgba(255, 0, 0, 0.3); }
        .icon-circle { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 0.5px solid white; cursor: pointer; color: white; }
        .btn-pill { background: rgba(255,255,255,0.1); border: 1px solid #444; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; cursor: pointer; color: white; }

        /* --- Dashboard & Teams --- */
        .dashboard { height: 30%; min-height: 160px; display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 5px; padding: 0px 10px 10px 10px; flex-shrink: 0; }
        .team-side { display: flex; flex-direction: column; gap: 4px; }
        .player-card { flex: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); background: #222; transition: 0.3s; position: relative; }
        .blue-team .player-card { background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%); }
        .red-team .player-card { background: linear-gradient(135deg, #7b241c 0%, #e74c3c 100%); }
        .role-title { position: absolute; top: 3px; font-size: 0.5rem; color: rgba(255,255,255,0.6); font-weight: bold; }
        .avatar-img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid white; object-fit: cover; background: rgba(0,0,0,0.3); }
        .player-name { font-size: 0.55rem; color: white; margin-top: 0px; font-weight: bold; }
        .active-blue { box-shadow: var(--blue-glow); border: 2px solid white !important; }
        .active-red { box-shadow: var(--red-glow); border: 2px solid white !important; }
        .score { font-size: 1.5rem; font-weight: 900; text-align: center; color: white; display: flex; align-items: center; justify-content: center;}

        /* --- Game Log --- */
        .game-log-container { background: #333; border-radius: 10px; border: 1px solid #555; padding: 5px; overflow: hidden; display: flex; flex-direction: column; }
        #log-content { flex: 1; background: #2a2a2a; border-radius: 4px; font-size: 0.6rem; overflow-y: auto; color: white; padding: 5px; display: flex; flex-direction: column-reverse; gap: 8px; scrollbar-width: none; }
        .log-row { display: flex; width: 100%; align-items: center; gap: 5px; }
        .row-blue { justify-content: flex-start; flex-direction: row; } 
        .row-red { justify-content: flex-end; flex-direction: row; } 
        .log-clue-item { display: flex; align-items: center; gap: 4px; border-radius: 5px; padding: 2px 4px; border: 1px solid rgba(255,255,255,0.2); width: 100%; }
        .log-clue-blue { background: #3498db; flex-direction: row; }
        .log-clue-red { background: #e74c3c; flex-direction: row-reverse; }
        .log-avatar { width: 18px; height: 18px; border-radius: 50%; border: 2px solid; }
        .log-text-clue { font-weight: bold; color: black; background: white; border-radius: 3px; padding: 1px 4px; width: 100%; text-align: center; font-size: 0.55rem;}
        .log-num-circle { width: 16px; height: 16px; background: white; border-radius: 50%; color: black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.55rem; flex-shrink: 0;}
        .log-guess-item { display: flex; align-items: center; gap: 4px; }
        .row-blue .log-guess-item { flex-direction: row; }
        .row-red .log-guess-item { flex-direction: row-reverse; }
        .log-guess-text { padding: 1px 6px; border-radius: 4px; font-weight: bold; color: white; font-size: 0.55rem; }
        .bg-blue { background: #3498db; } .bg-red { background: #e74c3c; } .bg-brown { background: #d2b48c; } .bg-black { background: #000; color: white !important; }

        /* --- Game Grid --- */
        .grid-container { flex: 1; display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); gap: 4px; padding: 8px; flex-shrink: 0; min-height: 0; }
        .card { height: 100%; width: 100%; border-radius: 5px; padding: 2px; display: flex; cursor: pointer; position: relative; perspective: 1000px; }
        .card-selected { transform: scale(0.95); box-shadow: 0 0 10px #7ed321; }
        .confirm-btn { position: absolute; top: -5px; right: -5px; width: 22px; height: 22px; background: #7ed321; border: 2px solid white; border-radius: 50%; display: none; justify-content: center; align-items: center; z-index: 110; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .confirm-btn svg { width: 14px; height: 14px; fill: white; }

        /* --- Card Visuals & Reveal --- */
        .card-main-body { flex: 1; border-radius: 3px; display: flex; flex-direction: column; border: 1px solid; overflow: hidden; pointer-events: none; position: relative; }
        .bottom-box { margin-top: auto; height: 45%; display: flex; justify-content: center; align-items: center; font-size: 0.6rem; font-weight: bold; border-top: 1px solid; color: white; }
        .card-blue { background: #3ec1f3; } .card-blue .card-main-body { background: #19a8ff; border-color: #0b4d9b; } .card-blue .bottom-box { background: #0b4d9b; border-color: #3ec1f3; }
        .card-red { background: #ff8e7a; } .card-red .card-main-body { background: #ff6a4c; border-color: #8c2b1e; } .card-red .bottom-box { background: #8c2b1e; border-color: #ff8e7a; }
        .card-black { background: #7a7a7a; } .card-black .card-main-body { background: #444; border-color: #222; } .card-black .bottom-box { background: #1a1a1a; border-color: #7a7a7a; }
        .card-brown { background: #fbe0c3; } .card-brown .card-main-body { background: #f7cda3; border-color: #9a7452; } .card-brown .bottom-box { background: #9a7452; border-color: #fbe0c3; }
        .card-hidden { background: #fbe0c3 !important; } .card-hidden .card-main-body { background: #f7cda3 !important; border-color: #9a7452 !important; } .card-hidden .bottom-box { background: #9a7452 !important; border-color: #fbe0c3 !important; }
        .card-reveal-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; border-radius: 3px; opacity: 0; pointer-events: none; transform: translateY(-100%); transform-origin: top center; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-revealed:not(.already-revealed) .card-reveal-img { opacity: 1; pointer-events: auto; animation: pushFromTop 1s ease-out forwards; }
        .already-revealed .card-reveal-img { opacity: 1; pointer-events: auto; transform: translateY(0); }
        @keyframes pushFromTop { 0% { transform: translateY(-100%); opacity: 1; } 100% { transform: translateY(0); opacity: 1; } }
        .card-peeking .card-reveal-img { transform: rotateX(-55deg) translateY(-5px); z-index: 6; box-shadow: 0 15px 30px rgba(0,0,0,0.8); opacity: 1; pointer-events: auto; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .card.card-peeking { overflow: visible !important; z-index: 100 !important; }
        .card-revealed { cursor: default; }

        /* --- Control Panel --- */
        .control-area { height: 65px; background: #222; border-top: 1px solid #444; padding: 5px 15px; display: flex; align-items: center; flex-shrink: 0; }
        .clue-bar-layout { width: 100%; display: flex; align-items: center; gap: 8px; padding: 0 10px;}
        .clue-input-wrapper { flex: 1; background: white; border-radius: 20px; height: 35px; display: flex; align-items: center; padding: 0 12px; }
        .clue-input { width: 100%; border: none; outline: none; font-weight: bold; color: #333; text-align: center; font-size: 0.8rem; background: transparent; }
        .clue-select { width: 45px; height: 35px; border-radius: 50%; border: 2px solid #555; background: white; color: #19a8ff; font-weight: bold; text-align: center; appearance: none; outline: none; font-size: 0.9rem; transition: 0.3s; }
        .send-btn { width: 75px; height: 35px; background: linear-gradient(to bottom, #7ed321, #417505); border: 1.5px solid #b8e986; border-radius: 18px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 0 #2e5a03;}
        .end-turn-btn { background: linear-gradient(to bottom, #d0021b, #8b0000) !important; }
        .arrow-icon { width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid white; }
        .x-icon { color: white; font-weight: 900; font-size: 1.2rem; }

        /* --- Utilities --- */
        .disabled-area { opacity: 0.7; pointer-events: none; filter: grayscale(0.5); }
        .error-border { border-color: #ff0000 !important; box-shadow: 0 0 10px #ff0000; }
    </style>
</head>

<body>
<!-- HTML Section -->

<!-- Loading Screen -->
<div id="loading-screen">
    <div class="loader"></div>
    <div>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
</div>

<!-- App Wrapper -->
<div class="mobile-wrapper">

    <!-- Custom Alert Modal -->
    <div id="customAlert" class="custom-alert">
        <p id="alertMsg"></p>
        <div class="alert-btns">
            <button class="alert-btn btn-ok" id="alertOk">ŸÖŸàÿßŸÅŸÇ</button>
            <button class="alert-btn btn-cancel" id="alertCancel">ÿ•ŸÑÿ∫ÿßÿ°</button>
        </div>
    </div>

    <!-- App Bar -->
    <div class="top-bar">
        <div class="top-left">
            <div class="icon-circle">
                <span id="playerCount" style="font-size:0.8rem;font-weight:bold;margin-left:2px;">0</span> üë§
            </div>
            <div class="btn-pill" id="roomDisplay" onclick="copyRoomLink()">üîó ÿßŸÑÿ∫ÿ±ŸÅÿ©</div>
        </div>

        <div class="top-timer" id="lobbyDisplayTimer"></div>

        <div class="top-right">
            <div class="icon-circle" onclick="openProfileSettings()">‚öôÔ∏è</div>
        </div>
    </div>

    <!-- Teams Dashboard -->
    <div class="dashboard"> 
        <div class="team-side blue-team">
            <div class="player-card" id="blue-operative">
                <span class="role-title">Operatives</span>
                <div class="avatar-box"></div>
                <div class="player-name">‚Äî</div>
            </div>
            <div class="score" id="blue-score">0</div>
            <div class="player-card" id="blue-spymaster">
                <span class="role-title">Spymasters</span>
                <div class="avatar-box"></div>
                <div class="player-name">‚Äî</div>
            </div>
        </div>

        <div class="game-log-container">
            <div style="text-align:center;font-size:0.4rem;color:#aaa;margin-bottom:2px;">GAME LOG</div>
            <div id="log-content"></div>
        </div>

        <div class="team-side red-team">
            <div class="player-card" id="red-operative">
                <span class="role-title">Operatives</span>
                <div class="avatar-box"></div>
                <div class="player-name">‚Äî</div>
            </div>
            <div class="score" id="red-score">0</div>
            <div class="player-card" id="red-spymaster">
                <span class="role-title">Spymasters</span>
                <div class="avatar-box"></div>
                <div class="player-name">‚Äî</div>
            </div>
        </div>
    </div>

    <!-- Game Grid -->
    <div class="grid-container" id="grid"></div>

    <!-- Control Panel -->
    <div class="control-area">
        <div id="clue-ui" class="clue-bar-layout">
            <div class="clue-input-wrapper">
                <input type="text" id="clueInput" class="clue-input" placeholder="ÿßŸÉÿ™ÿ® ÿ™ŸÑŸÖŸäÿ≠">
            </div>
            <select id="clueNum" class="clue-select">
                <option value="-">-</option>
                <option value="0">0</option><option value="1">1</option><option value="2">2</option>
                <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                <option value="6">6</option><option value="7">7</option><option value="‚àû">‚àû</option>
            </select>
        </div>

        <div id="action-btn" class="send-btn" onclick="handleAction()">
            <div id="btn-icon" class="arrow-icon"></div>
        </div>
    </div>

</div>

<script type="module">
// <!-- JS Section -->

/* ---------- 1. Setup & Config ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, update, runTransaction, push } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyC95r_D7FVO-cynZ-gK6zbldvvrY4HD2YQ",
    authDomain: "codenames-5fd71.firebaseapp.com",
    databaseURL: "https://codenames-5fd71-default-rtdb.firebaseio.com",
    projectId: "codenames-5fd71",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const params = new URLSearchParams(window.location.search);
const roomId = params.get("r");
const playerId = params.get("p");

const roomRef = ref(db, `rooms/${roomId}`);
const gameRef = ref(db, `rooms/${roomId}/game`);
const playersRef = ref(db, `rooms/${roomId}/players`);
const statusRef = ref(db, `rooms/${roomId}/status`);
const logRef = ref(db, `rooms/${roomId}/game/log`);


/* ---------- 2. State & Assets ---------- */
const avatarImages = [
    "img/avatar/snowman.webp",
    "img/avatar/confused_woman.webp",
    "img/avatar/cool_girl.webp",
    "img/avatar/delivery_boy.webp",
    "img/avatar/laughing.webp",
    "img/avatar/old_man.webp",
    "img/avatar/photographer.webp",
    "img/avatar/pizza_guy.webp",
    "img/avatar/reader.webp",
    "img/avatar/surprised_man.webp",
];

const cardVisuals = {
    'card-blue': ['img/card/Blue1.webp', 'img/card/Blue2.webp'],
    'card-red': ['img/card/Red1.webp', 'img/card/Red2.webp'],
    'card-black': ['img/card/Black.webp'],
    'card-brown': ['img/card/Normal1.webp', 'img/card/Normal2.webp']
};

let myRole = null;      
let myTeam = null;      
let isSpy = false;
let isOperative = false;
let isSpectator = false;

let playersCache = {};
let gameState = null;   

let selectedCards = new Set();   
let guessesThisTurn = 0;

let turnStartTime = null; 
let timerDuration = 0;   
let timerInterval = null;
let serverTimeOffset = 0; 
let isPageLoaded = false; 
let peekingCards = new Set(); 

const allImagesToPreload = [
    ...avatarImages,
    ...cardVisuals['card-blue'],
    ...cardVisuals['card-red'],
    ...cardVisuals['card-black'],
    ...cardVisuals['card-brown']
];


/* ---------- 3. Profile Management ---------- */
const offsetRef = ref(db, ".info/serverTimeOffset");
onValue(offsetRef, (snap) => {
    serverTimeOffset = snap.val() || 0;
});

function startGameManager() {
    const loader = document.getElementById('loading-screen');
    const finishLoading = () => {
        loader.style.opacity = '0';
        setTimeout(() => {
            loader.style.display = 'none';
            isPageLoaded = true; 
            if (gameState) applyGameStateToUI(); 
        }, 300);
    };

    if (areImagesCached()) {
        finishLoading();
    } else {
        preloadImages().then(finishLoading);
    }
}
/* ---------- 3. Profile Management ---------- */
// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ≠ÿßŸÑÿ©
let hasJoined = false;
let myData = {
    id: playerId,
    name: localStorage.getItem('codenames_playerName') || "",
    avatar: localStorage.getItem('codenames_playerAvatar') || avatarImages[0],
    team: "spectators-list" // ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ŸÑŸÑŸÇÿßÿØŸÖŸäŸÜ ÿßŸÑÿ¨ÿØÿØ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÑÿπÿ®
};

// Ÿàÿ∏ŸäŸÅÿ© ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
async function checkProfile() {
    if (myData.name) {
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÑÿØŸäŸá ÿßÿ≥ŸÖ ŸÖÿÆÿ≤ŸÜ ŸÖÿ≥ÿ®ŸÇÿßŸãÿå ŸÜÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØŸá ŸÅŸä ÿßŸÑÿ∫ÿ±ŸÅÿ©
        const snap = await get(ref(db, `rooms/${roomId}/players/${playerId}`));
        if (snap.exists()) {
            document.getElementById('profileModal').style.display = 'none';
            hasJoined = true;
            startGameManager(); // ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÑÿπÿ®ÿ©
        } else {
            renderAvatars(); // ÿßŸÑŸÑÿßÿπÿ® ŸÖÿ≥ÿ¨ŸÑ ŸÖÿ≠ŸÑŸäÿßŸã ŸÑŸÉŸÜ ŸÑŸäÿ≥ ŸÅŸä ÿßŸÑÿ∫ÿ±ŸÅÿ© (ŸÜÿ∏Ÿáÿ± ÿßŸÑŸÖŸàÿØÿßŸÑ ŸÑŸÑÿ™ÿ£ŸÉŸäÿØ)
        }
    } else {
        renderAvatars(); // ŸÑÿßÿπÿ® ÿ¨ÿØŸäÿØ ÿ™ŸÖÿßŸÖÿßŸã
    }
}

// Ÿàÿ∏ŸäŸÅÿ© ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä (ŸÜŸÅÿ≥ ÿßŸÑÿ™Ÿä ŸÅŸä ÿßŸÑÿ±ÿØŸáÿ© ŸàŸÑŸÉŸÜ ŸÖÿπÿØŸÑÿ© ŸÑŸÑÿπÿ®ÿ©)
window.saveProfile = async () => {
    const nameInput = document.getElementById('nicknameInput');
    const name = nameInput.value.trim();
    if (!name) return alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ");

    myData.name = name;
    localStorage.setItem('codenames_playerName', name);
    localStorage.setItem('codenames_playerAvatar', myData.avatar);

    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÑÿßÿπÿ® ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿ¨ŸÖŸáŸàÿ±
    await update(ref(db, `rooms/${roomId}/players/${playerId}`), {
        id: playerId,
        name: myData.name,
        avatar: myData.avatar,
        team: "spectators-list",
        joinedAt: Date.now()
    });

    hasJoined = true;
    document.getElementById('profileModal').style.display = 'none';
    showToast("‚úÖ ÿ™ŸÖ ÿØÿÆŸàŸÑŸÉ ŸÉÿ¨ŸÖŸáŸàÿ±");
    startGameManager(); // ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ¢ŸÜ
};

// Ÿàÿ∏ŸäŸÅÿ© ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ± ŸÅŸä ÿßŸÑŸÖŸàÿØÿßŸÑ
function renderAvatars() {
    const container = document.getElementById('avatarContainer');
    container.innerHTML = '';
    avatarImages.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.className = 'avatar-option' + (myData.avatar === src ? ' selected' : '');
        img.onclick = () => {
            document.querySelectorAll('.avatar-option').forEach(i => i.classList.remove('selected'));
            img.classList.add('selected');
            myData.avatar = src;
        };
        container.appendChild(img);
    });
}


/* ---------- 4. Utility Helpers ---------- */
function areImagesCached() {
    for (let src of allImagesToPreload) {
        let img = new Image();
        img.src = src;
        if (!img.complete) return false;
    }
    return true;
}

function preloadImages() {
    const promises = allImagesToPreload.map(src => {
        return new Promise((resolve) => {
            const img = new Image();
            img.src = src;
            img.onload = resolve;
            img.onerror = resolve; 
        });
    });
    return Promise.all(promises);
}

function showCustomAlert(msg, showCancel = false, onOk = null) {
    const modal = document.getElementById('customAlert');
    document.getElementById('alertMsg').innerText = msg;
    modal.style.display = 'block';
    document.getElementById('alertCancel').style.display = showCancel ? 'block' : 'none';
    document.getElementById('alertOk').onclick = () => { modal.style.display = 'none'; if(onOk) onOk(); };
    document.getElementById('alertCancel').onclick = () => { modal.style.display = 'none'; };
}

window.copyRoomLink = () => {
    navigator.clipboard.writeText(window.location.href);
    showToast("‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ∫ÿ±ŸÅÿ©!");
};

function showToast(message) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: rgba(20, 20, 20, 0.95);
        color: #ddd;
        padding: 10px 18px;
        border-radius: 14px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid rgba(52, 152, 219, 0.6);
        box-shadow: 0 8px 20px rgba(0,0,0,.6);
        opacity: 0;
        transition: all .25s ease;
        z-index: 9999;
        pointer-events: none;
        backdrop-filter: blur(6px);
    `;
    document.body.appendChild(toast);
    requestAnimationFrame(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateX(-50%) translateY(0)";
    });
    setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateX(-50%) translateY(10px)";
        setTimeout(() => toast.remove(), 250);
    }, 1800);
}


/* ---------- 5. Lobby & Team Logic ---------- */
document.getElementById('roomDisplay').innerText = "üîó " + roomId;

onValue(playersRef, (snap) => {
    playersCache = snap.val() || {};
    const me = playersCache[playerId];
    if (!me) return;

    myRole = me.team;
    myTeam = myRole?.startsWith("blue") ? "blue" : myRole?.startsWith("red") ? "red" : null;
    isSpy = myRole?.endsWith("spymaster");
    isOperative = myRole?.endsWith("operative");
    isSpectator = myRole === "spectators-list";

    renderPlayersPanel();
});

function renderPlayersPanel() {
    const roleIds = ["blue-operative","blue-spymaster","red-operative","red-spymaster"];
    roleIds.forEach(r => {
        const card = document.getElementById(r);
        const box = card.querySelector(".avatar-box");
        const nameBox = card.querySelector(".player-name");
        const player = Object.values(playersCache).find(p => p.team === r);
        if (player) {
            box.innerHTML = `<img src="${player.avatar}" class="avatar-img">`;
            nameBox.textContent = player.name || "Player";
        } else {
            box.innerHTML = "";
            nameBox.textContent = "‚Äî";
        }
    });
    document.getElementById("playerCount").textContent = Object.keys(playersCache).length;
}


/* ---------- 6. Admin & Game Settings ---------- */
function startGlobalTimer(serverStartTime) {
    if (timerInterval) clearInterval(timerInterval);
    const timerDisplay = document.getElementById('lobbyDisplayTimer');
    if (!timerDisplay) return;
    timerDisplay.style.display = 'flex';

    timerInterval = setInterval(() => {
        const nowCorrected = Date.now() + serverTimeOffset;
        const elapsed = Math.floor((nowCorrected - serverStartTime) / 1000);
        let remaining = Math.max(timerDuration - elapsed, 0);

        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        timerDisplay.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        if (remaining <= 0) {
            clearInterval(timerInterval);
            timerDisplay.classList.remove('timer-pulse');
            const isMyTurn = myTeam === gameState.turn.team;
            const isMyPhase = (isSpy && gameState.turn.phase === 'spymaster') || 
                              (isOperative && gameState.turn.phase === 'operative');
            if (isMyTurn && isMyPhase) endTurn(); 
        } 

        if (remaining <= 10 && remaining > 0) {
            timerDisplay.style.color = "#ff4d4d";
            timerDisplay.classList.add('timer-pulse');
        } else {
            timerDisplay.style.color = "white";
            timerDisplay.classList.remove('timer-pulse');
        }
    }, 1000);
}


/* ---------- 7. Game Engine & Start ---------- */
onValue(gameRef, (snap) => {
    const data = snap.val();
    if (!data) return;
    gameState = data;
    applyGameStateToUI();
});

onValue(logRef, (snap) => {
    const logData = snap.val();
    if (logData && gameState) {
        gameState.log = logData; 
        renderLog(); 
    }
});

onValue(statusRef, (snap) => {
    const status = snap.val();
    if (status === "ended") {
        showCustomAlert("ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©!", false, () => {
            window.location.href = "index.html";
        });
    }
});

onValue(ref(db, `rooms/${roomId}/game/winner`), (snap) => {
    const winner = snap.val();
    if (!winner) return;
    showCustomAlert(`üéâ ŸÅÿßÿ≤ ÿßŸÑŸÅÿ±ŸäŸÇ ${winner === "blue" ? "ÿßŸÑÿ£ÿ≤ÿ±ŸÇ" : "ÿßŸÑÿ£ÿ≠ŸÖÿ±"}!`, false, async () => {
        await update(roomRef, { status: "ended" });
        window.location.href = "index.html";
    });
});

function applyGameStateToUI() {
    if (!gameState) return;
    if (gameState.turn.phase === "spymaster") {
        selectedCards.clear();
        guessesThisTurn = 0;
        document.getElementById('clueInput').value = '';
    }
    renderGrid();
    renderLog();
    updateUI();
    get(ref(db, `rooms/${roomId}/settings/timer`)).then((snap) => {
        const seconds = snap.val();
        const timerDisplay = document.getElementById('lobbyDisplayTimer');
        if (seconds && seconds > 0) {
            timerDuration = seconds;
            const isMyTurn = myTeam === gameState.turn.team;
            const isMyPhase = (isSpy && gameState.turn.phase === 'spymaster') || 
                              (isOperative && gameState.turn.phase === 'operative');
            if (isMyTurn && isMyPhase && !gameState.turn.ready) {
                update(gameRef, { "turn/ready": true, "turn/updatedAt": Date.now() + serverTimeOffset });
            }
            if (gameState.turn.ready) {
                startGlobalTimer(gameState.turn.updatedAt);
            } else {
                if(timerDisplay) timerDisplay.innerText = "00:00";
            }
        } else {
            if(timerDisplay) timerDisplay.style.display = 'none';
        }
    });
}

function renderGrid() {
    if (!gameState) return;
    const grid = document.getElementById('grid'); 
    const existingRevealed = Array.from(document.querySelectorAll('.card-revealed')).map(el => el.id);
    grid.innerHTML = '';
    Object.entries(gameState.board).forEach(([i, card]) => {
        i = Number(i);
        const div = document.createElement('div');
        const cardId = `card-${i}`;
        const isHidden = !card.revealed && !isSpy && !isSpectator;
        const isSelected = selectedCards.has(i);
        const isPeeking = peekingCards.has(i); 
        const visualClass =
            card.type === "blue" ? "card-blue" :
            card.type === "red" ? "card-red" :
            card.type === "killer" ? "card-black" :
            "card-brown";
        div.id = cardId;
        div.className = `card ${visualClass} ${card.revealed ? 'card-revealed' : ''} ${isSelected ? 'card-selected' : ''} ${isPeeking ? 'card-peeking' : ''}`;
        if (isHidden) div.classList.add('card-hidden');
        if (card.revealed && existingRevealed.includes(cardId)) div.classList.add('already-revealed');
        div.innerHTML = `
            <div class="confirm-btn" id="confirm-${i}" style="display: ${isSelected ? 'flex' : 'none'}" onclick="event.stopPropagation(); confirmSelection(${i});">
                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            </div>
            <img src="${card.visual}" class="card-reveal-img" onclick="togglePeek(${i}, event)">
            <div class="card-main-body"><div class="bottom-box">${card.word}</div></div>`;
        div.onclick = () => handleCardSelection(i);
        grid.appendChild(div);
    });
}

window.togglePeek = function(i, event) {
    event.stopPropagation();
    if (!gameState.board[i].revealed) return;
    if (peekingCards.has(i)) peekingCards.delete(i);
    else peekingCards.add(i);
    renderGrid();
};

function updateUI() {
    if (!gameState) return;
    document.getElementById('blue-score').innerText = gameState.remaining.blue;
    document.getElementById('red-score').innerText = gameState.remaining.red;
    document.querySelectorAll('.player-card').forEach(c => c.classList.remove('active-blue', 'active-red'));
    const activeId = `${gameState.turn.team}-${gameState.turn.phase}`;
    document.getElementById(activeId)?.classList.add(gameState.turn.team === 'blue' ? 'active-blue' : 'active-red');
    const controlArea = document.querySelector('.control-area');
    const clueUI = document.getElementById('clue-ui');
    const btn = document.getElementById('action-btn');
    const icon = document.getElementById('btn-icon');
    const input = document.getElementById('clueInput');
    const select = document.getElementById('clueNum');
    const isMyTurn = myTeam === gameState.turn.team;
    clueUI.style.display = 'none';
    btn.style.display = 'none';
    btn.classList.remove('end-turn-btn', 'disabled-area'); 
    controlArea.querySelector('.turn-info')?.remove();
    if (gameState.turn.phase === 'spymaster') {
        if (isSpy && isMyTurn) {
            clueUI.style.display = 'flex';
            btn.style.display = 'flex';
            input.disabled = false;
            select.disabled = false;
            icon.className = 'arrow-icon';
            icon.innerHTML = '';
            clueUI.classList.remove('disabled-area');
        } else showTurnInfo(controlArea, gameState.turn);
    } else {
        if (isOperative && isMyTurn) {
            clueUI.style.display = 'flex'; 
            clueUI.classList.add('disabled-area'); 
            btn.style.display = 'flex'; 
            btn.classList.add('end-turn-btn'); 
            btn.classList.toggle('disabled-area', !isMyTurn); 
            icon.className = 'x-icon'; 
            icon.innerHTML = '‚úï'; 
        } else showTurnInfo(controlArea, gameState.turn);
    }
}

function showTurnInfo(container, turn) {
    const div = document.createElement('div');
    div.className = 'turn-info';
    div.style.textAlign = 'center';
    div.style.width = '100%';
    div.style.opacity = '0.8';
    div.innerHTML = `<div style="font-size: 0.8rem; color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">ÿßŸÑÿØŸàÿ± ÿßŸÑÿ¢ŸÜ ÿπŸÜÿØ <b>${turn.team === 'blue' ? 'ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≤ÿ±ŸÇüîµ' : 'ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿ≠ŸÖÿ±üî¥'}</b><br>(${turn.phase === 'spymaster' ? 'ÿßŸÑŸÇÿßÿ¶ÿØ üë®üèª‚Äç‚úàÔ∏è' : 'ÿßŸÑÿπŸÖŸäŸÑ üïµÔ∏è'})</div>`;
    container.appendChild(div);
}

function renderLog() {
    const logContainer = document.getElementById('log-content');
    if (!logContainer || !gameState || !gameState.log) return;
    const logEntries = Object.values(gameState.log).sort((a, b) => b.at - a.at);
    logContainer.innerHTML = ''; 
    logEntries.forEach(entry => {
        let html = '';
        const isBlue = entry.team === 'blue';
        const rowClass = isBlue ? 'row-blue' : 'row-red';
        if (entry.type === "clue") {
            const clueClass = isBlue ? 'log-clue-blue' : 'log-clue-red';
            html = `<div class="log-row ${rowClass}"><div class="log-clue-item ${clueClass}"><img src="${entry.avatar}" class="log-avatar" style="border-color:#fff"><div class="log-text-clue">${entry.word}</div><div class="log-num-circle">${entry.count}</div></div></div>`;
        } else if (entry.type === "guess") {
            const colorClass = entry.cardColor === 'blue' ? 'bg-blue' : entry.cardColor === 'red' ? 'bg-red' : entry.cardColor === 'black' ? 'bg-black' : 'bg-brown';
            html = `<div class="log-row ${rowClass}"><div class="log-guess-item"><img src="${entry.avatar}" class="log-avatar" style="border-color:${isBlue ? '#3498db':'#e74c3c'}"><div class="log-guess-text ${colorClass}">${entry.word}</div></div></div>`;
        }
        logContainer.insertAdjacentHTML('beforeend', html);
    });
}

window.handleAction = function() {
    if (!gameState) return;
    const isMyTurn = myTeam === gameState.turn.team;
    if (gameState.turn.phase === 'spymaster') {
        if (!(isSpy && isMyTurn)) return;
        sendClue();
    } else {
        if (!(isOperative && isMyTurn)) return;
        if (guessesThisTurn === 0) showCustomAlert("Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿÆÿ™ÿßÿ± ÿ®ÿ∑ÿßŸÇÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÇÿ®ŸÑ ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿØŸàÿ±!. ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü", true, endTurn);
        else if (guessesThisTurn < gameState.clue.count) showCustomAlert(`ŸÑŸÖ ÿ™ŸÜŸáŸê ŸÖÿ≠ÿßŸàŸÑÿßÿ™ŸÉ ÿ®ÿπÿØ (${guessesThisTurn}/${gameState.clue.count}). ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü`, true, endTurn);
        else endTurn();
    }
};

async function sendClue() {
    const input = document.getElementById('clueInput');
    const clueValue = input.value.trim();
    const select = document.getElementById('clueNum');
    const input_wrapper = document.getElementsByClassName('clue-input-wrapper')[0];
    if (!clueValue) {
        input_wrapper.classList.add('error-border');
        setTimeout(() => input_wrapper.classList.remove('error-border'), 1000);
        return;
    }
    const onTableWords = Object.values(gameState.board).filter(c => !c.revealed).map(c => c.word.trim().toLowerCase());
    const clueWords = clueValue.toLowerCase().split(/\s+/);
    if (clueWords.some(w => onTableWords.includes(w))) {
        showCustomAlert("ÿÆÿ∑ÿ£! ÿßŸÑÿ™ŸÑŸÖŸäÿ≠ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ŸÉŸÑŸÖÿ© ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™.");
        return;
    }
    if (select.value === '-') {
        select.classList.add('error-border');
        setTimeout(() => select.classList.remove('error-border'), 1000);
        return;
    }
    const count = select.value === "‚àû" ? 25 : parseInt(select.value);
    const me = playersCache[playerId];
    await update(gameRef, { clue: { word: clueValue, count }, turn: { team: gameState.turn.team, phase: "operative", ready: false, updatedAt: null } });
    await push(ref(db, `rooms/${roomId}/game/log`), { type: "clue", team: gameState.turn.team, word: clueValue, count: select.value, avatar: me.avatar, at: Date.now() });
}

window.handleCardSelection = function(i) {
    if (!gameState || gameState.turn.phase !== 'operative' || !isOperative || myTeam !== gameState.turn.team || gameState.board[i].revealed) return;
    if (selectedCards.has(i)) selectedCards.delete(i);
    else selectedCards.add(i);
    renderGrid();
};

window.confirmSelection = async function(i) {
    if (!gameState || gameState.turn.phase !== 'operative' || !isOperative || myTeam !== gameState.turn.team || gameState.board[i].revealed || !selectedCards.has(i)) return;
    const card = gameState.board[i];
    const me = playersCache[playerId];
    const enemy = myTeam === "blue" ? "red" : "blue";
    let nextTurn = null;
    let winner = null;
    const updates = {};
    updates[`board/${i}/revealed`] = true;
    let remaining = { ...gameState.remaining };
    if (card.type === myTeam) remaining[myTeam]--;
    else if (card.type === enemy) { remaining[enemy]--; nextTurn = enemy; }
    else if (card.type === "neutral") nextTurn = enemy;
    else if (card.type === "killer") winner = enemy;
    updates.remaining = remaining;
    await push(ref(db, `rooms/${roomId}/game/log`), { type: "guess", team: myTeam, word: card.word, cardColor: card.type, avatar: me.avatar, at: Date.now() });
    guessesThisTurn++;
    selectedCards.delete(i);
    if (winner) {
        updates.winner = winner;
        await update(gameRef, updates);
        await update(roomRef, { status: "ended" });
        return;
    }
    if (nextTurn) {
        updates.turn = { team: nextTurn, phase: "spymaster", ready: false, updatedAt: null };
        updates.clue = { word: null, count: null };
        guessesThisTurn = 0;
        selectedCards.clear();
    }
    await update(gameRef, updates);
    renderGrid();
};

async function endTurn() {
    if (!gameState) return;
    const enemy = myTeam === "blue" ? "red" : "blue";
    await update(gameRef, { turn: { team: enemy, phase: "spymaster", ready: false, updatedAt: null }, clue: { word: null, count: null } });
    guessesThisTurn = 0;
    selectedCards.clear();
    const input = document.getElementById('clueInput');
    if(input) input.value = '';
}


/* ---------- Final: Bootstrap ---------- */
checkProfile();

</script>
</body>
</html>
