<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codenames Pro - Game</title>
    <style>
        /* <!-- CSS Section --> */
        /* --- Global & Root --- */

        :root { --bg-color: #0d1117; --blue-glow: 0 0 20px #3498db; --red-glow: 0 0 20px #e74c3c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; height: 100dvh; overflow: hidden; background-color: #000; font-family: 'Tahoma', sans-serif; }

        /* --- Loading Screen Styles --- */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #7ed321; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Main Wrapper --- */
        .mobile-wrapper {
            width: 100%; max-width: 450px; height: 100dvh; margin: 0 auto; overflow: hidden;
            background-color: var(--bg-color); display: flex; flex-direction: column;
            border-left: 1px solid #333; border-right: 1px solid #333; position: relative;
        }

        /* --- Custom Alert --- */
        .custom-alert { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.7); 
            background: #1a1a1a; border: 2px solid #555; border-radius: 20px; padding: 0; 
            text-align: center; z-index: 10000; color: white; display: none; width: 75%; 
            max-width: 320px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); opacity: 0; 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;
            overflow: hidden; user-select: none; -webkit-user-select: none;
        }

        .custom-alert.show-win { 
            display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); 
        }

        .alert-drag-handle {
            height: 35px; width: 100%; cursor: move; 
            display: flex; align-items: center; justify-content: center; 
            background: rgba(255,255,255,0.02);
            touch-action: none; 
        }
        .drag-indicator { width: 35px; height: 4px; background: #444; border-radius: 10px; }

        .alert-win { border-color: #7ed321 !important; }
        .alert-lose { border-color: #e74c3c !important; }
        .alert-body { padding: 10px 20px 20px 20px; font-size: 0.95rem; line-height: 1.5; }
        .alert-btns { display: flex; flex-direction: column; gap: 8px; padding: 0 20px 20px 20px; }
        .alert-btn { 
            padding: 10px; border-radius: 12px; cursor: pointer; border: none; 
            font-weight: bold; font-size: 0.85rem; transition: 0.2s; 
        }
        .alert-btn:active { transform: scale(0.95); }
        .btn-ok { background: linear-gradient(135deg, #7ed321 0%, #417505 100%); color: white; border: 1px solid #b8e986; }
        .btn-cancel { background: #333; color: #bbb; border: 1px solid #444; }

        /* --- Players List Modal & Mini Cards --- */
        #playersListModal {
            position: absolute; top: 60px; right: 15px; left: auto; width: 280px; height: auto;
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px; padding: 12px; z-index: 1100; display: none; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform-origin: top right; animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .players-modal-title { font-size: 0.7rem; font-weight: bold; color: #fff; text-align: right; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .horizontal-players-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 5px 2px 10px 2px; scrollbar-width: none; }
        .player-card-mini { display: flex; flex-direction: column; align-items: center; min-width: 50px; position: relative; user-select: none; }
        .player-avatar-mini-wrap { position: relative; width: 44px; height: 44px; }

        .is-admin-mini::after { content: "ğŸ‘‘"; position: absolute; top: -10px; left: -5px; font-size: 1.1rem; transform: rotate(-20deg); z-index: 10; }
        .avatar-frame { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 2px; border: 2px solid #fff; background: #333; overflow: hidden; }
        .mini-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .mini-name-tag { margin-top: -6px; font-size: 0.55rem; padding: 1px 7px; border-radius: 5px; color: white; background: rgba(0,0,0,0.8); z-index: 5; white-space: nowrap; border: 1px solid transparent; }

        .player-blue .avatar-frame { background: #1e3a5f !important; }
        .player-red .avatar-frame { background: #7b241c !important; }
        .player-red .avatar-frame { border-color: #e74c3c !important; background: #7b241c !important; }
        .player-spec .avatar-frame { border-color: rgba(255,255,255,0.4) !important; background: #222 !important; }
        .is-me-mini .mini-name-tag { border: 1.5px solid #7ed321 !important; box-shadow: 0 0 5px rgba(126, 211, 33, 0.5); }

        /* --- Top Bar --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 10px; flex-shrink: 0; user-select: none; -webkit-user-select: none; }
        .top-left, .top-right { display: flex; gap: 8px; align-items: center; }
        .top-timer { color: white; font-size: 1.5rem; font-weight: 900; font-family: 'Courier New', Courier, monospace; position: absolute; left: 50%; transform: translateX(-50%); text-shadow: 0 0 10px rgba(255, 0, 0, 0.3); }
        .icon-circle { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 0.5px solid white; cursor: pointer; color: white; }
        .btn-pill { background: rgba(255,255,255,0.1); border: 1px solid #444; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; cursor: pointer; color: white; }

        /* --- Dashboard & Teams --- */
        .dashboard { 
            height: 30%; min-height: 160px; display: grid; grid-template-columns: 1fr 1.2fr 1fr; 
            gap: 5px; padding: 0px 10px 10px 10px; flex-shrink: 0; position: relative; 
            transition: background 0.8s ease; background: #0d1117;
        }

        .turn-blue-operative {
            background: radial-gradient(circle at top right, rgba(52, 152, 219, 0.4) 0%, transparent 70%);
        }

        .turn-blue-spymaster {
            background: radial-gradient(circle at bottom right, rgba(52, 152, 219, 0.4) 0%, transparent 70%);
        }

        .turn-red-operative {
            background: radial-gradient(circle at top left, rgba(231, 76, 60, 0.4) 0%, transparent 70%);
        }

        .turn-red-spymaster {
            background: radial-gradient(circle at bottom left, rgba(231, 76, 60, 0.4) 0%, transparent 70%);
        }
        .team-side { display: flex; flex-direction: column; gap: 4px; }
        .player-card { flex: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); background: #222; transition: 0.3s; position: relative; }
        .blue-team .player-card { background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%); }
        .red-team .player-card { background: linear-gradient(135deg, #7b241c 0%, #e74c3c 100%); }
        .role-title { position: absolute; top: 3px; font-size: 0.5rem; color: rgba(255,255,255,0.6); font-weight: bold; }
        .avatar-img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid white; object-fit: cover; background: rgba(0,0,0,0.3); }
        .player-name { font-size: 0.55rem; color: white; margin-top: 0px; font-weight: bold; }
        .active-blue { box-shadow: var(--blue-glow); border: 2px solid white !important; }
        .active-red { box-shadow: var(--red-glow); border: 2px solid white !important; }
        .score { font-size: 1.5rem; font-weight: 900; text-align: center; color: white; display: flex; align-items: center; justify-content: center;}

        /* --- Game Log --- */
        .game-log-container { background: #333; border-radius: 10px; border: 1px solid #555; padding: 5px; overflow: hidden; display: flex; flex-direction: column; }
        #log-content { flex: 1; background: #2a2a2a; border-radius: 4px; font-size: 0.6rem; overflow-y: auto; color: white; padding: 5px; display: flex; flex-direction: column-reverse; gap: 8px; scrollbar-width: none; }
        .log-row { display: flex; width: 100%; align-items: center; gap: 5px; }
        .row-blue { justify-content: flex-start; flex-direction: row; } 
        .row-red { justify-content: flex-end; flex-direction: row; } 
        .log-clue-item { display: flex; align-items: center; gap: 4px; border-radius: 5px; padding: 2px 4px; border: 1px solid rgba(255,255,255,0.2); width: 100%; }
        .log-clue-blue { background: #3498db; flex-direction: row; }
        .log-clue-red { background: #e74c3c; flex-direction: row-reverse; }
        .log-avatar { width: 18px; height: 18px; border-radius: 50%; border: 2px solid; }
        .log-text-clue { font-weight: bold; color: black; background: white; border-radius: 3px; padding: 1px 4px; width: 100%; text-align: center; font-size: 0.55rem;}
        .log-num-circle { width: 16px; height: 16px; background: white; border-radius: 50%; color: black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.55rem; flex-shrink: 0;}
        .log-guess-item { display: flex; align-items: center; gap: 4px; }
        .row-blue .log-guess-item { flex-direction: row; }
        .row-red .log-guess-item { flex-direction: row-reverse; }
        .log-guess-text { padding: 1px 6px; border-radius: 4px; font-weight: bold; color: white; font-size: 0.55rem; }
        .bg-blue { background: #3498db; } .bg-red { background: #e74c3c; } .bg-brown { background: #d2b48c; } .bg-black { background: #000; color: white !important; }

        /* --- Game Grid --- */
        .grid-container { flex: 1; display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); gap: 4px; padding: 8px; flex-shrink: 0; min-height: 0; }
        .card { height: 100%; width: 100%; border-radius: 5px; padding: 2px; display: flex; cursor: pointer; position: relative; perspective: 1000px; }
        .card-selected { transform: scale(0.95); box-shadow: 0 0 10px #7ed321; }
        .confirm-btn { position: absolute; top: -5px; right: -5px; width: 22px; height: 22px; background: #7ed321; border: 2px solid white; border-radius: 50%; display: none; justify-content: center; align-items: center; z-index: 110; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .confirm-btn svg { width: 14px; height: 14px; fill: white; }

        /* --- Card Visuals & Reveal --- */
        .card-main-body { flex: 1; border-radius: 3px; display: flex; flex-direction: column; border: 1px solid; overflow: hidden; pointer-events: none; position: relative; }
        .bottom-box { margin-top: auto; height: 45%; display: flex; justify-content: center; align-items: center; font-size: 1rem; font-weight: normal; border-top: 1px solid; color: white; }
        .card-blue { background: #3ec1f3; } .card-blue .card-main-body { background: #19a8ff; border-color: #0b4d9b; } .card-blue .bottom-box { background: #0b4d9b; border-color: #3ec1f3; }
        .card-red { background: #ff8e7a; } .card-red .card-main-body { background: #ff6a4c; border-color: #8c2b1e; } .card-red .bottom-box { background: #8c2b1e; border-color: #ff8e7a; }
        .card-black { background: #7a7a7a; } .card-black .card-main-body { background: #444; border-color: #222; } .card-black .bottom-box { background: #1a1a1a; border-color: #7a7a7a; }
        .card-brown { background: #fbe0c3; } .card-brown .card-main-body { background: #f7cda3; border-color: #9a7452; } .card-brown .bottom-box { background: #9a7452; border-color: #fbe0c3; }
        .card-hidden { background: #fbe0c3 !important; } .card-hidden .card-main-body { background: #f7cda3 !important; border-color: #9a7452 !important; } .card-hidden .bottom-box { background: #9a7452 !important; border-color: #fbe0c3 !important; }
        .card-reveal-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; border-radius: 3px; opacity: 0; pointer-events: none; transform: translateY(-100%); transform-origin: top center; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-revealed:not(.already-revealed) .card-reveal-img { opacity: 1; pointer-events: auto; animation: pushFromTop 1s ease-out forwards; }
        .already-revealed .card-reveal-img { opacity: 1; pointer-events: auto; transform: translateY(0); }
        @keyframes pushFromTop { 0% { transform: translateY(-100%); opacity: 1; } 100% { transform: translateY(0); opacity: 1; } }
        .card-peeking .card-reveal-img { transform: rotateX(-55deg) translateY(-5px); z-index: 6; box-shadow: 0 15px 30px rgba(0,0,0,0.8); opacity: 1; pointer-events: auto; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .card.card-peeking { overflow: visible !important; z-index: 100 !important; }
        .card-revealed { cursor: default; }

        /* --- Control Panel --- */
        .control-area { height: 65px; background: #222; border-top: 1px solid #444; padding: 5px 15px; display: flex; align-items: center; flex-shrink: 0; }
        .clue-bar-layout { width: 100%; display: flex; align-items: center; gap: 8px; padding: 0 10px;}
        .clue-input-wrapper { flex: 1; background: white; border-radius: 20px; height: 35px; display: flex; align-items: center; padding: 0 12px; }
        .clue-input { width: 100%; border: none; outline: none; font-weight: bold; color: #333; text-align: center; font-size: 0.8rem; background: transparent; }
        .clue-select { width: 45px; height: 35px; border-radius: 50%; border: 2px solid #555; background: white; color: #19a8ff; font-weight: bold; text-align: center; appearance: none; outline: none; font-size: 0.9rem; transition: 0.3s; }
        .send-btn { width: 75px; height: 35px; background: linear-gradient(to bottom, #7ed321, #417505); border: 1.5px solid #b8e986; border-radius: 18px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 0 #2e5a03;}
        .end-turn-btn { background: linear-gradient(to bottom, #d0021b, #8b0000) !important; }
        .arrow-icon { width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid white; }
        .x-icon { color: white; font-weight: 900; font-size: 1.2rem; }

        /* --- Utilities --- */
        .disabled-area { opacity: 0.7; pointer-events: none; filter: grayscale(0.5); }
        .error-border { border-color: #ff0000 !important; box-shadow: 0 0 10px #ff0000; }
    </style>
</head>

<body>
<!-- HTML Section -->

<!-- loadingScreen -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <p style="margin-top: 15px; font-size: 0.9rem; color: #888;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
</div>

<!-- App Wrapper -->
<div class="mobile-wrapper">
            <!-- Players List Modal -->
        <div id="playersListModal">
            <div class="players-modal-title">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
            <div class="horizontal-players-scroll" id="playersListContainer"> </div>
        </div>
    <!-- Custom Alert Modal -->
    <div id="customAlert" class="custom-alert">
        <p id="alertMsg"></p>
        <div class="alert-btns">
            <button class="alert-btn btn-ok" id="alertOk">Ù…ÙˆØ§ÙÙ‚</button>
            <button class="alert-btn btn-cancel" id="alertCancel">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- App Bar -->
    <div class="top-bar">
        <div class="top-left">
            <div class="icon-circle" onclick="openPlayersModal()">
                <span id="playerCount" style="font-size:0.8rem;font-weight:bold;margin-left:2px;">0</span> ğŸ‘¤
            </div> 
            <div class="btn-pill" id="roomDisplay" onclick="copyRoomLink()">ğŸ”— Ø§Ù„ØºØ±ÙØ©</div>
        </div>

        <div class="top-timer" id="lobbyDisplayTimer"></div>

        <div class="top-right">
            <div class="icon-circle" onclick="openProfileSettings()">âš™ï¸</div>
        </div>
    </div>

    <!-- Teams Dashboard -->
<div class="dashboard" id="gameDashboard"> 
    <div class="team-side blue-team">
        <div class="player-card" id="blue-operative">
            <span class="role-title">BLUE SIDE</span>
            <div class="avatar-box"></div>
            <div class="player-name">â€”</div>
        </div>
        <div class="score" id="blue-score">15</div>
    </div>

    <div class="game-log-container">
        <div style="text-align:center;font-size:0.4rem;color:#aaa;margin-bottom:2px;">CO-OP LOG</div>
        <div id="log-content"></div>
    </div>

        <div class="team-side red-team">
        <div class="player-card" id="red-operative">
            <span class="role-title">RED SIDE</span>
            <div class="avatar-box"></div>
            <div class="player-name">â€”</div>
        </div>
        <div class="score" id="red-score">15</div>
    </div>

</div>

    <!-- Game Grid -->
    <div class="grid-container" id="grid"></div>

    <!-- Control Panel -->
    <div class="control-area">
        <div id="clue-ui" class="clue-bar-layout">
            <div class="clue-input-wrapper">
                <input type="text" id="clueInput" class="clue-input" placeholder="Ø§ÙƒØªØ¨ ØªÙ„Ù…ÙŠØ­">
            </div>
            <select id="clueNum" class="clue-select">
                <option value="-">-</option>
                <option value="0">0</option><option value="1">1</option><option value="2">2</option>
                <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                <option value="6">6</option><option value="7">7</option><option value="âˆ">âˆ</option>
            </select>
        </div>

        <div id="action-btn" class="send-btn" onclick="handleAction()">
            <div id="btn-icon" class="arrow-icon"></div>
        </div>
    </div>

</div>


<script type="module">
// <!-- JS Section -->

/* ---------- 1. Setup & Config ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, update, runTransaction, push } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyC95r_D7FVO-cynZ-gK6zbldvvrY4HD2YQ",
    authDomain: "codenames-5fd71.firebaseapp.com",
    databaseURL: "https://codenames-5fd71-default-rtdb.firebaseio.com",
    projectId: "codenames-5fd71",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const params = new URLSearchParams(window.location.search);
const roomId = params.get("r");
const playerId = params.get("p");

const roomRef = ref(db, `rooms/${roomId}`);
const gameRef = ref(db, `rooms/${roomId}/game`);
const playersRef = ref(db, `rooms/${roomId}/players`);
const statusRef = ref(db, `rooms/${roomId}/status`);
const logRef = ref(db, `rooms/${roomId}/game/log`);


/* ---------- 2. State & Assets ---------- */
const avatarImages = [
    "img/avatar/snowman.webp",
    "img/avatar/confused_woman.webp",
    "img/avatar/cool_girl.webp",
    "img/avatar/delivery_boy.webp",
    "img/avatar/laughing.webp",
    "img/avatar/old_man.webp",
    "img/avatar/photographer.webp",
    "img/avatar/pizza_guy.webp",
    "img/avatar/reader.webp",
    "img/avatar/surprised_man.webp",
];

const cardVisuals = {
    'card-blue': ['img/card/Blue1.webp', 'img/card/Blue2.webp'],
    'card-red': ['img/card/Red1.webp', 'img/card/Red2.webp'],
    'card-black': ['img/card/Black.webp'],
    'card-brown': ['img/card/Normal1.webp', 'img/card/Normal2.webp']
};

let myRole = null;      
let myTeam = null;      
let isSpy = false;
let isOperative = false;
let isSpectator = false;

let playersCache = {};
let gameState = null;   

let selectedCards = new Set();   
let guessesThisTurn = 0;

let turnStartTime = null; 
let timerDuration = 0;   
let timerInterval = null;
let serverTimeOffset = 0; 
let isPageLoaded = false; 
let peekingCards = new Set(); 

const allImagesToPreload = [
    ...avatarImages,
    ...cardVisuals['card-blue'],
    ...cardVisuals['card-red'],
    ...cardVisuals['card-black'],
    ...cardVisuals['card-brown']
];


/* ---------- 3. Profile Management ---------- */
const offsetRef = ref(db, ".info/serverTimeOffset");
onValue(offsetRef, (snap) => {
    serverTimeOffset = snap.val() || 0;
});

function startGameManager() {
    const loader = document.getElementById('loadingScreen');
    const finishLoading = () => {
        loader.style.opacity = '0';
        setTimeout(() => {
            loader.style.display = 'none';
            isPageLoaded = true; 
            if (gameState) applyGameStateToUI(); 
        }, 300);
    };

    if (areImagesCached()) {
        finishLoading();
    } else {
        preloadImages().then(finishLoading);
    }
}


/* ---------- 4. Utility Helpers ---------- */
function areImagesCached() {
    for (let src of allImagesToPreload) {
        let img = new Image();
        img.src = src;
        if (!img.complete) return false;
    }
    return true;
}

function preloadImages() {
    const promises = allImagesToPreload.map(src => {
        return new Promise((resolve) => {
            const img = new Image();
            img.src = src;
            img.onload = resolve;
            img.onerror = resolve; 
        });
    });
    return Promise.all(promises);
}

function showCustomAlert(msg, showCancel = false, onOk = null, okText = "Ù…ÙˆØ§ÙÙ‚", cancelText = "Ø¥Ù„ØºØ§Ø¡", onCancel = null) {
    const modal = document.getElementById('customAlert');
    const okBtn = document.getElementById('alertOk');
    const cancelBtn = document.getElementById('alertCancel');
    
    document.getElementById('alertMsg').innerHTML = msg;
    
    modal.style.display = 'block';
    setTimeout(() => modal.classList.add('show-win'), 10); 

    okBtn.innerText = okText;
    okBtn.onclick = () => { 
        modal.classList.remove('show-win');
        setTimeout(() => { modal.style.display = 'none'; if(onOk) onOk(); }, 400);
    };
    
    cancelBtn.style.display = showCancel ? 'block' : 'none';
    cancelBtn.innerText = cancelText;
    cancelBtn.onclick = () => { 
        modal.classList.remove('show-win');
        setTimeout(() => { modal.style.display = 'none'; if(onCancel) onCancel(); }, 400);
    };
}

function makeDraggable(el) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    const handle = el.querySelector(".alert-drag-handle");
    let isDragging = false;

    handle.onmousedown = dragStart;
    handle.addEventListener('touchstart', dragStart, { passive: false });

    function dragStart(e) {
        isDragging = true;
        if (e.type === "mousedown") e.preventDefault();
        
        pos3 = e.clientX || e.touches[0].clientX;
        pos4 = e.clientY || e.touches[0].clientY;

        document.onmouseup = dragEnd;
        document.addEventListener('touchend', dragEnd);
        
        document.onmousemove = dragMove;
        document.addEventListener('touchmove', dragMove, { passive: false });
    }

    function dragMove(e) {
        if (!isDragging) return;
        if (e.type === "touchmove") e.preventDefault();

        requestAnimationFrame(() => {
            let x = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            let y = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            
            pos1 = pos3 - x;
            pos2 = pos4 - y;
            pos3 = x;
            pos4 = y;

            el.style.transform = "none"; 
            el.style.margin = "0";
            el.style.top = (el.offsetTop - pos2) + "px";
            el.style.left = (el.offsetLeft - pos1) + "px";
        });
    }

    function dragEnd() {
        isDragging = false;
        document.onmouseup = null;
        document.onmousemove = null;
        document.removeEventListener('touchend', dragEnd);
        document.removeEventListener('touchmove', dragMove);
    }
}

window.copyRoomLink = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('r');

    if (roomCode) {
        const lobbyLink = `${window.location.origin}/lobby.html?r=${roomCode}`;
        
        navigator.clipboard.writeText(lobbyLink);
        showToast("âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©!");
    } else {
        showToast("âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©");
    }
};

function showToast(message) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: rgba(20, 20, 20, 0.95);
        color: #ddd;
        padding: 10px 18px;
        border-radius: 14px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid rgba(52, 152, 219, 0.6);
        box-shadow: 0 8px 20px rgba(0,0,0,.6);
        opacity: 0;
        transition: all .25s ease;
        z-index: 9999;
        pointer-events: none;
        backdrop-filter: blur(6px);
    `;
    document.body.appendChild(toast);
    requestAnimationFrame(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateX(-50%) translateY(0)";
    });
    setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateX(-50%) translateY(10px)";
        setTimeout(() => toast.remove(), 250);
    }, 1800);
}

function hideLoading() {
    const loader = document.getElementById('loadingScreen');
    loader.style.opacity = '0';
    loader.style.transition = 'opacity 0.4s ease';
    setTimeout(() => loader.style.display = 'none', 400);
}


/* ---------- 5. Lobby & Team Logic ---------- */
document.getElementById('roomDisplay').innerText = "ğŸ”— " + roomId;

onValue(playersRef, (snap) => {
    playersCache = snap.val() || {};
    const me = playersCache[playerId];
    if (!me) return;

    // ÙÙŠ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ: Ø§Ù„ÙØ±ÙŠÙ‚ Ù‡Ùˆ blue-operative Ø£Ùˆ red-operative ÙÙ‚Ø·
    myRole = me.team; 
    myTeam = myRole?.startsWith("blue") ? "blue" : "red";
    
    // ÙƒÙ„Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù‡Ù… Ù‚Ø§Ø¯Ø© ÙˆÙ…Ù†ÙØ°ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
    isSpy = true; 
    isOperative = true;
    isSpectator = (myRole === "spectators-list");

    renderPlayersPanel();
});

function renderPlayersPanel() {
    // ÙÙŠ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø¹Ù…ÙŠÙ„ÙŠÙ†
    const roleIds = ["blue-operative", "red-operative"];
    
    roleIds.forEach(r => {
        const card = document.getElementById(r);
        if(!card) return; // Ø­Ù…Ø§ÙŠØ©
        
        const box = card.querySelector(".avatar-box");
        const nameBox = card.querySelector(".player-name");
        
        const player = Object.values(playersCache).find(p => p.team === r);
        
        if (player) {
            box.innerHTML = `<img src="${player.avatar}" class="avatar-img">`;
            nameBox.textContent = player.name;
        } else {
            box.innerHTML = "";
            nameBox.textContent = "â€”";
        }
    });

    const countEl = document.getElementById("playerCount");
    if (countEl) countEl.textContent = Object.keys(playersCache).length;
}


/* ---------- 6. Admin & Game Settings ---------- */
function startGlobalTimer(serverStartTime) {
    if (timerInterval) clearInterval(timerInterval);
    const timerDisplay = document.getElementById('lobbyDisplayTimer');
    if (!timerDisplay) return;
    timerDisplay.style.display = 'flex';

    timerInterval = setInterval(() => {
        const nowCorrected = Date.now() + serverTimeOffset;
        const elapsed = Math.floor((nowCorrected - serverStartTime) / 1000);
        let remaining = Math.max(timerDuration - elapsed, 0);

        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        timerDisplay.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        if (remaining <= 0) {
            clearInterval(timerInterval);
            timerDisplay.classList.remove('timer-pulse');
            const isMyTurn = myTeam === gameState.turn.team;
            const isMyPhase = (isSpy && gameState.turn.phase === 'spymaster') || 
                              (isOperative && gameState.turn.phase === 'operative');
            if (isMyTurn && isMyPhase) endTurn(); 
        } 

        if (remaining <= 10 && remaining > 0) {
            timerDisplay.style.color = "#ff4d4d";
            timerDisplay.classList.add('timer-pulse');
        } else {
            timerDisplay.style.color = "white";
            timerDisplay.classList.remove('timer-pulse');
        }
    }, 1000);
}


/* ---------- 7. Game Engine & Start ---------- */
onValue(gameRef, (snap) => {
    const data = snap.val();
    if (!data) return;
    gameState = data;
    applyGameStateToUI();
});

onValue(logRef, (snap) => {
    const logData = snap.val();
    if (logData && gameState) {
        gameState.log = logData; 
        renderLog(); 
    }
});

// onValue(statusRef, (snap) => {
//     const status = snap.val();
//     if (status === "waiting" && isPageLoaded) {
//         window.location.href = `lobby.html?r=${roomId}&p=${playerId}`;
//     }
//     if (status === "ended") {
//         window.location.href = "index.html";
//     }
// });

onValue(ref(db, `rooms/${roomId}/game/winner`), (snap) => {
    const winner = snap.val();
    if (!winner || !myTeam) return;

    const isWinner = myTeam === winner;
    const winnerName = winner === "blue" ? "Ø§Ù„Ø£Ø²Ø±Ù‚ ğŸ”µ" : "Ø§Ù„Ø£Ø­Ù…Ø± ğŸ”´";
    const modal = document.getElementById('customAlert');
    
    modal.className = `custom-alert ${isWinner ? 'alert-win' : 'alert-lose'}`;
    modal.innerHTML = `
        <div class="alert-drag-handle"><div class="drag-indicator"></div></div>
        <div class="alert-body">
            <span style="font-size:1.5rem; display:block; margin-bottom:10px;">
                ${isWinner ? 'ğŸ† Ù…Ø¨Ø±ÙˆÙˆÙˆÙƒ! ğŸ†' : 'ğŸ’€ Ø­Ø¸Ø§Ù‹ Ø£ÙˆÙØ±!'}
            </span>
            <p style="font-size:1rem; margin-bottom:15px;">ÙØ§Ø² Ø§Ù„ÙØ±ÙŠÙ‚ ${winnerName}</p>
        </div>
        <div class="alert-btns">
            <button class="alert-btn btn-ok" id="nextGenBtn">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ğŸ”„</button>
            <button class="alert-btn btn-cancel" id="leaveGameBtn">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ </button>
        </div>
    `;

    modal.style.display = 'block';
    setTimeout(() => { modal.classList.add('show-win'); makeDraggable(modal); }, 10);

    document.getElementById('nextGenBtn').onclick = async () => {
        const me = playersCache[playerId];
        
        const playerList = Object.values(playersCache).sort((a, b) => a.joinedAt - b.joinedAt);
        const isAdmin = (playerId === playerList[0].id);

        if (isAdmin) {
            await update(roomRef, { status: "lobby" });
            await set(gameRef, null); 
        }

        await update(ref(db, `rooms/${roomId}/players/${playerId}`), {
            team: "spectators-list",
            name: me.name,
            avatar: me.avatar
        });

        window.location.href = `lobby.html?r=${roomId}&p=${playerId}`;
    };

    document.getElementById('leaveGameBtn').onclick = async () => {
        await remove(ref(db, `rooms/${roomId}/players/${playerId}`));
        window.location.href = 'index.html';
    };
});

function applyGameStateToUI() {
    if (!gameState) return;
    if (gameState.turn.phase === "spymaster") {
        selectedCards.clear();
        guessesThisTurn = 0;
        document.getElementById('clueInput').value = '';
    }
    renderGrid();
    renderLog();
    updateUI();
    get(ref(db, `rooms/${roomId}/settings/timer`)).then((snap) => {
        const seconds = snap.val();
        const timerDisplay = document.getElementById('lobbyDisplayTimer');
        if (seconds && seconds > 0) {
            timerDuration = seconds;
            const isMyTurn = myTeam === gameState.turn.team;
            const isMyPhase = (isSpy && gameState.turn.phase === 'spymaster') || 
                              (isOperative && gameState.turn.phase === 'operative');
            if (isMyTurn && isMyPhase && !gameState.turn.ready) {
                update(gameRef, { "turn/ready": true, "turn/updatedAt": Date.now() + serverTimeOffset });
            }
            if (gameState.turn.ready) {
                startGlobalTimer(gameState.turn.updatedAt);
            } else {
                if(timerDisplay) timerDisplay.innerText = "00:00";
            }
        } else {
            if(timerDisplay) timerDisplay.style.display = 'none';
        }
    });
}

function renderGrid() {
    if (!gameState) return;
    const grid = document.getElementById('grid'); 
    // Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙƒØ´ÙˆÙØ© Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    const existingRevealed = Array.from(document.querySelectorAll('.card-revealed')).map(el => el.id);
    
    grid.innerHTML = '';

    Object.entries(gameState.board).forEach(([i, card]) => {
        i = Number(i);
        const div = document.createElement('div');
        const cardId = `card-${i}`;

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚ ---
        const myMapColor = (myTeam === 'red') ? card.sideA : card.sideB;
        
        const visualClass =
            myMapColor === "blue" ? "card-blue" :
            myMapColor === "red" ? "card-red" :
            myMapColor === "killer" ? "card-black" : "card-brown";
        // ------------------------------------------------

        const isSelected = selectedCards.has(i);
        const isPeeking = peekingCards.has(i); // Ù…ÙŠØ²Ø© Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ

        div.id = cardId;
        div.className = `card ${visualClass} ${card.revealed ? 'card-revealed' : ''} ${isSelected ? 'card-selected' : ''} ${isPeeking ? 'card-peeking' : ''}`;
        
        if (card.revealed && existingRevealed.includes(cardId)) div.classList.add('already-revealed');

        // Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØªÙ†Ø§ÙØ³ÙŠ (Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© togglePeek Ù„Ù„ØµÙˆØ±Ø©)
        div.innerHTML = `
            <div class="confirm-btn" id="confirm-${i}" style="display: ${isSelected ? 'flex' : 'none'}" onclick="event.stopPropagation(); confirmSelection(${i});">
                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            </div>
            ${card.revealed ? `<img src="${card.visual}" class="card-reveal-img" onclick="togglePeek(${i}, event)">` : ''}
            <div class="card-main-body">
                <div class="bottom-box">${card.word}</div>
            </div>`;

        div.onclick = () => handleCardSelection(i);
        grid.appendChild(div);
    });
}

window.togglePeek = function(i, event) {
    event.stopPropagation();
    // ÙŠØ³Ù…Ø­ Ø¨Ø±ÙØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙƒØ´ÙˆÙØ©
    if (!gameState.board[i].revealed) return;
    
    if (peekingCards.has(i)) peekingCards.delete(i);
    else peekingCards.add(i);
    
    renderGrid();
};

function updateUI() {
    if (!gameState) return;
    
    const dashboard = document.getElementById('gameDashboard');
    const redCard = document.getElementById('red-operative');
    const blueCard = document.getElementById('blue-operative');
    
    const controlArea = document.querySelector('.control-area');
    const clueUI = document.getElementById('clue-ui');
    const actionBtn = document.getElementById('action-btn');
    const btnIcon = document.getElementById('btn-icon');
    const input = document.getElementById('clueInput');
    const select = document.getElementById('clueNum');

    // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    redCard.classList.remove('active-red');
    blueCard.classList.remove('active-blue');
    if (controlArea.querySelector('.turn-info')) controlArea.querySelector('.turn-info').remove();

    // 2. Ù…Ù†Ø·Ù‚ Ù…Ù† "Ø§Ù„Ù†Ø´Ø·" ÙÙŠ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ
    const isCluePhase = (gameState.turn.phase === 'clue');
    // ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­: Ø§Ù„Ù†Ø´Ø· Ù‡Ùˆ ØµØ§Ø­Ø¨ Ø§Ù„Ø¯ÙˆØ± (side)
    // ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ†: Ø§Ù„Ù†Ø´Ø· Ù‡Ùˆ Ø´Ø±ÙŠÙƒ ØµØ§Ø­Ø¨ Ø§Ù„Ø¯ÙˆØ± (Ø¹ÙƒØ³ side)
    const activeTeam = isCluePhase ? gameState.turn.side : (gameState.turn.side === 'red' ? 'blue' : 'red');
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆÙ‡Ø¬
    if (activeTeam === 'red') redCard.classList.add('active-red');
    else blueCard.classList.add('active-blue');

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙƒÙˆØ± (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù€ 15)
    const revealedCount = Object.values(gameState.board).filter(c => c.revealed).length;
    const remainingToWin = 15 - revealedCount;
    document.getElementById('blue-score').innerText = Math.max(0, remainingToWin);
    document.getElementById('red-score').innerText = Math.max(0, remainingToWin);

    // 3. Ø¥Ø¯Ø§Ø±Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Control Panel)
    const isMyTurn = (myTeam === activeTeam);

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„ Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
    clueUI.style.display = 'none';
    actionBtn.style.display = 'none';
    actionBtn.classList.remove('end-turn-btn', 'disabled-area');
    clueUI.classList.remove('disabled-area');

    if (isCluePhase) {
        // --- Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­ ---
        if (isMyTurn) {
            clueUI.style.display = 'flex';
            actionBtn.style.display = 'flex';
            input.disabled = false;
            select.disabled = false;
            btnIcon.className = 'arrow-icon';
            btnIcon.innerHTML = '';
        } else {
            showTurnInfo(controlArea, { team: activeTeam, phase: 'spymaster' }); // Ù†Ø¹Ø±Ø¶ Ø£Ù†Ù‡ Ø¯ÙˆØ± Ø§Ù„Ù‚Ø§Ø¦Ø¯
        }
    } else {
        // --- Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ† ---
        if (isMyTurn) {
            clueUI.style.display = 'flex'; // Ù†Ø¹Ø±Ø¶ Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø³Ø§Ø¨Ù‚
            clueUI.classList.add('disabled-area'); // Ù„ÙƒÙ† Ù†Ø¬Ø¹Ù„Ù‡ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
            input.value = gameState.clue.word; // Ù†Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            select.value = gameState.clue.count;
            
            actionBtn.style.display = 'flex';
            actionBtn.classList.add('end-turn-btn'); // Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±
            btnIcon.className = '';
            btnIcon.innerHTML = 'âœ•';
        } else {
            showTurnInfo(controlArea, { team: activeTeam, phase: 'operative' });
        }
    }
}

function showTurnInfo(container, turn) {
    const div = document.createElement('div');
    div.className = 'turn-info';
    div.style.textAlign = 'center';
    div.style.width = '100%';
    div.style.opacity = '0.8';
    div.innerHTML = `<div style="font-size: 0.8rem; color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù† Ø¹Ù†Ø¯ <b>${turn.team === 'blue' ? 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ğŸ”µ' : 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±ğŸ”´'}</b><br>(${turn.phase === 'spymaster' ? 'Ø§Ù„Ù‚Ø§Ø¦Ø¯ ğŸ‘¨ğŸ»â€âœˆï¸' : 'Ø§Ù„Ø¹Ù…ÙŠÙ„ ğŸ•µï¸'})</div>`;
    container.appendChild(div);
}

function renderLog() {
    const logContainer = document.getElementById('log-content');
    if (!logContainer || !gameState || !gameState.log) return;
    const logEntries = Object.values(gameState.log).sort((a, b) => b.at - a.at);
    logContainer.innerHTML = ''; 
    logEntries.forEach(entry => {
        let html = '';
        const isBlue = entry.team === 'blue';
        const rowClass = isBlue ? 'row-blue' : 'row-red';
        if (entry.type === "clue") {
            const clueClass = isBlue ? 'log-clue-blue' : 'log-clue-red';
            html = `<div class="log-row ${rowClass}"><div class="log-clue-item ${clueClass}"><img src="${entry.avatar}" class="log-avatar" style="border-color:#fff"><div class="log-text-clue">${entry.word}</div><div class="log-num-circle">${entry.count}</div></div></div>`;
        } else if (entry.type === "guess") {
            const colorClass = entry.cardColor === 'blue' ? 'bg-blue' : entry.cardColor === 'red' ? 'bg-red' : entry.cardColor === 'black' ? 'bg-black' : 'bg-brown';
            html = `<div class="log-row ${rowClass}"><div class="log-guess-item"><img src="${entry.avatar}" class="log-avatar" style="border-color:${isBlue ? '#3498db':'#e74c3c'}"><div class="log-guess-text ${colorClass}">${entry.word}</div></div></div>`;
        }
        logContainer.insertAdjacentHTML('beforeend', html);
    });
}

window.handleAction = function() {
    if (!gameState) return;
    
    const isCluePhase = (gameState.turn.phase === 'clue');
    const isMyTurn = (myTeam === gameState.turn.side); // ÙÙŠ Ø§Ù„ØªÙ„Ù…ÙŠØ­ØŒ Ø£Ù†Ø§ Ù†ÙØ³ Ø§Ù„Ù€ side

    if (isCluePhase) {
        if (!isMyTurn) return;
        sendClue();
    } else {
        // Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ†: Ø£Ù†Ø§ Ù„Ø³Øª Ø§Ù„Ù€ side
        if (myTeam === gameState.turn.side) return; 

        // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ
        if (guessesThisTurn === 0) {
            showCustomAlert("ÙŠØ¬Ø¨ Ø£Ù† ØªØ®ØªØ§Ø± Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±!. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ", true, endTurn);
        } else if (gameState.clue.count !== 'âˆ' && guessesThisTurn < parseInt(gameState.clue.count)) {
            showCustomAlert(`Ù„Ù… ØªÙ†Ù‡Ù Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ Ø¨Ø¹Ø¯ (${guessesThisTurn}/${gameState.clue.count}). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`, true, endTurn);
        } else {
            endTurn();
        }
    }
};

async function sendClue() {
    const input = document.getElementById('clueInput');
    const clueValue = input.value.trim();
    const select = document.getElementById('clueNum');
    const inputWrapper = document.querySelector('.clue-input-wrapper');

    if (!clueValue) {
        inputWrapper.classList.add('error-border');
        setTimeout(() => inputWrapper.classList.remove('error-border'), 1000);
        return;
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ: Ù…Ù†Ø¹ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
    const onTableWords = Object.values(gameState.board)
        .filter(c => !c.revealed)
        .map(c => c.word.trim().toLowerCase());
        
    const clueWords = clueValue.toLowerCase().split(/\s+/);
    if (clueWords.some(w => onTableWords.includes(w))) {
        showCustomAlert("Ø®Ø·Ø£! Ø§Ù„ØªÙ„Ù…ÙŠØ­ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª.");
        return;
    }

    if (select.value === '-') {
        select.classList.add('error-border');
        setTimeout(() => select.classList.remove('error-border'), 1000);
        return;
    }

    const count = select.value === "âˆ" ? 25 : parseInt(select.value);
    const me = playersCache[playerId];

    await update(gameRef, { 
        clue: { word: clueValue, count: select.value }, // Ù†Ø®Ø²Ù†Ù‡Ø§ ÙƒÙ†Øµ Ù„Ù„Ø¹Ø±Ø¶ ÙˆÙƒÙ€ Ø±Ù‚Ù… Ù„Ù„Ù…Ù†Ø·Ù‚
        turn: { side: gameState.turn.side, phase: "guess" } 
    });

    await push(logRef, { 
        type: "clue", 
        team: myTeam, 
        word: clueValue, 
        count: select.value, 
        avatar: me.avatar, 
        at: Date.now() 
    });
}

window.handleCardSelection = function(i) {
    if (!gameState) return;

    // Ø§Ù„Ø´Ø±Ø·: Ø§Ù„Ø·ÙˆØ± ØªØ®Ù…ÙŠÙ† + Ø£Ù†Ø§ Ù„Ø³Øª ØµØ§Ø­Ø¨ Ø§Ù„Ø¯ÙˆØ± (Ø£ÙŠ Ø£Ù†Ø§ Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„Ù…Ø®Ù…Ù†) + Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØºÙŠØ± Ù…ÙƒØ´ÙˆÙØ©
    const isMyTurnToGuess = (gameState.turn.phase === 'guess' && myTeam !== gameState.turn.side);

    if (!isMyTurnToGuess || gameState.board[i].revealed) return;

    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ: Ø§Ø®ØªÙŠØ§Ø±/Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø±
    if (selectedCards.has(i)) {
        selectedCards.delete(i);
    } else {
        selectedCards.clear(); // Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ ÙŠÙØ¶Ù„ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© Ù„Ù„ÙˆØ¶ÙˆØ­
        selectedCards.add(i);
    }
    renderGrid();
};

window.confirmSelection = async function(i) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù† (Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù„ØªÙ†Ø§ÙØ³ÙŠ)
    const isMyTurnToGuess = (gameState.turn.phase === 'guess' && myTeam !== gameState.turn.side);
    if (!gameState || !isMyTurnToGuess || gameState.board[i].revealed || !selectedCards.has(i)) return;
    
    const card = gameState.board[i];
    const me = playersCache[playerId];
    
    // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ Ù„Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ ---
    // Ø§Ù„Ø­ÙƒÙ… Ù‡Ùˆ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø´Ø±ÙŠÙƒ (Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·Ù‰ Ø§Ù„ØªÙ„Ù…ÙŠØ­)
    const judgesColor = (gameState.turn.side === 'red') ? card.sideA : card.sideB;
    // ----------------------------

    const updates = {};
    updates[`board/${i}/revealed`] = true;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø´ÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙƒØ´Ù Ù„ÙŠØ±Ø§Ù‡Ø§ Ø§Ù„Ø¬Ù…ÙŠØ¹
    let visualImg = cardVisuals['card-brown'][0];
    if(judgesColor === 'red') visualImg = cardVisuals['card-red'][0];
    if(judgesColor === 'blue') visualImg = cardVisuals['card-blue'][0];
    if(judgesColor === 'killer') visualImg = cardVisuals['card-black'][0];
    updates[`board/${i}/visual`] = visualImg;

    let nextSide = gameState.turn.side;
    let nextPhase = 'guess';

    // Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙˆØ²/Ø§Ù„Ø®Ø³Ø§Ø±Ø©/Ù†Ù‚Ù„ Ø§Ù„Ø¯ÙˆØ±
    if (judgesColor === 'killer') {
        // Ù„Ù…Ø³ Ø§Ù„Ù‚Ø§ØªÙ„ = Ø®Ø³Ø§Ø±Ø© ÙÙˆØ±ÙŠØ©
        const winner = (myTeam === 'red') ? 'blue' : 'red'; // Ø§Ù„Ø®ØµÙ… ÙŠÙÙˆØ² (Ù…Ø¬Ø§Ø²ÙŠØ§Ù‹ØŒ Ø£Ùˆ Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ Ø®Ø³Ø§Ø±Ø© Ù„Ù„ÙƒÙ„)
        updates.winner = winner; 
        showCustomAlert("ğŸ’€ Ù„Ù‚Ø¯ Ù„Ù…Ø³Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡!");
    } else if (judgesColor === 'neutral') {
        // Ù…Ø­Ø§ÙŠØ¯ = Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ± ÙˆÙ†Ù‚Ù„Ù‡ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù„ÙŠÙ„Ù…Ø­
        nextSide = (gameState.turn.side === 'red') ? 'blue' : 'red';
        nextPhase = 'clue';
        updates['turn'] = { side: nextSide, phase: nextPhase };
        updates['clue'] = { word: null, count: null };
        guessesThisTurn = 0;
    } else {
        // ØµØ­ÙŠØ­ = Ø§Ø³ØªÙ…Ø±Ø§Ø±
        guessesThisTurn++;
    }

    // Ø´Ø±Ø· Ø§Ù„ÙÙˆØ²: ÙƒØ´Ù 15 Ø¨Ø·Ø§Ù‚Ø©
    const totalRevealed = Object.values(gameState.board).filter(c => c.revealed).length + 1;
    if (totalRevealed >= 15 && !updates.winner) {
        updates.winner = "win"; // Ø­Ø§Ù„Ø© ÙÙˆØ² Ø®Ø§ØµØ©
    }

    await update(gameRef, updates);

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„ÙˆØ¬ (Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ)
    await push(ref(db, `rooms/${roomId}/game/log`), { 
        type: "guess", 
        team: myTeam, 
        word: card.word, 
        cardColor: judgesColor, 
        avatar: me.avatar, 
        at: Date.now() 
    });

    selectedCards.delete(i);
    renderGrid();
};

// ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø´ÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø¹Ø¯ ÙƒØ´ÙÙ‡Ø§
function getVisualForColor(color) {
    if (color === 'red') return cardVisuals['card-red'][0];
    if (color === 'blue') return cardVisuals['card-blue'][0];
    if (color === 'killer') return cardVisuals['card-black'][0];
    return cardVisuals['card-brown'][0];
}

async function endTurn() {
    if (!gameState) return;
    // Ù†Ù‚Ù„ Ø§Ù„Ø¯ÙˆØ± Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù„ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªÙ„Ù…ÙŠØ­
    const nextSide = (gameState.turn.side === 'red') ? 'blue' : 'red';
    
    await update(gameRef, { 
        turn: { side: nextSide, phase: "clue" }, 
        clue: { word: null, count: null } 
    });
    
    guessesThisTurn = 0;
    selectedCards.clear();
    const input = document.getElementById('clueInput');
    if(input) input.value = '';
}

window.openPlayersModal = async () => {
    const modal = document.getElementById('playersListModal');
    if (modal.style.display === 'flex') { modal.style.display = 'none'; return; }
    const playersSnap = await get(playersRef);
    if (!playersSnap.exists()) return;
    const playerList = Object.values(playersSnap.val());
    const adminId = [...playerList].sort((a, b) => a.joinedAt - b.joinedAt)[0]?.id;
    const teamOrder = ['blue-spymaster', 'blue-operative', 'red-spymaster', 'red-operative', 'spectators-list'];
    const sortedPlayers = playerList.sort((a, b) => teamOrder.indexOf(a.team) - teamOrder.indexOf(b.team));
    const container = document.getElementById('playersListContainer');
    container.innerHTML = '';
    sortedPlayers.forEach(p => {
        let teamClass = p.team.includes('blue') ? 'player-blue' : (p.team.includes('red') ? 'player-red' : 'player-spec');
        const isMe = (p.id === playerId), isPlayerAdmin = (p.id === adminId);
        container.insertAdjacentHTML('beforeend', `
            <div class="player-card-mini ${teamClass} ${isMe ? 'is-me-mini' : ''}">
                <div class="player-avatar-mini-wrap ${isPlayerAdmin ? 'is-admin-mini' : ''}">
                    <div class="avatar-frame"><img src="${p.avatar}" class="mini-img"></div>
                </div>
                <div class="mini-name-tag">${p.name} ${isMe ? '(Ø£Ù†Øª)' : ''}</div>
            </div>`);
    });
    modal.style.display = 'flex';
    modal.onclick = (e) => e.stopPropagation();
};

document.addEventListener('click', (e) => {
    const modal = document.getElementById('playersListModal');
    const playerCountBtn = document.getElementById('playerCount')?.parentElement;
    if (modal && modal.style.display === 'flex' && !modal.contains(e.target) && !playerCountBtn?.contains(e.target)) {
        modal.style.display = 'none';
    }
});



/* ---------- Final: Bootstrap ---------- */
startGameManager();

</script>
</body>
</html>
